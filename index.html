<!DOCTYPE html>
<html lang="ms">
<head>
  <!-- CSP: ketat + serasi GIS/Apps Script/JSDelivr -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'none';
                 script-src 'self' 'nonce-n123' https://accounts.google.com https://accounts.gstatic.com https://cdn.jsdelivr.net;
                 style-src  'self' 'unsafe-inline' https://cdn.jsdelivr.net https://accounts.google.com;
                 img-src    'self' data:;
                 font-src   'self' https://cdn.jsdelivr.net;
                 connect-src 'self' https://script.google.com https://script.googleusercontent.com https://cdn.jsdelivr.net;
                 frame-src  https://accounts.google.com;">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard Pemasaran Klinik (Laju)</title>

  <!-- Performance hints -->
  <link rel="preconnect" href="https://accounts.google.com">
  <link rel="preconnect" href="https://accounts.gstatic.com">
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="dns-prefetch" href="https://accounts.google.com">
  <link rel="dns-prefetch" href="https://accounts.gstatic.com">
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">

  <!-- UI libs -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    :root{--primary:#0d6efd;--primary-dark:#0a58ca;--secondary:#6c757d;--success:#198754;--info:#0dcaf0;--warning:#ffc107;--danger:#dc3545;--light:#f8f9fa;--dark:#212529;--border:#dee2e6;--text:#212529;--muted:#6c757d;--light-bg:#f8f9fa;--card-bg:#fff;--shadow:0 0.125rem 0.25rem rgba(0,0,0,0.075);--shadow-lg:0 0.5rem 1rem rgba(0,0,0,0.15)}
    body{background:linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;min-height:100vh}
    .brand{font-weight:800;color:var(--primary);letter-spacing:-0.5px} .muted{color:var(--muted)}
    .card{border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);transition:all 0.3s ease}
    .card:hover{box-shadow:var(--shadow-lg);transform:translateY(-2px)}
    .stat{display:flex;gap:14px;align-items:center;background:var(--card-bg);border:1px solid var(--border);border-radius:12px;padding:16px 18px;transition:all 0.3s ease}
    .stat:hover{transform:translateY(-2px);box-shadow:var(--shadow-lg)}
    .stat .ico{width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center;background:rgba(13, 110, 253, 0.1);color:var(--primary);transition:all 0.3s ease}
    .stat:hover .ico{background:var(--primary);color:white}
    .stat .v{font-size:1.75rem;font-weight:800;line-height:1}
    .hidden{display:none!important}.section-title{font-weight:700;letter-spacing:-0.3px}
    .toolbar .form-control,.toolbar .form-select{height:44px;border-radius:10px;border:1px solid var(--border);transition:all 0.2s ease}
    .toolbar .form-control:focus,.toolbar .form-select:focus{border-color:var(--primary);box-shadow:0 0 0 0.2rem rgba(13, 110, 253, 0.25)}
    .btn{border-radius:10px;font-weight:600;transition:all 0.2s ease}
    .btn-primary{background:var(--primary);border-color:var(--primary)}
    .btn-primary:hover{background:var(--primary-dark);border-color:var(--primary-dark);transform:translateY(-1px)}
    .btn-outline-primary:hover{transform:translateY(-1px)}
    .chart-h{height:300px}.chart-h-lg{height:340px}
    .btn-range.active{background:var(--primary);color:#fff;border-color:var(--primary)}
    .badge-code{background:rgba(13, 110, 253, 0.1);color:var(--primary);border:1px solid rgba(13, 110, 253, 0.2)}
    .cat-chip{border:1px solid var(--border);border-radius:20px;background:#fff;padding:.25rem .6rem;cursor:pointer;transition:all 0.2s ease}
    .cat-chip:hover{background:var(--light);transform:translateY(-1px)}
    .cat-chip.active{background:var(--primary);color:#fff;border-color:var(--primary)}
    .toast-area{position:fixed;right:16px;bottom:16px;z-index:1055}
    .subtle{font-size:.8rem;color:var(--muted)}
    .nav-pills .nav-link{border-radius:10px;font-weight:500;transition:all 0.2s ease}
    .nav-pills .nav-link.active{background:var(--primary)}
    .table{border-radius:10px;overflow:hidden}
    .table thead th{background:var(--light);border-bottom:2px solid var(--border);font-weight:600}
    .table tbody tr:hover{background-color:rgba(13, 110, 253, 0.05)}
    .progress{height:8px;border-radius:4px;overflow:hidden}
    .progress-bar{transition:width 0.6s ease}
    .loading-skeleton{background:linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);background-size:200% 100%;animation:loading 1.5s infinite}
    @keyframes loading{0%{background-position:200% 0}100%{background-position:-200% 0}}
    .fade-in{animation:fadeIn 0.5s ease}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .slide-up{animation:slideUp 0.3s ease}
    @keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
    .floating-action{position:fixed;bottom:20px;right:20px;z-index:1000}
    .pulse{animation:pulse 2s infinite}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(13, 110, 253, 0.7)}70%{box-shadow:0 0 0 10px rgba(13, 110, 253, 0)}100%{box-shadow:0 0 0 0 rgba(13, 110, 253, 0)}}
    .health-indicator{width:12px;height:12px;border-radius:50%;display:inline-block;margin-right:6px}
    .health-ok{background-color:var(--success);animation:pulse 2s infinite}
    .health-warning{background-color:var(--warning)}
    .health-error{background-color:var(--danger)}
    .skeleton{background:linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);background-size:200% 100%;animation:loading 1.5s infinite;border-radius:4px;height:20px;margin-bottom:10px}
    .data-empty{padding:40px;text-align:center;color:var(--muted)}
    .data-empty i{font-size:3rem;margin-bottom:15px;color:var(--muted)}
    .trend-up{color:var(--success)}
    .trend-down{color:var(--danger)}
    .trend-neutral{color:var(--muted)}
    .badge-trend{font-size:0.75rem;padding:0.25rem 0.5rem;border-radius:20px}
    .quick-filter{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:15px}
    .quick-filter button{border-radius:20px;font-size:0.875rem;padding:0.25rem 0.75rem}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:15px}
    @media (max-width: 768px){.stats-grid{grid-template-columns:repeat(2, 1fr)}}
    @media (max-width: 576px){.stats-grid{grid-template-columns:1fr}}
    .sync-status{position:fixed;top:0;left:0;width:100%;z-index:9999;background:var(--primary);color:white;padding:8px;text-align:center;transform:translateY(-100%);transition:transform 0.3s ease}
    .sync-status.show{transform:translateY(0)}
    
    /* New styles for advanced marketing features */
    .prediction-card { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-left: 4px solid var(--primary); }
    .patient-journey-step { position: relative; padding-left: 30px; }
    .patient-journey-step::before { content: ''; position: absolute; left: 0; top: 8px; width: 16px; height: 16px; border-radius: 50%; background: var(--primary); }
    .patient-journey-step::after { content: ''; position: absolute; left: 7px; top: 24px; width: 2px; height: calc(100% - 16px); background: var(--border); }
    .patient-journey-step:last-child::after { display: none; }
    .segment-card { transition: all 0.3s ease; cursor: pointer; }
    .segment-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-lg); }
    .segment-card .segment-size { position: absolute; top: 10px; right: 10px; font-size: 0.8rem; opacity: 0.7; }
    .campaign-card { border-left: 4px solid var(--success); }
    .campaign-status { position: absolute; top: 10px; right: 10px; }
    .geo-heatmap { height: 400px; border-radius: 12px; overflow: hidden; }
    .insight-card { background: linear-gradient(135deg, #e7f5ff 0%, #d0ebff 100%); border-left: 4px solid var(--info); }
    .insight-card .insight-icon { font-size: 2rem; color: var(--info); opacity: 0.7; }
    .persona-card { text-align: center; padding: 20px; }
    .persona-avatar { width: 80px; height: 80px; border-radius: 50%; margin: 0 auto 15px; background: var(--light); display: flex; align-items: center; justify-content: center; font-size: 2rem; }
    .roi-positive { color: var(--success); }
    .roi-negative { color: var(--danger); }
    .roi-neutral { color: var(--warning); }
  </style>
</head>
<body>
<!-- Sync Status Bar -->
<div id="syncStatusBar" class="sync-status">
  <i class="bi bi-arrow-repeat me-2"></i>
  <span id="syncStatusText">Menyegerakkan data...</span>
</div>

<div class="container py-4">

  <!-- Header -->
  <header class="d-flex justify-content-between align-items-start mb-4 fade-in">
    <div>
      <div class="brand h3 mb-1">Dashboard Pemasaran Klinik</div>
      <div class="muted">Analisis pantas & responsif</div>
      <div id="healthRow" class="mt-2 small"></div>
    </div>
    <div class="d-flex align-items-center gap-2">
      <span id="whoami" class="small muted"></span>
      <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" style="width:32px;height:32px" id="userAvatar">U</div>
    </div>
  </header>

  <!-- Sign-in Gate -->
  <div id="signinCard" class="card p-5 text-center mb-4 slide-up">
    <div class="mb-3"><i class="bi bi-shield-lock" style="font-size:2.5rem;color:var(--primary)"></i></div>
    <h5 class="mb-2">Akses Terhad kepada Kakitangan</h5>
    <p class="muted mb-3">Log masuk dengan akaun Google yang dibenarkan.</p>
    <div id="gsiBtn" class="d-inline-block"></div>
    <div id="signinMsg" class="small text-danger mt-3"></div>
  </div>

  <!-- App -->
  <main id="app" class="hidden">

    <!-- Penapis -->
    <section class="card p-4 mb-3 slide-up">
      <div class="section-title mb-3"><i class="bi bi-funnel me-2"></i>Penapis Data</div>
      <div class="row g-3 toolbar">
        <div class="col-12 col-md-6 col-lg-3">
          <label class="form-label fw-semibold">Tarikh Mula</label>
          <input type="date" id="startDate" class="form-control">
        </div>
        <div class="col-12 col-md-6 col-lg-3">
          <label class="form-label fw-semibold">Tarikh Tamat</label>
          <input type="date" id="endDate" class="form-control">
        </div>
        <div class="col-12 col-md-6 col-lg-3">
          <label class="form-label fw-semibold">Kod Diagnosis</label>
          <input type="text" id="filterDiag" class="form-control" placeholder="cth: URTI, INFLUENZA, MSK">
        </div>
        <div class="col-12 col-md-6 col-lg-3">
          <label class="form-label fw-semibold">Kawasan / Lokasi</label>
          <input type="text" id="filterArea" class="form-control" placeholder="cth: Manir, Kuala Terengganu">
        </div>

        <div class="col-12 d-flex flex-wrap gap-2 align-items-center mt-1">
          <button id="btnApply" class="btn btn-primary" type="button"><i class="bi bi-funnel-fill"></i> Gunakan Penapis</button>
          <button id="btnClear" class="btn btn-outline-secondary" type="button"><i class="bi bi-arrow-clockwise"></i> Set Semula</button>
          <div class="ms-auto d-flex align-items-center gap-2">
            <span class="small fw-semibold">Kumpulan Data:</span>
            <div class="btn-group" role="group">
              <input type="radio" class="btn-check" name="gran" id="gDay" checked>
              <label class="btn btn-outline-dark" for="gDay">Harian</label>
              <input type="radio" class="btn-check" name="gran" id="gMonth">
              <label class="btn btn-outline-dark" for="gMonth">Bulanan</label>
              <input type="radio" class="btn-check" name="gran" id="gYear">
              <label class="btn btn-outline-dark" for="gYear">Tahunan</label>
            </div>
          </div>
        </div>

        <div class="col-12 mt-2">
          <div class="d-flex align-items-center gap-3 w-100">
            <div class="progress w-100" style="height:8px"><div class="progress-bar" id="progressFill" style="width:0%"></div></div>
            <span id="statusLine" class="small muted">Sedia</span>
          </div>
          <div class="subtle mt-2" id="activeFilterMsg">Penapis: Semua kategori</div>
        </div>
      </div>
    </section>

    <!-- Trend Alerts -->
    <section class="card p-4 mb-3 slide-up">
      <div class="d-flex justify-content-between align-items-center">
        <div class="section-title"><i class="bi bi-activity me-2"></i>Trend Alerts (14 hari vs 14 hari)</div>
        <button id="btnReloadTrend" class="btn btn-outline-secondary btn-sm" type="button"><i class="bi bi-arrow-repeat"></i> Muat Semula</button>
      </div>
      <div id="trendBox" class="mt-2 small muted">Tiada alert signifikan buat masa ini.</div>
    </section>

    <!-- KPI -->
    <section class="stats-grid g-3 mb-3">
      <div class="stat slide-up">
        <div class="ico"><i class="bi bi-people"></i></div>
        <div>
          <div class="v" id="kpiLabeled">0</div>
          <div class="muted small">Pesakit Berlabel</div>
        </div>
      </div>
      <div class="stat slide-up" style="animation-delay:0.1s">
        <div class="ico"><i class="bi bi-tags"></i></div>
        <div>
          <div class="v" id="kpiCats">0</div>
          <div class="muted small">Kategori Diagnosis</div>
        </div>
      </div>
      <div class="stat slide-up" style="animation-delay:0.2s">
        <div class="ico"><i class="bi bi-graph-up-arrow"></i></div>
        <div>
          <div class="v" id="kpiTop">-</div>
          <div class="muted small">Diagnosis Terbanyak</div>
        </div>
      </div>
      <div class="stat slide-up" style="animation-delay:0.3s">
        <div class="ico"><i class="bi bi-telephone-outbound"></i></div>
        <div>
          <div class="v" id="kpiProspects">0</div>
          <div class="muted small">Prospek Outreach</div>
        </div>
      </div>
    </section>

    <!-- Tabs -->
    <ul class="nav nav-pills mb-3" id="tabs">
      <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-data" type="button">Data & Carta</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-reactivate" type="button">Re-activation 30+</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-pricing" type="button">Harga & Reminder</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-repeat" type="button">Repeat Registry</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-predictive" type="button">Analisis Prediktif</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-journey" type="button">Perjalanan Pesakit</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-segmentation" type="button">Segmentasi Pesakit</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-campaigns" type="button">Kempen Pemasaran</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-geo" type="button">Analisis Geospatial</button></li>
    </ul>

    <div class="tab-content">

      <!-- TAB: Data & Carta -->
      <div class="tab-pane fade show active" id="tab-data">
        <div class="d-flex flex-wrap gap-2 mb-3">
          <button id="btnSync" class="btn btn-warning" type="button"><i class="bi bi-arrow-repeat"></i> Sync Data</button>
          <button id="btnExport" class="btn btn-outline-success" type="button"><i class="bi bi-file-earmark-spreadsheet"></i> Eksport CSV</button>
          <button id="btnSort" class="btn btn-outline-secondary" type="button"><i class="bi bi-sort-alpha-down"></i> Susun Data</button>
          <button id="btnDelete" class="btn btn-outline-danger" type="button"><i class="bi bi-trash"></i> Padam Data</button>
          <div class="ms-auto small muted">Julat: <span id="legendPeriod">-</span></div>
        </div>

        <div class="row g-3 mb-3">
          <div class="col-12 col-xl-6">
            <div class="card p-3 slide-up">
              <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Taburan Mengikut Kategori <span id="legendCalc" class="badge text-bg-light ms-2"></span></h6>
                <span id="legend1" class="small muted"></span>
              </div>
              <div class="small text-muted mb-2">Klik kategori untuk tapis jadual.</div>
              <div class="chart-h"><canvas id="chartDonut"></canvas></div>
            </div>
          </div>
          <div class="col-12 col-xl-6">
            <div class="card p-3 slide-up" style="animation-delay:0.1s">
              <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Top Kategori Diagnosis</h6>
                <span id="legend2" class="small muted"></span>
              </div>
              <div class="small text-muted mb-2">Klik bar untuk tapis ikut kategori.</div>
              <div class="chart-h"><canvas id="chartBar"></canvas></div>
            </div>
          </div>
        </div>

        <!-- Kategori Pantas -->
        <div class="card p-3 mb-3 slide-up" style="animation-delay:0.2s">
          <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <h6 class="mb-0">Kategori Pantas</h6>
            <div class="subtle">Klik kategori untuk tapis. "Semua" untuk buang penapis.</div>
          </div>
          <div id="quickCats" class="d-flex flex-wrap gap-2 mt-2"></div>
        </div>

        <!-- Graf Kehadiran -->
        <div class="card p-3 mb-3 slide-up" style="animation-delay:0.3s">
          <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div class="d-flex align-items-center gap-2">
              <h6 class="mb-0">Graf Kehadiran Pesakit</h6>
              <span id="attnInfo" class="badge text-bg-light"></span>
            </div>
            <div class="btn-group" role="group" aria-label="attn-range">
              <button class="btn btn-outline-dark btn-sm btn-range" id="attn7"  type="button">7H</button>
              <button class="btn btn-outline-dark btn-sm btn-range" id="attn14" type="button">14H</button>
              <button class="btn btn-outline-dark btn-sm btn-range active" id="attn30" type="button">30H</button>
              <button class="btn btn-outline-dark btn-sm btn-range" id="attn60" type="button">60H</button>
              <button class="btn btn-outline-dark btn-sm btn-range" id="attn365" type="button">1T</button>
            </div>
          </div>
          <div class="chart-h-lg"><canvas id="chartAttn"></canvas></div>
        </div>

        <!-- Jadual Pesakit -->
        <div class="card p-3 slide-up" style="animation-delay:0.4s">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">Senarai Pesakit (Ditapis)</h6>
            <div class="d-flex align-items-center gap-2">
              <label class="small fw-semibold me-1">Saiz Halaman:</label>
              <select id="pageSize" class="form-select form-select-sm" style="width:90px">
                <option>20</option><option>50</option><option selected>100</option><option>200</option>
              </select>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table align-middle" id="tbl">
              <thead><tr><th>#</th><th>Nama Pesakit</th><th>Umur</th><th>Kod Diagnosis</th><th>Tarikh Lawatan</th><th>No. Telefon</th><th>WhatsApp</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="d-flex justify-content-between align-items-center mt-2">
            <div id="pageInfo" class="small muted">-</div>
            <div class="d-flex gap-2">
              <button class="btn btn-outline-secondary btn-sm" id="btnPrev" type="button"><i class="bi bi-chevron-left"></i> Sebelumnya</button>
              <button class="btn btn-outline-secondary btn-sm" id="btnNext" type="button">Seterusnya <i class="bi bi-chevron-right"></i></button>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: Re-activation -->
      <div class="tab-pane fade" id="tab-reactivate">
        <div class="d-flex align-items-center gap-2 mb-2">
          <div class="chip"><i class="bi bi-clock-history me-1"></i> Tidak datang ≥30 hari</div>
          <button id="btnReloadReAct" class="btn btn-outline-secondary btn-sm" type="button"><i class="bi bi-arrow-repeat"></i> Muat Semula</button>
        </div>
        <div class="card p-3">
          <div class="table-responsive">
            <table class="table align-middle" id="tblReAct">
              <thead><tr><th>#</th><th>Nama</th><th>Telefon</th><th>Kategori Terakhir</th><th>Tarikh Terakhir</th><th>Hari Senyap</th><th>WhatsApp</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- TAB: Pricing -->
      <div class="tab-pane fade" id="tab-pricing">
        <div class="row g-3">
          <div class="col-12 col-lg-6">
            <div class="card p-3">
              <h6 class="mb-2">Harga Rawatan (Manual)</h6>
              <div class="row g-2">
                <div class="col-4"><input id="priceCode" class="form-control" placeholder="cth: URTI"></div>
                <div class="col-5"><input id="priceName" class="form-control" placeholder="Nama (opsyen)"></div>
                <div class="col-3"><input id="priceValue" class="form-control" type="number" placeholder="Harga"></div>
                <div class="col-12"><button id="btnSavePrice" class="btn btn-success w-100" type="button"><i class="bi bi-save"></i> Simpan Harga</button></div>
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-6">
            <div class="card p-3">
              <h6 class="mb-2">Senarai Harga</h6>
              <ul id="priceList" class="list-group small"></ul>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: Repeat Registry -->
      <div class="tab-pane fade" id="tab-repeat">
        <div class="row g-3">
          <div class="col-12 col-lg-6">
            <div class="card p-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Daftar Ulang Tahunan / Berkala</h6>
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" role="switch" id="autoVaxSwitch" checked>
                  <label class="form-check-label small" for="autoVaxSwitch">Auto daftar vaksin bila data dimuat</label>
                </div>
              </div>
              <div class="row g-2">
                <div class="col-6"><input id="repName" class="form-control" placeholder="Nama Pesakit"></div>
                <div class="col-6"><input id="repPhone" class="form-control" placeholder="Telefon"></div>
                <div class="col-6">
                  <label class="small fw-semibold ms-1">Tarikh Servis Terakhir</label>
                  <input id="repLast" type="date" class="form-control">
                </div>
                <div class="col-6"><input id="repType" class="form-control" placeholder="Jenis (cth: Influenza)"></div>
                <div class="col-6">
                  <label class="small fw-semibold ms-1">Kitaran (hari)</label>
                  <input id="repEvery" class="form-control" type="number" value="365">
                </div>
                <div class="col-6">
                  <label class="small fw-semibold ms-1">Due Seterusnya (opsyen)</label>
                  <input id="repNext" type="date" class="form-control">
                </div>
                <div class="col-12"><input id="repNote" class="form-control" placeholder="Nota (opsyen)"></div>
                <div class="col-12 d-flex gap-2">
                  <button id="btnRepSave" class="btn btn-success flex-fill" type="button"><i class="bi bi-plus-circle"></i> Simpan</button>
                  <button id="btnScanVaxNow" class="btn btn-outline-primary" type="button"><i class="bi bi-eyedropper"></i> Imbas Sekali Lagi</button>
                </div>
              </div>
              <div class="small text-muted mt-2" id="autoVaxMsg">-</div>
            </div>
          </div>
          <div class="col-12 col-lg-6">
            <div class="card p-3">
              <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-2">Akan Due (14 hari akan datang)</h6>
                <button id="btnRepDue" class="btn btn-outline-secondary btn-sm" type="button"><i class="bi bi-arrow-repeat"></i> Muat Semula</button>
              </div>
              <div class="table-responsive">
                <table class="table align-middle small" id="tblRepDue">
                  <thead><tr><th>#</th><th>Nama</th><th>Telefon</th><th>Jenis</th><th>Due</th><th>WhatsApp</th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: Predictive Analytics -->
      <div class="tab-pane fade" id="tab-predictive">
        <div class="row g-3 mb-3">
          <div class="col-12 col-lg-6">
            <div class="card prediction-card p-3 slide-up">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Ramalan Trend Penyakit</h6>
                <button id="btnReloadPredictions" class="btn btn-outline-secondary btn-sm" type="button"><i class="bi bi-arrow-repeat"></i> Muat Semula</button>
              </div>
              <div class="small text-muted mb-2">Ramalan berdasarkan data historikal 3 bulan</div>
              <div class="chart-h"><canvas id="chartPredictions"></canvas></div>
              <div class="mt-2">
                <div class="alert alert-info">
                  <i class="bi bi-info-circle me-2"></i>
                  <span id="predictionInsight">Memuatkan ramalan...</span>
                </div>
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-6">
            <div class="card prediction-card p-3 slide-up" style="animation-delay:0.1s">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Nilai Sepanjang Hayat Pesakit</h6>
                <select id="plvPeriod" class="form-select form-select-sm" style="width:120px">
                  <option value="30">30 Hari</option>
                  <option value="90">3 Bulan</option>
                  <option value="180">6 Bulan</option>
                  <option value="365" selected>1 Tahun</option>
                </select>
              </div>
              <div class="small text-muted mb-2">Purata nilai pendapatan per pesakit</div>
              <div class="chart-h"><canvas id="chartPLV"></canvas></div>
              <div class="mt-2">
                <div class="d-flex justify-content-between">
                  <span class="small">PLV Purata:</span>
                  <span class="small fw-bold" id="avgPLV">RM 0</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="row g-3 mb-3">
          <div class="col-12 col-lg-6">
            <div class="card prediction-card p-3 slide-up" style="animation-delay:0.2s">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Ramalan Kadar Pertukaran</h6>
                <button id="btnReloadConversion" class="btn btn-outline-secondary btn-sm" type="button"><i class="bi bi-arrow-repeat"></i> Muat Semula</button>
              </div>
              <div class="small text-muted mb-2">Dari prospek ke pesakit aktif</div>
              <div class="chart-h"><canvas id="chartConversion"></canvas></div>
              <div class="mt-2">
                <div class="d-flex justify-content-between">
                  <span class="small">Kadar Pertukaran Semasa:</span>
                  <span class="small fw-bold" id="currentConversion">0%</span>
                </div>
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-6">
            <div class="card prediction-card p-3 slide-up" style="animation-delay:0.3s">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Risiko Kehilangan Pesakit</h6>
                <button id="btnReloadChurn" class="btn btn-outline-secondary btn-sm" type="button"><i class="bi bi-arrow-repeat"></i> Muat Semula</button>
              </div>
              <div class="small text-muted mb-2">Pesakit berisiko tinggi tidak kembali</div>
              <div class="table-responsive">
                <table class="table align-middle small" id="tblChurnRisk">
                  <thead><tr><th>Nama</th><th>Telefon</th><th>Risiko</th><th>Tindakan</th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: Patient Journey Mapping -->
      <div class="tab-pane fade" id="tab-journey">
        <div class="row g-3 mb-3">
          <div class="col-12 col-lg-8">
            <div class="card p-3 slide-up">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Peta Perjalanan Pesakit</h6>
                <select id="journeyPatient" class="form-select form-select-sm" style="width:200px">
                  <option value="">Pilih pesakit</option>
                </select>
              </div>
              <div class="small text-muted mb-2">Visualisasi lengkap perjalanan pesakit</div>
              <div id="patientJourneyMap" class="p-3" style="min-height: 300px;">
                <div class="data-empty">
                  <i class="bi bi-person-walking"></i>
                  <p>Sila pilih pesakit untuk melihat perjalanan mereka</p>
                </div>
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-4">
            <div class="card p-3 slide-up" style="animation-delay:0.1s">
              <h6 class="mb-2">Titik Sentuh Kritikal</h6>
              <div class="small text-muted mb-2">Tempat di mana pesakit mungkin hilang</div>
              <div id="criticalTouchpoints" class="list-group">
                <div class="list-group-item">
                  <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">Tempahan Pertama</h6>
                    <small class="text-muted">15% pesakit hilang</small>
                  </div>
                  <p class="mb-1">Pesakit yang membuat tempahan tetapi tidak hadir</p>
                  <div class="progress" style="height: 5px;">
                    <div class="progress-bar bg-danger" style="width: 15%"></div>
                  </div>
                </div>
                <div class="list-group-item">
                  <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">Follow-up</h6>
                    <small class="text-muted">8% pesakit hilang</small>
                  </div>
                  <p class="mb-1">Pesakit yang tidak hadir untuk follow-up</p>
                  <div class="progress" style="height: 5px;">
                    <div class="progress-bar bg-warning" style="width: 8%"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="row g-3 mb-3">
          <div class="col-12">
            <div class="card p-3 slide-up" style="animation-delay:0.2s">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Analisis Tempoh Menunggu</h6>
                <button id="btnReloadWaitTime" class="btn btn-outline-secondary btn-sm" type="button"><i class="bi bi-arrow-repeat"></i> Muat Semula</button>
              </div>
              <div class="small text-muted mb-2">Impak tempoh menunggu terhadap kepuasan pesakit</div>
              <div class="chart-h"><canvas id="chartWaitTime"></canvas></div>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: Patient Segmentation -->
      <div class="tab-pane fade" id="tab-segmentation">
        <div class="row g-3 mb-3">
          <div class="col-12">
            <div class="card p-3 slide-up">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Segmentasi Pesakit Dinamik</h6>
                <button id="btnReloadSegments" class="btn btn-outline-secondary btn-sm" type="button"><i class="bi bi-arrow-repeat"></i> Muat Semula</button>
              </div>
              <div class="small text-muted mb-2">Pesakit dikelaskan mengikut demografi, diagnosis, dan nilai</div>
              <div id="patientSegments" class="row g-3">
                <!-- Segments will be loaded here -->
              </div>
            </div>
          </div>
        </div>
        
        <div class="row g-3 mb-3">
          <div class="col-12 col-lg-6">
            <div class="card p-3 slide-up" style="animation-delay:0.1s">
              <h6 class="mb-2">Persona Pesakit</h6>
              <div class="small text-muted mb-2">Profil tipikal untuk setiap segmen</div>
              <div id="patientPersonas" class="row g-3">
                <!-- Personas will be loaded here -->
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-6">
            <div class="card p-3 slide-up" style="animation-delay:0.2s">
              <h6 class="mb-2">Potensi Pemasaran</h6>
              <div class="small text-muted mb-2">Nilai potensi untuk setiap segmen</div>
              <div class="chart-h"><canvas id="chartSegmentPotential"></canvas></div>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: Campaign Builder -->
      <div class="tab-pane fade" id="tab-campaigns">
        <div class="row g-3 mb-3">
          <div class="col-12 col-lg-8">
            <div class="card p-3 slide-up">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Kempen Pemasaran Aktif</h6>
                <button id="btnNewCampaign" class="btn btn-primary btn-sm" type="button"><i class="bi bi-plus-circle"></i> Kempen Baru</button>
              </div>
              <div class="small text-muted mb-2">Urus dan jejak kempen pemasaran anda</div>
              <div id="campaignList" class="row g-3">
                <!-- Campaigns will be loaded here -->
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-4">
            <div class="card p-3 slide-up" style="animation-delay:0.1s">
              <h6 class="mb-2">Prestasi Kempen</h6>
              <div class="small text-muted mb-2">ROI dan metrik prestasi</div>
              <div class="chart-h"><canvas id="chartCampaignROI"></canvas></div>
            </div>
          </div>
        </div>
        
        <div class="row g-3 mb-3">
          <div class="col-12">
            <div class="card p-3 slide-up" style="animation-delay:0.2s">
              <h6 class="mb-2">Ujian A/B</h6>
              <div class="small text-muted mb-2">Uji keberkesanan mesej pemasaran</div>
              <div class="table-responsive">
                <table class="table align-middle small" id="tblABTests">
                  <thead><tr><th>Kempen</th><th>Variasi</th><th>Hantaran</th><th>Buka</th><th>Klik</th><th>Tindakan</th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: Geospatial Analysis -->
      <div class="tab-pane fade" id="tab-geo">
        <div class="row g-3 mb-3">
          <div class="col-12">
            <div class="card p-3 slide-up">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Peta Taburan Pesakit</h6>
                <div class="btn-group" role="group">
                  <button class="btn btn-outline-dark btn-sm btn-geo-type active" data-type="patients">Pesakit</button>
                  <button class="btn btn-outline-dark btn-sm btn-geo-type" data-type="diseases">Penyakit</button>
                  <button class="btn btn-outline-dark btn-sm btn-geo-type" data-type="value">Nilai</button>
                </div>
              </div>
              <div class="small text-muted mb-2">Taburan geografi pesakit dan penyakit</div>
              <div id="geoHeatmap" class="geo-heatmap"></div>
            </div>
          </div>
        </div>
        
        <div class="row g-3 mb-3">
          <div class="col-12 col-lg-6">
            <div class="card p-3 slide-up" style="animation-delay:0.1s">
              <h6 class="mb-2">Kawasan Panas</h6>
              <div class="small text-muted mb-2">Kawasan dengan kepekatan pesakit tinggi</div>
              <div id="hotspotAreas" class="list-group">
                <!-- Hotspots will be loaded here -->
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-6">
            <div class="card p-3 slide-up" style="animation-delay:0.2s">
              <h6 class="mb-2">Cadangan Lokasi Acara</h6>
              <div class="small text-muted mb-2">Tempat yang sesuai untuk acara pemasaran</div>
              <div id="eventLocations" class="list-group">
                <!-- Event locations will be loaded here -->
              </div>
            </div>
          </div>
        </div>
      </div>

    </div><!-- /tab-content -->

    <footer class="text-center muted small mt-4 py-3">
      © 2025 Klinik — Dashboard Pemasaran. Data dalaman.
    </footer>
  </main><!-- /app -->

  <!-- Floating Action Button -->
  <div class="floating-action">
    <button id="fabSync" class="btn btn-primary btn-lg rounded-circle pulse" style="width:56px;height:56px;display:none">
      <i class="bi bi-arrow-repeat"></i>
    </button>
  </div>

</div><!-- /container -->

<!-- Toast area -->
<div class="toast-area">
  <div id="toast" class="toast text-bg-dark border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="toastBody">OK</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>

<!-- Campaign Modal -->
<div class="modal fade" id="campaignModal" tabindex="-1" aria-labelledby="campaignModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="campaignModalLabel">Cipta Kempen Baru</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="campaignForm">
          <div class="row g-3">
            <div class="col-md-6">
              <label for="campaignName" class="form-label">Nama Kempen</label>
              <input type="text" class="form-control" id="campaignName" required>
            </div>
            <div class="col-md-6">
              <label for="campaignType" class="form-label">Jenis Kempen</label>
              <select class="form-select" id="campaignType" required>
                <option value="">Pilih jenis</option>
                <option value="whatsapp">WhatsApp</option>
                <option value="sms">SMS</option>
                <option value="email">Emel</option>
              </select>
            </div>
            <div class="col-12">
              <label for="campaignSegment" class="form-label">Segmen Sasaran</label>
              <select class="form-select" id="campaignSegment" required>
                <option value="">Pilih segmen</option>
                <!-- Segments will be loaded here -->
              </select>
            </div>
            <div class="col-12">
              <label for="campaignMessage" class="form-label">Mesej</label>
              <textarea class="form-control" id="campaignMessage" rows="4" required></textarea>
            </div>
            <div class="col-md-6">
              <label for="campaignStartDate" class="form-label">Tarikh Mula</label>
              <input type="date" class="form-control" id="campaignStartDate" required>
            </div>
            <div class="col-md-6">
              <label for="campaignEndDate" class="form-label">Tarikh Tamat</label>
              <input type="date" class="form-control" id="campaignEndDate" required>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button type="button" class="btn btn-primary" id="btnSaveCampaign">Simpan</button>
      </div>
    </div>
  </div>
</div>

<!-- ===== App Script ===== -->
<script nonce="n123">
/************ KONFIG ************/
const CLIENT_ID   = '366415747851-9p6fegh84hkfs74prtmtj09ldsp2vi3m.apps.googleusercontent.com';
const BACKEND_URL = 'https://script.google.com/macros/s/AKfycby1A1DrDRsoW3CP9tDI1EMdLzVBaCeubhT5HOaFLQQtQ3K7GEYbgows-WgGLSQV71fX/exec';

/************ STATE ************/
let ID_TOKEN=null;
let donutChart, barChart, attnChart;
let predictionChart, plvChart, conversionChart, waitTimeChart, segmentPotentialChart, campaignRoiChart;
let geoMap;
let CUR_PAGE=1;
let LAST_PATIENT_ROWS=[];
let AUTO_VAX_SESSION_KEYS=new Set();
let CURRENT_LIST_DONUT=[], CURRENT_LIST_BAR=[];
let CODE_NAME_MAP = {}; // code -> friendly name
const CHART_ANIM = false;
let isLoading = false;
let loadingTimeout;
let isSyncing = false;

/************ DOM helpers ************/
const $ = (q)=>document.querySelector(q);
const show = el => el.classList.remove('hidden');
const hide = el => el.classList.add('hidden');
const pickGran = () => $('#gYear').checked?'year':($('#gMonth').checked?'month':'day');
const fmtPeriod = (s,e)=>`${s} → ${e}`;
const Toast = { show(msg){ $('#toastBody').textContent=msg; const t=bootstrap.Toast.getOrCreateInstance($('#toast')); t.show(); } };

// Loading states
const setLoading = (loading) => {
  isLoading = loading;
  if (loading) {
    clearTimeout(loadingTimeout);
    loadingTimeout = setTimeout(() => {
      document.querySelectorAll('.card').forEach(card => {
        if (!card.querySelector('.skeleton-container')) {
          const skeletonContainer = document.createElement('div');
          skeletonContainer.className = 'skeleton-container';
          skeletonContainer.innerHTML = '<div class="skeleton"></div><div class="skeleton"></div><div class="skeleton"></div>';
          card.appendChild(skeletonContainer);
        }
      });
    }, 300);
  } else {
    clearTimeout(loadingTimeout);
    document.querySelectorAll('.skeleton-container').forEach(el => el.remove());
  }
};

// Sync status bar
const showSyncStatus = (message, show = true) => {
  const statusBar = $('#syncStatusBar');
  const statusText = $('#syncStatusText');
  
  statusText.textContent = message;
  if (show) {
    statusBar.classList.add('show');
  } else {
    statusBar.classList.remove('show');
  }
};

// Performance optimization: Debounce function
const debounce = (func, wait) => {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
};

// Performance optimization: Throttle function
const throttle = (func, limit) => {
  let inThrottle;
  return function() {
    const args = arguments;
    const context = this;
    if (!inThrottle) {
      func.apply(context, args);
      inThrottle = true;
      setTimeout(() => inThrottle = false, limit);
    }
  };
};

/************ AUTH + INIT ************/
window.onload = () => {
  // default: bulan semasa
  const d=new Date(), s=new Date(d.getFullYear(),d.getMonth(),1), e=new Date(d.getFullYear(),d.getMonth()+1,0);
  $('#startDate').value = s.toISOString().slice(0,10);
  $('#endDate').value   = e.toISOString().slice(0,10);

  // Actions with debouncing for performance
  $('#btnApply').addEventListener('click', debounce(() => { CUR_PAGE=1; loadPatients(true,{refreshGlobal:true}); }, 300));
  $('#btnClear').addEventListener('click', debounce(() => { $('#filterDiag').value=''; $('#filterArea').value=''; CUR_PAGE=1; loadPatients(true,{refreshGlobal:true}); }, 300));
  $('#btnPrev').addEventListener('click', () => { if (CUR_PAGE>1){ CUR_PAGE--; loadPatients(false); } });
  $('#btnNext').addEventListener('click', () => { CUR_PAGE++; loadPatients(false); });
  $('#pageSize').addEventListener('change', () => { CUR_PAGE=1; loadPatients(false); });
  $('#btnExport').addEventListener('click', exportCSV);

  $('#btnSync').addEventListener('click', startSync);
  $('#btnDelete').addEventListener('click', deleteRange);
  $('#btnSort').addEventListener('click', sortRange);

  $('#btnReloadTrend').addEventListener('click', loadTrends);
  $('#btnReloadReAct').addEventListener('click', loadReactivation);

  $('#btnSavePrice').addEventListener('click', savePrice);
  $('#btnRepSave').addEventListener('click', saveRepeat);
  $('#btnRepDue').addEventListener('click', loadRepeatDue);

  // Predictive Analytics
  $('#btnReloadPredictions').addEventListener('click', loadPredictions);
  $('#btnReloadConversion').addEventListener('click', loadConversion);
  $('#btnReloadChurn').addEventListener('click', loadChurnRisk);
  $('#plvPeriod').addEventListener('change', loadPLV);

  // Patient Journey
  $('#journeyPatient').addEventListener('change', loadPatientJourney);
  $('#btnReloadWaitTime').addEventListener('click', loadWaitTime);

  // Segmentation
  $('#btnReloadSegments').addEventListener('click', loadSegments);

  // Campaigns
  $('#btnNewCampaign').addEventListener('click', () => {
    const modal = new bootstrap.Modal(document.getElementById('campaignModal'));
    modal.show();
  });
  $('#btnSaveCampaign').addEventListener('click', saveCampaign);

  // Geospatial
  $('.btn-geo-type').forEach(btn => {
    btn.addEventListener('click', function() {
      $('.btn-geo-type').forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      loadGeoHeatmap(this.dataset.type);
    });
  });

  // Floating action button
  $('#fabSync').addEventListener('click', startSync);

  ['attn7','attn14','attn30','attn60','attn365'].forEach(id=>{
    $('#'+id).addEventListener('click', async ()=>{
      document.querySelectorAll('.btn-range').forEach(b=>b.classList.remove('active'));
      $('#'+id).classList.add('active');
      const map={attn7:7, attn14:14, attn30:30, attn60:60, attn365:365};
      await drawAttendance(map[id]);
    });
  });

  $('#btnScanVaxNow').addEventListener('click', ()=>scanVaccinations(LAST_PATIENT_ROWS,true));

  // Show/hide FAB based on scroll
  window.addEventListener('scroll', throttle(() => {
    if (window.scrollY > 200) {
      $('#fabSync').style.display = 'flex';
    } else {
      $('#fabSync').style.display = 'none';
    }
  }, 100));

  initGSI();
};

function initGSI(){
  if (!window.google || !google.accounts || !google.accounts.id){
    $('#signinMsg').textContent='Gagal memuatkan Google SSO.'; return;
  }
  google.accounts.id.initialize({ client_id:CLIENT_ID, callback:onSignIn, ux_mode:'popup' });
  google.accounts.id.renderButton($('#gsiBtn'), { theme:'outline', size:'large', shape:'pill' });
}

async function onSignIn(resp){
  try{
    ID_TOKEN = resp.credential;
    hide($('#signinCard')); show($('#app'));

    const payload = JSON.parse(atob(resp.credential.split('.')[1]));
    $('#whoami').textContent = payload.name || payload.email;
    $('#userAvatar').textContent = (payload.name || 'U').charAt(0).toUpperCase();

    healthCheck();

    await loadPatients(true, { refreshGlobal:true });
    await Promise.all([loadPricing(), loadRepeatDue()]);
  }catch(e){
    console.error(e);
    $('#signinMsg').textContent='Log masuk gagal.';
  }
}

/************ BACKEND CALL ************/
async function callAPI(action, payload){
  if (!ID_TOKEN) throw new Error('Belum log masuk');
  const res = await fetch(BACKEND_URL,{
    method:'POST', mode:'cors', credentials:'omit',
    headers:{ 'Content-Type':'text/plain' },
    body: JSON.stringify({ action, id_token:ID_TOKEN, payload })
  });
  if (!res.ok) throw new Error(await res.text());
  return res.json();
}

/************ HEALTH ************/
async function healthCheck(){
  try{
    const r = await callAPI('health',{});
    const ok = r && r.ok;
    const cfg = r.cfg || {};
    $('#healthRow').innerHTML =
      `<span class="health-indicator health-${ok?'ok':'error'}"></span>
       <span class="badge bg-${ok?'success':'danger'} me-2"><i class="bi bi-heart-pulse"></i> Backend ${ok?'OK':'Down'}</span>
       <span class="badge text-bg-light me-1">ClientID:${cfg.clientIdSet?'✓':'✗'}</span>
       <span class="badge text-bg-light me-1">Token:${cfg.hasToken?'✓':'✗'}</span>
       <span class="badge text-bg-light me-1">Clinic:${cfg.hasClinic?'✓':'✗'}</span>`;
  }catch(e){
    $('#healthRow').innerHTML = `<span class="health-indicator health-error"></span><span class="badge bg-danger">Backend Error</span>`;
  }
}

/************ SUMMARY (FAST PATH + cache klien) ************/
let LAST_SUMMARY_KEY = '';
let LAST_SUMMARY_OBJ = null;

async function loadSummary(){
  const s=$('#startDate').value, e=$('#endDate').value;
  const key = `${s}|${e}`;
  if (LAST_SUMMARY_KEY===key && LAST_SUMMARY_OBJ) return LAST_SUMMARY_OBJ;

  try{
    let data = await callAPI('get_summary_range',{ start:s, end:e });
    if (!data.rows || !data.rows.length){
      await callAPI('compute_range',{ start:s, end:e });
      data = await callAPI('get_summary_range',{ start:s, end:e });
    }
    LAST_SUMMARY_KEY = key;
    LAST_SUMMARY_OBJ = data || { labeled:0, rows:[] };
    return LAST_SUMMARY_OBJ;
  }catch(err){
    console.warn('summary error:', err.message);
    return { labeled:0, rows:[] };
  }
}

/************ CHARTS + QUICK CATS ************/
function buildLocalSummary(rows){
  const counts={}; let labeled=0;
  rows.forEach(r=>{
    const codes=(r.diagnosisCodes||'').toString().toUpperCase().split(/[,\s]+/).filter(Boolean);
    if (codes.length){ labeled++; codes.forEach(c=>counts[c]=(counts[c]||0)+1); }
  });
  const list=Object.entries(counts).map(([code,count])=>({name:CODE_NAME_MAP[code]||code, code, count, pct:0}));
  const total=Object.values(counts).reduce((a,b)=>a+b,0)||1;
  list.forEach(x=>x.pct=Math.round(x.count*1000/total)/10);
  list.sort((a,b)=>b.count-a.count);
  return { labeled, list, counts, topName:list[0]?.name||'-' };
}
function drawDonut(list){
  CURRENT_LIST_DONUT = list.slice();
  const ctx=$('#chartDonut');
  const labels=list.map(d=>d.name), values=list.map(d=>d.pct);
  if (donutChart) donutChart.destroy();
  donutChart=new Chart(ctx,{
    type:'doughnut',
    data:{ labels, datasets:[{ data:values, backgroundColor:genColors(list.length), borderWidth:1, borderColor:'#fff' }]},
    options:{ animation:CHART_ANIM, plugins:{ legend:{ position:'bottom', labels:{ boxWidth:12, padding:14, font:{size:11} } } }, cutout:'65%', maintainAspectRatio:false,
      onClick: (_evt, el)=> {
        if (!el?.length) return;
        const idx = el[0].index;
        const code = CURRENT_LIST_DONUT[idx]?.code || CURRENT_LIST_DONUT[idx]?.name;
        if (!code) return;
        applyCategoryFilter(code);
      }
    }
  });
}
function drawBar(list){
  CURRENT_LIST_BAR = list.slice();
  const ctx=$('#chartBar');
  const labels=list.map(d=>d.name), values=list.map(d=>d.count);
  if (barChart) barChart.destroy();
  barChart=new Chart(ctx,{
    type:'bar',
    data:{ labels, datasets:[{ data:values, backgroundColor:genColors(list.length), borderWidth:0, borderRadius:4 }]},
    options:{ animation:CHART_ANIM, plugins:{ legend:{display:false}},
      scales:{ y:{beginAtZero:true, grid:{color:'rgba(0,0,0,.05)'}}, x:{grid:{display:false}} }, maintainAspectRatio:false,
      onClick: (_evt, el)=>{
        if (!el?.length) return;
        const idx = el[0].index;
        const code = CURRENT_LIST_BAR[idx]?.code || CURRENT_LIST_BAR[idx]?.name;
        if (!code) return;
        applyCategoryFilter(code);
      }
    }
  });
}
function genColors(n){
  const base=['#0d6efd','#198754','#ffc107','#dc3545','#6f42c1','#fd7e14','#20c997','#0dcaf0','#d63384','#6610f2'];
  return Array.from({length:n},(_,i)=>base[i%base.length]);
}
function renderQuickCats(list){
  const box = $('#quickCats'); box.innerHTML='';
  if (!list || !list.length){ box.innerHTML = `<span class="subtle">Tiada kategori ditemui.</span>`; return; }
  const all = document.createElement('button'); all.className = 'cat-chip'; all.textContent = 'Semua';
  all.addEventListener('click', ()=>applyCategoryFilter('')); box.appendChild(all);
  list.slice(0,12).forEach(item=>{
    const btn=document.createElement('button');
    btn.className='cat-chip'; btn.setAttribute('data-code', item.code || item.name);
    const friendly = item.name || item.code;
    btn.innerHTML = `${escapeHTML(friendly)} <span class="subtle">(${item.count})</span>`;
    btn.title = (item.code && CODE_NAME_MAP[item.code] && CODE_NAME_MAP[item.code]!==item.code) ? `${item.code} • ${CODE_NAME_MAP[item.code]}` : (item.code || friendly);
    btn.addEventListener('click', ()=>applyCategoryFilter(item.code || item.name));
    box.appendChild(btn);
  });
  highlightActiveChip();
}
function applyCategoryFilter(code){
  $('#filterDiag').value = (code||'').toUpperCase();
  CUR_PAGE=1;
  loadPatients(false, { refreshGlobal:false });
  highlightActiveChip();
  const name = code ? (CODE_NAME_MAP[code] || code) : 'Semua kategori';
  $('#activeFilterMsg').textContent = `Penapis: ${name}`;
  Toast.show(code ? `Ditapis ikut kategori: ${name}` : 'Penapis kategori dibuang');
}
function highlightActiveChip(){
  const code = ($('#filterDiag').value||'').trim().toUpperCase();
  document.querySelectorAll('#quickCats .cat-chip').forEach(btn=>{
    const c = (btn.getAttribute('data-code')||'').toUpperCase();
    btn.classList.toggle('active', code && c===code);
    if (!code && btn.textContent.trim()==='Semua') btn.classList.add('active');
  });
}

/************ ATTENDANCE (FAST VIA BACKEND) ************/
async function drawAttendance(daysOrYear){
  const days = daysOrYear===365 ? 365 : daysOrYear;
  try{
    const r = await callAPI('attendance_series',{ days });
    const labels = r.series.map(x=>x.date);
    const data   = r.series.map(x=>x.count);

    $('#attnInfo').textContent = (days===365) ? `12 Bulan Terkini — Jumlah: ${r.total}` : `${days} Hari Terkini — Jumlah: ${r.total}`;

    const ctx=$('#chartAttn');
    if (attnChart) attnChart.destroy();
    attnChart = new Chart(ctx, {
      type: 'line',
      data: { labels, datasets: [{ label:'Kehadiran', data, fill:false, tension:0.25, borderWidth:2, pointRadius:0, borderColor: '#0d6efd' }]},
      options: { animation:CHART_ANIM, plugins:{ legend:{ display:false } },
        scales:{ y:{ beginAtZero:true, grid:{ color:'rgba(0,0,0,.05)'} }, x:{ grid:{ display:false } } },
        maintainAspectRatio:false }
    });
  }catch(e){ console.warn('attendance error:', e.message); }
}

/************ TREND ALERTS & REACTIVATION ************/
async function loadTrends(){
  try{
    const r = await callAPI('trend_alerts',{});
    const arr = r.alerts || [];
    if (!arr.length){ 
      $('#trendBox').innerHTML = '<div class="data-empty"><i class="bi bi-check-circle"></i><p>Tiada alert signifikan buat masa ini.</p></div>'; 
      return; 
    }
    $('#trendBox').innerHTML = arr.map(a=>`
      <div class="d-flex align-items-center gap-2 mb-1 alert alert-${a.growthPct > 0 ? 'danger' : 'success'} py-2">
        <i class="bi bi-arrow-${a.growthPct > 0 ? 'up' : 'down'} text-${a.growthPct > 0 ? 'danger' : 'success'}"></i>
        <span><strong>${a.name}</strong> ${a.growthPct > 0 ? 'meningkat' : 'menurun'} <strong>${Math.abs(a.growthPct)}%</strong> (Kini: ${a.now}, Sebelum: ${a.prev})</span>
      </div>`).join('');
  }catch(e){ $('#trendBox').innerHTML='<div class="alert alert-warning">Gagal memuatkan alert.</div>'; }
}
async function loadReactivation(){
  const tb = $('#tblReAct tbody'); if(!tb) return; tb.innerHTML='';
  try{
    const r = await callAPI('reactivation_list',{ days:30 });
    const rows = r.rows || [];
    if (!rows.length){ 
      tb.innerHTML = `<tr><td colspan="7" class="text-center py-4"><div class="data-empty"><i class="bi bi-people"></i><p>Tiada rekod.</p></div></td></tr>`; 
      return; 
    }
    rows.forEach((x,i)=>{
      const wa = x.phone?`https://wa.me/${String(x.phone).replace(/\D/g,'')}`:'';
      const msg = encodeURIComponent(`Hai ${x.name}, ini klinik anda. Bagaimana keadaan selepas lawatan terakhir (${x.lastVisit})? Jika perlu bantuan/temujanji, balas mesej ini ya.`);
      tb.insertAdjacentHTML('beforeend',`
        <tr>
          <td>${i+1}</td><td>${escapeHTML(x.name||'-')}</td><td>${escapeHTML(x.phone||'-')}</td>
          <td>${escapeHTML(x.lastCategory||'-')}</td><td>${x.lastVisit}</td><td>${x.daysSilent}</td>
          <td>${wa?`<a class="btn btn-sm btn-success" target="_blank" rel="noopener" href="${wa}?text=${msg}"><i class="bi bi-whatsapp"></i></a>`:'-'}</td>
        </tr>`);
    });
  }catch(e){ tb.innerHTML = `<tr><td colspan="7" class="text-danger">Ralat: ${e.message}</td></tr>`; }
}

/************ PATIENTS ************/
async function loadPatients(refreshSummary=true, opts={}){
  if (isLoading) return;
  setLoading(true);
  
  const { refreshGlobal=false } = opts;
  const s=$('#startDate').value, e=$('#endDate').value;
  const diag=($('#filterDiag').value||'').trim();
  const area=($('#filterArea').value||'').trim();
  const pageSize=Number($('#pageSize').value||100);
  updateStatus('Memuat senarai pesakit…', 50);

  try{
    // Force cache refresh if explicitly requested
    if (refreshSummary) {
      const cacheKey = `PATIENTS:${s}|${e}|${diag}|${area}|${CUR_PAGE}|${pageSize}`;
      // Note: We can't directly clear cache from frontend, but we can add a timestamp to force refresh
      await callAPI('clear_cache', { patterns: [`PATIENTS:${s}|${e}`] });
    }
    
    const res=await callAPI('patients',{ startISO:s, endISO:e, page:CUR_PAGE, pageSize, diagnosisCode:diag, areaQuery:area });
    LAST_PATIENT_ROWS = res.rows||[];
    renderPatients(LAST_PATIENT_ROWS);

    const total=res.total||0;
    const from=(total===0)?0:((CUR_PAGE-1)*pageSize+1);
    const to=Math.min(CUR_PAGE*pageSize,total);
    $('#pageInfo').textContent = `Jumlah: ${total.toLocaleString()} | Halaman ${CUR_PAGE} (${from}-${to})`;

    $('#legend1').textContent=fmtPeriod(s,e);
    $('#legend2').textContent=fmtPeriod(s,e);
    $('#legendPeriod').textContent=fmtPeriod(s,e);
    $('#legendCalc').textContent='';

    if (refreshSummary){
      const data = await loadSummary();
      CODE_NAME_MAP = {};
      if (data.rows && data.rows.length){
        data.rows.forEach(r=>{ const code=r[4], name=r[5]; if (code && name) CODE_NAME_MAP[code]=name; });
        $('#kpiLabeled').textContent=(data.labeled||0).toLocaleString();
        $('#kpiCats').textContent=new Set(data.rows.map(r=>r[4])).size||0;
        const top=data.rows.slice().sort((a,b)=>b[6]-a[6])[0];
        $('#kpiTop').textContent=top?top[5]:'-';
        const list = data.rows.map(r=>({ name:r[5], code:r[4], count:r[6], pct:r[7] })).sort((a,b)=>b.count-a.count);
        drawDonut(list); drawBar(list.slice(0,8)); renderQuickCats(list);
      }else{
        const local=buildLocalSummary(LAST_PATIENT_ROWS);
        $('#legendCalc').textContent='Local calc';
        $('#kpiLabeled').textContent=local.labeled.toLocaleString();
        $('#kpiCats').textContent=Object.keys(local.counts).length;
        $('#kpiTop').textContent=local.topName||'-';
        drawDonut(local.list); drawBar(local.list.slice(0,8)); renderQuickCats(local.list);
      }
    }

    const activeBtn = document.querySelector('.btn-range.active');
    const map={attn7:7,attn14:14,attn30:30,attn60:60,attn365:365};
    const days = map[activeBtn?.id || 'attn30'] || 30;
    await drawAttendance(days);

    if (refreshGlobal){ await Promise.all([loadTrends(), loadReactivation()]); }

    if ($('#autoVaxSwitch')?.checked) { scanVaccinations(LAST_PATIENT_ROWS,false); }

    const codeNow = ($('#filterDiag').value||'').trim().toUpperCase();
    $('#activeFilterMsg').textContent = `Penapis: ${codeNow? (CODE_NAME_MAP[codeNow]||codeNow) : 'Semua kategori'}`;

    updateStatus('Data dimuat', 100);
  }catch(err){
    console.error(err);
    updateStatus('Ralat memuat pesakit: '+err.message, 0);
    Toast.show('Ralat memuat pesakit: ' + err.message);
  } finally {
    setLoading(false);
  }
}

function renderPatients(rows){
  const tb=$('#tbl tbody'); tb.innerHTML='';
  if (!rows.length) { 
    tb.innerHTML = `<tr><td colspan="7" class="text-center py-4"><div class="data-empty"><i class="bi bi-search"></i><p>Tiada data ditemui untuk penapis yang dipilih</p></div></td></tr>`; 
    return; 
  }
  rows.forEach((r,i)=>{
    const phoneStr = String(r.phone||'');
    const wa=phoneStr?`https://wa.me/${phoneStr.replace(/\D/g,'')}`:'';
    const codes = String(r.diagnosisCodes||'').toUpperCase().split(/[,\s]+/).filter(Boolean);
    const chips = codes.length
      ? codes.map(c=>{ const tip = CODE_NAME_MAP[c] && CODE_NAME_MAP[c]!==c ? ` title="${c} • ${CODE_NAME_MAP[c]}"` : ` title="${c}"`; return `<span class="badge badge-code me-1"${tip}>${escapeHTML(c)}</span>`; }).join('')
      : '<span class="text-muted">-</span>';
    tb.insertAdjacentHTML('beforeend',`
      <tr>
        <td class="fw-semibold">${i+1 + (CUR_PAGE-1)*Number($('#pageSize').value||100)}</td>
        <td>${escapeHTML(r.name||'-')}</td>
        <td>${r.age||'-'}</td>
        <td>${chips}</td>
        <td>${r.visitDate||'-'}</td>
        <td>${escapeHTML(formatPhone(r.phone))||'-'}</td>
        <td>${wa?`<a class="btn btn-sm btn-success" target="_blank" rel="noopener" href="${wa}"><i class="bi bi-whatsapp"></i></a>`:'-'}</td>
      </tr>`);
  });
}

function formatPhone(phone){ if (!phone) return ''; const cleaned=String(phone).replace(/\D/g,''); if (cleaned.length===10) return cleaned.replace(/(\d{3})(\d{3})(\d{4})/,'$1-$2-$3'); if (cleaned.length===11) return cleaned.replace(/(\d{3})(\d{4})(\d{4})/,'$1-$2-$3'); return String(phone); }
function escapeHTML(s){ return String(s).replace(/[&<>\"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/************ AUTO-DAFTAR VAKSIN ************/
const VAX_PATTERNS = [
  { re:/\b(influenza|flu)\b/i, type:'Influenza', days:365 },
  { re:/\b(covid|covid[-\s]?19)\b/i, type:'Covid', days:365 },
  { re:/\b(tetanus)\b/i, type:'Tetanus', days:365 },
  { re:/\b(hpv)\b/i, type:'HPV', days:365 },
  { re:/\b(hep[\s-]?b|hepatitis\s*b)\b/i, type:'HepB', days:365 },
  { re:/\b(vaksin|vaccine|vacc)\b/i, type:'Vaksin', days:365 },
];
function detectVaxType(text){ if (!text) return null; for (const p of VAX_PATTERNS){ if (p.re.test(text)) return { type:p.type, days:p.days }; } return null; }
async function scanVaccinations(rows, manualTriggered){
  if (!rows || !rows.length) { $('#autoVaxMsg').textContent='Tiada data untuk imbas.'; return; }
  let attempts=0, success=0;
  for (const r of rows){
    const blob = [r.diagnosisCodes||'', r.diagnosisText||''].join(' ');
    const hit = detectVaxType(blob);
    if (!hit) continue;
    const name = String(r.name||'').trim();
    const phone= String(r.phone||'').trim();
    const last = String(r.visitDate||'').slice(0,10);
    if (!name || !phone || !last) continue;
    const key = `${phone}|${hit.type}|${last}`;
    if (AUTO_VAX_SESSION_KEYS.has(key)) continue; AUTO_VAX_SESSION_KEYS.add(key);
    attempts++;
    try{
      await callAPI('repeat_upsert',{ patient_name:name, phone:phone, last_service:last, type:hit.type, due_every_days:hit.days, note:'auto' });
      success++;
    }catch(e){ console.warn('auto vax upsert fail:', e.message); }
  }
  const msg = attempts ? `Auto-vaksin: ${success}/${attempts} didaftar.` : 'Auto-vaksin: Tiada kes vaksin dikesan.';
  $('#autoVaxMsg').textContent = msg;
  if (manualTriggered) Toast.show(msg);
}

/************ SYNC / PADAM / SUSUN ************/
async function startSync(){
  if (isSyncing) {
    Toast.show('Sync sedang berjalan. Sila tunggu.');
    return;
  }
  
  isSyncing = true;
  const s=$('#startDate').value, e=$('#endDate').value; const gran=pickGran();
  
  // Show sync status bar
  showSyncStatus('Memulakan sync data...');
  updateStatus('Memulakan sync…', 10);
  
  try{
    const { job, synced, total } = await callAPI('sync_start',{ startISO:s, endISO:e, granularity:gran, dedup:true });
    
    // Show immediate feedback
    showSyncStatus(`Sync dimulakan: ${synced}/${total} rekod baharu`);
    updateStatus(`Sync dimulakan: ${synced}/${total} rekod baharu`, 30);
    
    await pollProgress(job);
    
    // Force refresh all data after sync
    CUR_PAGE=1; 
    await loadPatients(true, { refreshGlobal:true });
    
    // Show success message
    showSyncStatus(`Sync selesai: ${synced}/${total} rekod baharu`, false);
    Toast.show(`Sync selesai: ${synced}/${total} rekod baharu`);
  }catch(err){ 
    console.error(err); 
    showSyncStatus(`Ralat sync: ${err.message}`, false);
    updateStatus('Ralat sync: '+err.message, 0); 
    Toast.show('Ralat sync: ' + err.message);
  } finally {
    isSyncing = false;
  }
}
async function pollProgress(job){
  return new Promise((resolve,reject)=>{
    const timer=setInterval(async ()=>{
      try{
        const p=await callAPI('sync_progress',{ job });
        let progress = 10;
        if (p.total && p.doneCount) progress = 10 + Math.floor((p.doneCount / p.total) * 80);
        updateStatus(`Menyelaraskan data… ${p.doneCount||0}/${p.total||0}`, progress);
        showSyncStatus(`Menyelaraskan data… ${p.doneCount||0}/${p.total||0}`);
        if (p.done){ 
          clearInterval(timer); 
          updateStatus('Sync selesai, memuat semula data...', 90);
          showSyncStatus('Sync selesai, memuat semula data...');
          setTimeout(resolve, 300); 
        }
      }catch(e){ 
        clearInterval(timer); 
        showSyncStatus(`Ralat sync: ${e.message}`, false);
        updateStatus('Ralat sync: ' + e.message, 0); 
        reject(e); 
      }
    }, 1500);
  });
}
async function deleteRange(){
  if (!confirm('Padam data dalam julat tarikh ini?')) return;
  const s=$('#startDate').value, e=$('#endDate').value, gran=pickGran();
  try{
    updateStatus('Memadam data…', 50);
    await callAPI('delete_range',{ start:s, end:e, granularity:gran });
    updateStatus('Data dipadam', 100);
    CUR_PAGE=1; await loadPatients(true, { refreshGlobal:true });
  }catch(err){ updateStatus('Padam gagal: ' + err.message, 0); }
}
async function sortRange(){
  const s=$('#startDate').value, e=$('#endDate').value, gran=pickGran();
  try{
    updateStatus('Menyusun data…', 50);
    await callAPI('sort_range',{ start:s, end:e, granularity:gran, by:'date', order:'asc' });
    updateStatus('Data disusun', 100);
    CUR_PAGE=1; await loadPatients(false);
  }catch(err){ updateStatus('Susun gagal: ' + err.message, 0); }
}
function updateStatus(message, progress){ 
  $('#statusLine').textContent = message; 
  $('#progressFill').style.width = `${progress}%`;
  if (progress === 100) {
    setTimeout(() => {
      $('#progressFill').style.width = '0%';
      $('#statusLine').textContent = 'Sedia';
    }, 2000);
  }
}

/************ PRICING ************/
async function loadPricing(){
  try{
    const r = await callAPI('pricing_get',{});
    const items = r.items || [];
    const ul = document.querySelector('#priceList'); if(!ul) return; ul.innerHTML='';
    if (!items.length){ ul.innerHTML = `<li class="list-group-item small text-muted">Tiada data harga.</li>`; return; }
    items.forEach(it=>{
      ul.insertAdjacentHTML('beforeend', `<li class="list-group-item d-flex justify-content-between align-items-center">
        <span><strong>${escapeHTML(it.code)}</strong> — ${escapeHTML(it.name||it.code)}</span>
        <span class="badge text-bg-primary">RM ${Number(it.price||0).toFixed(2)}</span>
      </li>`);
    });
  }catch(e){ console.warn('pricing_get:', e.message); }
}
async function savePrice(){
  const code = document.querySelector('#priceCode').value.trim().toUpperCase();
  const name = document.querySelector('#priceName').value.trim();
  const price= Number(document.querySelector('#priceValue').value||0);
  if (!code){ alert('Masukkan kod.'); return; }
  try{
    await callAPI('pricing_set',{ code, name, price });
    document.querySelector('#priceCode').value=''; document.querySelector('#priceName').value=''; document.querySelector('#priceValue').value='';
    await loadPricing();
  }catch(e){ alert('Gagal simpan harga: '+e.message); }
}

/************ REPEAT REGISTRY ************/
async function saveRepeat(){
  const payload = {
    patient_name: document.querySelector('#repName').value.trim(),
    phone: document.querySelector('#repPhone').value.trim(),
    last_service: document.querySelector('#repLast').value,
    type: document.querySelector('#repType').value.trim(),
    due_every_days: Number(document.querySelector('#repEvery').value||365),
    next_due_date: document.querySelector('#repNext').value,
    note: document.querySelector('#repNote').value.trim()
  };
  if (!payload.patient_name || !payload.phone || !payload.last_service){ alert('Nama, Telefon & Tarikh terakhir diperlukan.'); return; }
  try{
    await callAPI('repeat_upsert', payload);
    document.querySelector('#repName').value=''; document.querySelector('#repPhone').value=''; document.querySelector('#repLast').value=''; document.querySelector('#repType').value='';
    document.querySelector('#repEvery').value='365'; document.querySelector('#repNext').value=''; document.querySelector('#repNote').value='';
    await loadRepeatDue();
  }catch(e){ alert('Gagal simpan: '+e.message); }
}
async function loadRepeatDue(){
  const tb = document.querySelector('#tblRepDue tbody'); if(!tb) return; tb.innerHTML='';
  try{
    const r = await callAPI('repeat_due_list',{ daysAhead:14 });
    const rows = r.rows || [];
    if (!rows.length){ 
      tb.innerHTML = `<tr><td colspan="6" class="text-center py-4"><div class="data-empty"><i class="bi bi-calendar-check"></i><p>Tiada yang due 14 hari terdekat.</p></div></td></tr>`; 
      return; 
    }
    rows.forEach((x,i)=>{
      const wa=x.phone?`https://wa.me/${String(x.phone).replace(/\D/g,'')}`:'';
      const msg = encodeURIComponent(`Hai ${x.name}, temujanji ${x.type||'servis'} anda bakal due pada ${x.next_due_date}. Mahu tempah slot?`);
      tb.insertAdjacentHTML('beforeend',`
        <tr>
          <td>${i+1}</td><td>${escapeHTML(x.name||'-')}</td><td>${escapeHTML(x.phone||'-')}</td>
          <td>${escapeHTML(x.type||'-')}</td><td>${x.next_due_date}</td>
          <td>${wa?`<a class="btn btn-sm btn-success" target="_blank" rel="noopener" href="${wa}?text=${msg}"><i class="bi bi-whatsapp"></i></a>`:'-'}</td>
        </tr>`);
    });
  }catch(e){ tb.innerHTML = `<tr><td colspan="6" class="text-danger">Ralat: ${e.message}</td></tr>`; }
}

/************ CSV EXPORT ************/
function exportCSV(){
  const rows=[...document.querySelectorAll('#tbl tbody tr')].map(tr=>{
    const t=tr.querySelectorAll('td');
    return { name:t[1]?.textContent||'', age:t[2]?.textContent||'', codes:t[3]?.innerText||'', date:t[4]?.textContent||'', phone:t[5]?.textContent||'' };
  });
  if (!rows.length){ alert('Tiada data untuk dieksport'); return; }
  const header=['Nama','Umur','Kod Diagnosis','Tarikh','Telefon'];
  const csv=[header].concat(rows.map(r=>[r.name,r.age,r.codes,r.date,r.phone]))
    .map(a=>a.map(f=>`"${String(f).replace(/"/g,'""')}"`).join(',')).join('\n');
  const url=URL.createObjectURL(new Blob(["\uFEFF"+csv],{type:'text/csv;charset=utf-8;'}));
  const a=document.createElement('a'); a.href=url; a.download=`pesakit_${$('#startDate').value}_hingga_${$('#endDate').value}.csv`; a.click(); URL.revokeObjectURL(url);
}

/************ PREDICTIVE ANALYTICS ************/
async function loadPredictions() {
  try {
    const r = await callAPI('predictive_analytics', { type: 'disease_trends' });
    
    const ctx = $('#chartPredictions');
    if (predictionChart) predictionChart.destroy();
    
    predictionChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: r.labels,
        datasets: [{
          label: 'Data Sebenar',
          data: r.actual,
          borderColor: '#0d6efd',
          backgroundColor: 'rgba(13, 110, 253, 0.1)',
          fill: true,
          tension: 0.4
        }, {
          label: 'Ramalan',
          data: r.predicted,
          borderColor: '#dc3545',
          backgroundColor: 'rgba(220, 53, 69, 0.1)',
          borderDash: [5, 5],
          fill: true,
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'top',
          },
          tooltip: {
            mode: 'index',
            intersect: false,
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Bilangan Kes'
            }
          }
        }
      }
    });
    
    $('#predictionInsight').textContent = r.insight || 'Ramalan berdasarkan data 3 bulan terakhir';
  } catch (e) {
    console.error('Error loading predictions:', e);
    $('#predictionInsight').textContent = 'Gagal memuatkan ramalan';
  }
}

async function loadPLV() {
  try {
    const period = $('#plvPeriod').val();
    const r = await callAPI('predictive_analytics', { type: 'plv', period });
    
    const ctx = $('#chartPLV');
    if (plvChart) plvChart.destroy();
    
    plvChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: r.segments,
        datasets: [{
          label: 'Nilai Sepanjang Hayat (RM)',
          data: r.values,
          backgroundColor: [
            'rgba(13, 110, 253, 0.7)',
            'rgba(25, 135, 84, 0.7)',
            'rgba(255, 193, 7, 0.7)',
            'rgba(220, 53, 69, 0.7)',
            'rgba(108, 117, 125, 0.7)'
          ],
          borderColor: [
            'rgba(13, 110, 253, 1)',
            'rgba(25, 135, 84, 1)',
            'rgba(255, 193, 7, 1)',
            'rgba(220, 53, 69, 1)',
            'rgba(108, 117, 125, 1)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'RM'
            }
          }
        }
      }
    });
    
    $('#avgPLV').textContent = `RM ${r.average || 0}`;
  } catch (e) {
    console.error('Error loading PLV:', e);
    $('#avgPLV').textContent = 'RM 0';
  }
}

async function loadConversion() {
  try {
    const r = await callAPI('predictive_analytics', { type: 'conversion' });
    
    const ctx = $('#chartConversion');
    if (conversionChart) conversionChart.destroy();
    
    conversionChart = new Chart(ctx, {
      type: 'funnel',
      data: {
        labels: r.labels,
        datasets: [{
          label: 'Bilangan',
          data: r.values,
          backgroundColor: [
            'rgba(13, 110, 253, 0.7)',
            'rgba(25, 135, 84, 0.7)',
            'rgba(255, 193, 7, 0.7)',
            'rgba(220, 53, 69, 0.7)'
          ],
          borderColor: [
            'rgba(13, 110, 253, 1)',
            'rgba(25, 135, 84, 1)',
            'rgba(255, 193, 7, 1)',
            'rgba(220, 53, 69, 1)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.dataset.label || '';
                const value = context.raw || 0;
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = Math.round((value / total) * 100);
                return `${label}: ${value} (${percentage}%)`;
              }
            }
          }
        }
      }
    });
    
    $('#currentConversion').textContent = `${r.rate || 0}%`;
  } catch (e) {
    console.error('Error loading conversion:', e);
    $('#currentConversion').textContent = '0%';
  }
}

async function loadChurnRisk() {
  try {
    const r = await callAPI('predictive_analytics', { type: 'churn_risk' });
    const tb = $('#tblChurnRisk tbody');
    tb.innerHTML = '';
    
    if (!r.patients || !r.patients.length) {
      tb.innerHTML = `<tr><td colspan="4" class="text-center py-4"><div class="data-empty"><i class="bi bi-shield-exclamation"></i><p>Tiada pesakit berisiko tinggi</p></div></td></tr>`;
      return;
    }
    
    r.patients.forEach((patient, i) => {
      const riskClass = patient.risk === 'high' ? 'danger' : patient.risk === 'medium' ? 'warning' : 'success';
      const wa = patient.phone ? `https://wa.me/${String(patient.phone).replace(/\D/g,'')}` : '';
      
      tb.insertAdjacentHTML('beforeend', `
        <tr>
          <td>${escapeHTML(patient.name || '-')}</td>
          <td>${escapeHTML(patient.phone || '-')}</td>
          <td><span class="badge bg-${riskClass}">${patient.risk === 'high' ? 'Tinggi' : patient.risk === 'medium' ? 'Sederhana' : 'Rendah'}</span></td>
          <td>
            ${wa ? `<a class="btn btn-sm btn-success" target="_blank" rel="noopener" href="${wa}"><i class="bi bi-whatsapp"></i> Hubungi</a>` : '-'}
          </td>
        </tr>
      `);
    });
  } catch (e) {
    console.error('Error loading churn risk:', e);
    const tb = $('#tblChurnRisk tbody');
    tb.innerHTML = `<tr><td colspan="4" class="text-danger">Ralat: ${e.message}</td></tr>`;
  }
}

/************ PATIENT JOURNEY ************/
async function loadPatientJourney() {
  const patientId = $('#journeyPatient').val();
  if (!patientId) {
    $('#patientJourneyMap').innerHTML = `
      <div class="data-empty">
        <i class="bi bi-person-walking"></i>
        <p>Sila pilih pesakit untuk melihat perjalanan mereka</p>
      </div>
    `;
    return;
  }
  
  try {
    const r = await callAPI('patient_journey', { patient_id: patientId });
    
    let journeyHtml = '<div class="timeline">';
    r.steps.forEach((step, i) => {
      const statusClass = step.completed ? 'text-success' : 'text-muted';
      const icon = step.completed ? 'check-circle-fill' : 'circle';
      
      journeyHtml += `
        <div class="patient-journey-step mb-3">
          <div class="d-flex justify-content-between align-items-center">
            <h6 class="${statusClass}">${step.title}</h6>
            <small class="text-muted">${step.date || '-'}</small>
          </div>
          <p class="small">${step.description || ''}</p>
          ${step.duration ? `<small class="text-muted">Tempoh: ${step.duration}</small>` : ''}
        </div>
      `;
    });
    journeyHtml += '</div>';
    
    $('#patientJourneyMap').innerHTML = journeyHtml;
  } catch (e) {
    console.error('Error loading patient journey:', e);
    $('#patientJourneyMap').innerHTML = `<div class="alert alert-danger">Ralat: ${e.message}</div>`;
  }
}

async function loadWaitTime() {
  try {
    const r = await callAPI('patient_journey', { type: 'wait_time_analysis' });
    
    const ctx = $('#chartWaitTime');
    if (waitTimeChart) waitTimeChart.destroy();
    
    waitTimeChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: r.labels,
        datasets: [{
          label: 'Kepuasan Pesakit',
          data: r.satisfaction,
          backgroundColor: 'rgba(13, 110, 253, 0.7)',
          borderColor: 'rgba(13, 110, 253, 1)',
          borderWidth: 1,
          yAxisID: 'y'
        }, {
          label: 'Tempoh Menunggu (minit)',
          data: r.waitTimes,
          type: 'line',
          borderColor: 'rgba(220, 53, 69, 1)',
          backgroundColor: 'rgba(220, 53, 69, 0.1)',
          tension: 0.4,
          yAxisID: 'y1'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'top',
          }
        },
        scales: {
          y: {
            type: 'linear',
            display: true,
            position: 'left',
            title: {
              display: true,
              text: 'Kepuasan Pesakit (%)'
            },
            min: 0,
            max: 100
          },
          y1: {
            type: 'linear',
            display: true,
            position: 'right',
            title: {
              display: true,
              text: 'Tempoh Menunggu (minit)'
            },
            grid: {
              drawOnChartArea: false
            }
          }
        }
      }
    });
  } catch (e) {
    console.error('Error loading wait time analysis:', e);
  }
}

/************ PATIENT SEGMENTATION ************/
async function loadSegments() {
  try {
    const r = await callAPI('patient_segmentation');
    
    const container = $('#patientSegments');
    container.innerHTML = '';
    
    r.segments.forEach((segment, i) => {
      const segmentCard = document.createElement('div');
      segmentCard.className = 'col-md-6 col-lg-4';
      
      const riskColor = segment.risk === 'high' ? 'danger' : segment.risk === 'medium' ? 'warning' : 'success';
      
      segmentCard.innerHTML = `
        <div class="card segment-card h-100" data-segment="${segment.id}">
          <div class="segment-size badge bg-secondary">${segment.size} pesakit</div>
          <div class="card-body">
            <h6 class="card-title">${segment.name}</h6>
            <p class="card-text small">${segment.description}</p>
            <div class="d-flex justify-content-between align-items-center">
              <span class="badge bg-${riskColor}">Risiko: ${segment.risk === 'high' ? 'Tinggi' : segment.risk === 'medium' ? 'Sederhana' : 'Rendah'}</span>
              <span class="badge bg-primary">Nilai: RM ${segment.value}</span>
            </div>
          </div>
        </div>
      `;
      
      container.appendChild(segmentCard);
    });
    
    // Load personas
    loadPersonas(r.segments);
    
    // Load segment potential chart
    loadSegmentPotential(r.segments);
  } catch (e) {
    console.error('Error loading segments:', e);
    $('#patientSegments').innerHTML = `<div class="alert alert-danger">Ralat: ${e.message}</div>`;
  }
}

function loadPersonas(segments) {
  const container = $('#patientPersonas');
  container.innerHTML = '';
  
  segments.forEach((segment, i) => {
    if (i >= 4) return; // Limit to 4 personas
    
    const personaCard = document.createElement('div');
    personaCard.className = 'col-md-6';
    
    const avatarIcon = segment.avatar || 'person';
    
    personaCard.innerHTML = `
      <div class="card persona-card">
        <div class="persona-avatar">
          <i class="bi bi-${avatarIcon}"></i>
        </div>
        <h6>${segment.persona_name}</h6>
        <p class="small text-muted">${segment.persona_description}</p>
        <div class="mt-2">
          <small class="text-muted">Demografi: ${segment.demographics}</small><br>
          <small class="text-muted">Keperluan: ${segment.needs}</small>
        </div>
      </div>
    `;
    
    container.appendChild(personaCard);
  });
}

function loadSegmentPotential(segments) {
  const ctx = $('#chartSegmentPotential');
  if (segmentPotentialChart) segmentPotentialChart.destroy();
  
  segmentPotentialChart = new Chart(ctx, {
    type: 'radar',
    data: {
      labels: segments.map(s => s.name),
      datasets: [{
        label: 'Potensi Pemasaran',
        data: segments.map(s => s.potential),
        backgroundColor: 'rgba(13, 110, 253, 0.2)',
        borderColor: 'rgba(13, 110, 253, 1)',
        pointBackgroundColor: 'rgba(13, 110, 253, 1)',
        pointBorderColor: '#fff',
        pointHoverBackgroundColor: '#fff',
        pointHoverBorderColor: 'rgba(13, 110, 253, 1)'
      }, {
        label: 'Nilai Semasa',
        data: segments.map(s => s.value),
        backgroundColor: 'rgba(25, 135, 84, 0.2)',
        borderColor: 'rgba(25, 135, 84, 1)',
        pointBackgroundColor: 'rgba(25, 135, 84, 1)',
        pointBorderColor: '#fff',
        pointHoverBackgroundColor: '#fff',
        pointHoverBorderColor: 'rgba(25, 135, 84, 1)'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      elements: {
        line: {
          borderWidth: 2
        }
      }
    }
  });
}

/************ CAMPAIGN BUILDER ************/
async function loadCampaigns() {
  try {
    const r = await callAPI('campaign_list');
    
    const container = $('#campaignList');
    container.innerHTML = '';
    
    r.campaigns.forEach((campaign, i) => {
      const statusClass = campaign.status === 'active' ? 'success' : campaign.status === 'scheduled' ? 'warning' : 'secondary';
      const statusText = campaign.status === 'active' ? 'Aktif' : campaign.status === 'scheduled' ? 'Dijadualkan' : 'Selesai';
      
      const campaignCard = document.createElement('div');
      campaignCard.className = 'col-md-6 col-lg-4';
      
      campaignCard.innerHTML = `
        <div class="card campaign-card h-100">
          <div class="campaign-status">
            <span class="badge bg-${statusClass}">${statusText}</span>
          </div>
          <div class="card-body">
            <h6 class="card-title">${campaign.name}</h6>
            <p class="card-text small">${campaign.description}</p>
            <div class="d-flex justify-content-between align-items-center mt-2">
              <small class="text-muted">Jenis: ${campaign.type}</small>
              <small class="text-muted">Sasaran: ${campaign.segment}</small>
            </div>
            <div class="mt-2">
              <div class="progress" style="height: 5px;">
                <div class="progress-bar bg-primary" style="width: ${campaign.progress || 0}%"></div>
              </div>
              <small class="text-muted">${campaign.sent || 0} hantaran, ${campaign.opened || 0} dibuka</small>
            </div>
            <div class="mt-2 d-flex justify-content-between">
              <small class="${campaign.roi > 0 ? 'roi-positive' : campaign.roi < 0 ? 'roi-negative' : 'roi-neutral'}">ROI: ${campaign.roi > 0 ? '+' : ''}${campaign.roi}%</small>
              <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-primary btn-sm" onclick="viewCampaignDetails('${campaign.id}')">
                  <i class="bi bi-eye"></i>
                </button>
                <button class="btn btn-outline-secondary btn-sm" onclick="editCampaign('${campaign.id}')">
                  <i class="bi bi-pencil"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      container.appendChild(campaignCard);
    });
    
    // Load campaign ROI chart
    loadCampaignROI(r.campaigns);
  } catch (e) {
    console.error('Error loading campaigns:', e);
    $('#campaignList').innerHTML = `<div class="alert alert-danger">Ralat: ${e.message}</div>`;
  }
}

function loadCampaignROI(campaigns) {
  const ctx = $('#chartCampaignROI');
  if (campaignRoiChart) campaignRoiChart.destroy();
  
  campaignRoiChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: campaigns.map(c => c.name),
      datasets: [{
        label: 'ROI (%)',
        data: campaigns.map(c => c.roi),
        backgroundColor: campaigns.map(c => c.roi > 0 ? 'rgba(25, 135, 84, 0.7)' : c.roi < 0 ? 'rgba(220, 53, 69, 0.7)' : 'rgba(108, 117, 125, 0.7)'),
        borderColor: campaigns.map(c => c.roi > 0 ? 'rgba(25, 135, 84, 1)' : c.roi < 0 ? 'rgba(220, 53, 69, 1)' : 'rgba(108, 117, 125, 1)'),
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'ROI (%)'
          }
        }
      }
    }
  });
}

function saveCampaign() {
  const formData = {
    name: document.querySelector('#campaignName').value,
    type: document.querySelector('#campaignType').value,
    segment: document.querySelector('#campaignSegment').value,
    message: document.querySelector('#campaignMessage').value,
    start_date: document.querySelector('#campaignStartDate').value,
    end_date: document.querySelector('#campaignEndDate').value
  };
  
  if (!formData.name || !formData.type || !formData.segment || !formData.message) {
    alert('Sila lengkapkan semua medan wajib');
    return;
  }
  
  try {
    const result = callAPI('campaign_create', formData);
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('campaignModal'));
    modal.hide();
    
    // Reset form
    document.querySelector('#campaignForm').reset();
    
    // Reload campaigns
    loadCampaigns();
    
    Toast.show('Kempen berjaya dicipta');
  } catch (e) {
    console.error('Error saving campaign:', e);
    alert('Gagal mencipta kempen: ' + e.message);
  }
}

function viewCampaignDetails(campaignId) {
  // Implementation for viewing campaign details
  console.log('View campaign details:', campaignId);
}

function editCampaign(campaignId) {
  // Implementation for editing campaign
  console.log('Edit campaign:', campaignId);
}

/************ GEOSPATIAL ANALYSIS ************/
let geoMapInstance = null;

async function loadGeoHeatmap(type = 'patients') {
  try {
    const r = await callAPI('geospatial_analysis', { type });
    
    // Initialize map if not already created
    if (!geoMapInstance) {
      geoMapInstance = L.map('geoHeatmap').setView([4.2105, 101.9758], 11); // Center of Malaysia
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(geoMapInstance);
    }
    
    // Clear existing markers
    geoMapInstance.eachLayer(layer => {
      if (layer instanceof L.Marker) {
        geoMapInstance.removeLayer(layer);
      }
    });
    
    // Add new markers
    r.points.forEach(point => {
      const color = type === 'patients' ? '#0d6efd' : 
                   type === 'diseases' ? '#dc3545' : '#198754';
      
      const marker = L.circleMarker([point.lat, point.lng], {
        radius: Math.sqrt(point.value) * 100,
        fillColor: color,
        color: color,
        weight: 1,
        opacity: 0.7
      }).addTo(geoMapInstance);
      
      marker.bindPopup(`
        <strong>${point.name || 'Lokasi'}</strong><br>
        Nilai: ${point.value}<br>
        ${point.details || ''}
      `);
    });
    
    // Load hotspots
    loadHotspots(r.hotspots);
    
    // Load event locations
    loadEventLocations(r.event_locations);
  } catch (e) {
    console.error('Error loading geo heatmap:', e);
    $('#geoHeatmap').innerHTML = `<div class="alert alert-danger">Ralat: ${e.message}</div>`;
  }
}

function loadHotspots(hotspots) {
  const container = $('#hotspotAreas');
  container.innerHTML = '';
  
  if (!hotspots || !hotspots.length) {
    container.innerHTML = '<div class="list-group-item">Tiada kawasan panas ditemui.</div>';
    return;
  }
  
  hotspots.forEach((hotspot, i) => {
    const item = document.createElement('div');
    item.className = 'list-group-item';
    
    item.innerHTML = `
      <div class="d-flex w-100 justify-content-between">
        <h6 class="mb-1">${hotspot.name}</h6>
        <small class="text-muted">${hotspot.count} pesakit</small>
      </div>
      <p class="mb-1">${hotspot.description}</p>
      <div class="progress" style="height: 5px;">
        <div class="progress-bar bg-danger" style="width: ${hotspot.density}%"></div>
      </div>
    `;
    
    container.appendChild(item);
  });
}

function loadEventLocations(locations) {
  const container = $('#eventLocations');
  container.innerHTML = '';
  
  if (!locations || !locations.length) {
    container.innerHTML = '<div class="list-group-item">Tiada lokasi sesuai ditemui.</div>';
    return;
  }
  
  locations.forEach((location, i) => {
    const item = document.createElement('div');
    item.className = 'list-group-item';
    
    item.innerHTML = `
      <div class="d-flex w-100 justify-content-between">
        <h6 class="mb-1">${location.name}</h6>
        <small class="text-muted">Potensi: ${location.potential}</small>
      </div>
      <p class="mb-1">${location.description}</p>
      <div class="d-flex justify-content-between">
        <small class="text-muted">Jangkaan hadirin: ${location.expected_attendees}</small>
        <button class="btn btn-sm btn-outline-primary" onclick="suggestEventLocation('${location.id}')">
          <i class="bi bi-geo-alt"></i> Pilih
        </button>
      </div>
    `;
    
    container.appendChild(item);
  });
}

function suggestEventLocation(locationId) {
  // Implementation for suggesting event location
  console.log('Suggest event location:', locationId);
}

// Initialize tabs event listeners
document.addEventListener('DOMContentLoaded', function() {
  const triggerTabList = [].slice.call(document.querySelectorAll('#tabs button'));
  triggerTabList.forEach(function(triggerEl) {
    triggerEl.addEventListener('shown.bs.tab', function (event) {
      // Load data for the active tab
      const targetId = event.target.getAttribute('data-bs-target');
      
      if (targetId === '#tab-predictive') {
        loadPredictions();
        loadPLV();
        loadConversion();
        loadChurnRisk();
      } else if (targetId === '#tab-journey') {
        // Load patient list for journey mapping
        loadPatientListForJourney();
      } else if (targetId === '#tab-segmentation') {
        loadSegments();
      } else if (targetId === '#tab-campaigns') {
        loadCampaigns();
      } else if (targetId === '#tab-geo') {
        loadGeoHeatmap();
      }
    });
  });
});

function loadPatientListForJourney() {
  // Load patients for journey mapping dropdown
  try {
    // This would be implemented with an API call
    // For now, we'll use a placeholder
    const select = document.querySelector('#journeyPatient');
    select.innerHTML = '<option value="">Pilih pesakit</option>';
    
    // Add some placeholder options
    const placeholderPatients = [
      { id: '1', name: 'Ahmad bin Ismail' },
      { id: '2', name: 'Siti Aminah binti Abdullah' },
      { id: '3', name: 'Mohamed bin Hassan' }
    ];
    
    placeholderPatients.forEach(patient => {
      const option = document.createElement('option');
      option.value = patient.id;
      option.textContent = patient.name;
      select.appendChild(option);
    });
  } catch (e) {
    console.error('Error loading patient list for journey:', e);
  }
}
</script>

<!-- Bootstrap JS (defer) -->
<script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
