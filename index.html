<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Clinic Marketing Dashboard</title>

  <!-- CSP: sesuai untuk GitHub Pages + GIS + Apps Script -->
  <meta http-equiv="Content-Security-Policy"
        content="
          default-src 'none';
          script-src 'self' 'unsafe-inline' https://accounts.google.com https://accounts.gstatic.com https://cdn.jsdelivr.net;
          connect-src https://script.google.com https://script.googleusercontent.com https://cdn.jsdelivr.net;
          style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://accounts.google.com;
          img-src 'self' data:;
          font-src 'self' https://cdn.jsdelivr.net;
          frame-src https://accounts.google.com;
          base-uri 'none'; form-action 'none';
        " />
  <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin-allow-popups" />
  <meta name="referrer" content="no-referrer" />

  <!-- UI libs -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    :root{ --bg:#fff; --text:#111827; --muted:#6b7280; --card:#fff; --border:#e5e7eb; }
    body{ background:var(--bg); color:var(--text); }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; }
    .muted{ color:var(--muted); }
    .hidden{ display:none !important; }
  </style>

  <!-- ==== KONFIG GLOBAL (EDIT DI SINI) ==== -->
  <script>
    // Pastikan dua nilai ini benar-benar kepunyaan anda:
    window.CLIENT_ID = '366415747851-9p6fegh84hkfs74prtmtj09ldsp2vi3m.apps.googleusercontent.com';
    window.BACKEND_URL = 'https://script.google.com/macros/s/AKfycbxkmVWcorPPwWmIXN-lFPJ8wucqyKgqwrfiD4ZBqRYl1gKOcRoM7oXNzSO_XPLYZ8CL/exec';
  </script>
</head>
<body>
<div class="container py-4">

  <!-- Header -->
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h3 class="mb-1">Clinic Marketing Dashboard</h3>
      <div class="muted">Ringkasan kategori & outreach — tanpa PII di UI awam</div>
    </div>
    <div class="d-flex align-items-center gap-2">
      <span id="whoami" class="muted small">Belum log masuk</span>
      <button id="btnSignOut" class="btn btn-outline-secondary btn-sm hidden"><i class="bi bi-box-arrow-right"></i> Keluar</button>
    </div>
  </div>

  <!-- Sign-in Gate -->
  <div id="signinCard" class="card p-4 mb-4 text-center">
    <h5 class="mb-2">Akses Terhad</h5>
    <p class="muted mb-3">Log masuk dengan akaun Google staf klinik.</p>
    <div id="gsiBtn" class="d-inline-block"></div>
    <div id="signinMsg" class="small text-danger mt-3"></div>
    <div class="small muted mt-2">Origin halaman: <code id="originTxt"></code></div>
    <div class="small muted">Client ID: <code id="cidTxt"></code></div>
  </div>

  <!-- App -->
  <div id="app" class="hidden">

    <!-- Kawal tarikh & filter ringkas -->
    <div class="card p-3 mb-3">
      <div class="row g-2">
        <div class="col-12 col-md-3">
          <label class="form-label">Mula</label>
          <input type="date" id="startDate" class="form-control">
        </div>
        <div class="col-12 col-md-3">
          <label class="form-label">Tamat</label>
          <input type="date" id="endDate" class="form-control">
        </div>
        <div class="col-12 col-md-3">
          <label class="form-label">Diagnosis (kod)</label>
          <input type="text" id="diagCode" class="form-control" placeholder="URTI">
        </div>
        <div class="col-12 col-md-3">
          <label class="form-label">Kawasan</label>
          <input type="text" id="area" class="form-control" placeholder="Kajang / Manir">
        </div>
      </div>

      <div class="d-flex flex-wrap gap-2 mt-3">
        <button id="btnToday"     class="btn btn-outline-secondary btn-sm">Hari ini</button>
        <button id="btnMonth"     class="btn btn-outline-secondary btn-sm">Bulan ini</button>
        <button id="btnYear"      class="btn btn-outline-secondary btn-sm">Tahun ini</button>

        <button id="btnSync"      class="btn btn-warning btn-sm"><i class="bi bi-arrow-down-up"></i> Sync (Yezza→Sheet)</button>
        <button id="btnAggregate" class="btn btn-primary btn-sm"><i class="bi bi-clipboard2-data"></i> Kira Agregat</button>
        <button id="btnLoad"      class="btn btn-success btn-sm"><i class="bi bi-people"></i> Muat Pesakit (ditapis)</button>
        <button id="btnExport"    class="btn btn-outline-secondary btn-sm"><i class="bi bi-download"></i> Export CSV</button>
      </div>

      <div id="status" class="small muted mt-2">Sedia.</div>
    </div>

    <!-- KPI ringkas -->
    <div class="row g-3 mb-3">
      <div class="col-12 col-md-3">
        <div class="card p-3 h-100">
          <div class="muted small">Labeled</div>
          <div id="kpiLabeled" class="h3 mb-0">-</div>
          <div class="muted small">Lawatan dipadankan ≥ 1 kategori</div>
        </div>
      </div>
      <div class="col-12 col-md-3">
        <div class="card p-3 h-100">
          <div class="muted small">Kategori</div>
          <div id="kpiCategories" class="h3 mb-0">-</div>
          <div class="muted small">Bilangan kategori</div>
        </div>
      </div>
      <div class="col-12 col-md-3">
        <div class="card p-3 h-100">
          <div class="muted small">Top</div>
          <div id="kpiTop" class="h6 mb-0">-</div>
          <div class="muted small">Kategori dominan</div>
        </div>
      </div>
      <div class="col-12 col-md-3">
        <div class="card p-3 h-100">
          <div class="muted small">Prospek Outreach</div>
          <div id="kpiProspect" class="h3 mb-0">0</div>
          <div class="muted small">Pesakit ditapis</div>
        </div>
      </div>
    </div>

    <!-- Carta -->
    <div class="row g-3 mb-4">
      <div class="col-12 col-xl-6">
        <div class="card p-3">
          <div class="d-flex justify-content-between">
            <h5 class="mb-0">Peratus Mengikut Kategori</h5>
            <span id="legend1" class="muted small">—</span>
          </div>
          <canvas id="chartDonut" height="240"></canvas>
        </div>
      </div>
      <div class="col-12 col-xl-6">
        <div class="card p-3">
          <div class="d-flex justify-content-between">
            <h5 class="mb-0">Top Kategori (Kiraan)</h5>
            <span id="legend2" class="muted small">—</span>
          </div>
          <canvas id="chartBar" height="240"></canvas>
        </div>
      </div>
    </div>

    <!-- Jadual pesakit -->
    <div class="card p-3">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Senarai Pesakit (ditapis)</h5>
        <span id="patientInfo" class="muted small">Jumlah: 0</span>
      </div>
      <div class="table-responsive mt-2">
        <table class="table table-striped align-middle">
          <thead><tr>
            <th>Nama</th><th>Umur</th><th>Diagnose</th><th>Kod</th><th>Kawasan</th><th>Tarikh</th><th>Telefon</th>
          </tr></thead>
          <tbody id="tblBody"></tbody>
        </table>
      </div>
    </div>

  </div><!-- /#app -->
</div>

<script>
/* ====== UTIL ====== */
const $ = (q) => document.querySelector(q);
const fmt = (d) => d ? new Date(d).toISOString().slice(0,10) : '';
function setStatus(s){ $('#status').textContent = s; }
function shortText(t){ if(!t) return ''; const x=t.replace(/<br\s*\/?>/gi,' ').trim(); return x.length>70? x.slice(0,70)+'…' : x; }
function shortArea(a){ if(!a) return ''; const low=a.toLowerCase(); const parts=low.split(/[,|]/).map(s=>s.trim()).filter(Boolean); return parts.slice(0,2).join(', '); }

/* ====== STATE ====== */
let ID_TOKEN = null;
let donutChart = null, barChart = null;
let patients = [];

/* ====== GIS INIT ====== */
window.addEventListener('load', () => {
  // papar origin & client id untuk debug pantas
  $('#originTxt').textContent = location.origin;
  $('#cidTxt').textContent = window.CLIENT_ID || '(tiada)';

  if (!window.google || !google.accounts || !google.accounts.id) {
    $('#signinMsg').textContent = 'Gagal memuatkan Google Sign-In (GIS). Semak internet/CSP.';
    return;
  }

  // Tarikh lalai = bulan ini
  const d=new Date(), s=new Date(d.getFullYear(), d.getMonth(), 1), e=new Date(d.getFullYear(), d.getMonth()+1, 0);
  $('#startDate').value = fmt(s);
  $('#endDate').value   = fmt(e);

  // Butang cepat
  $('#btnToday').onclick = ()=>{ const t=new Date(); $('#startDate').value=fmt(t); $('#endDate').value=fmt(t); };
  $('#btnMonth').onclick = ()=>{ const d=new Date(), s=new Date(d.getFullYear(), d.getMonth(), 1), e=new Date(d.getFullYear(), d.getMonth()+1, 0); $('#startDate').value=fmt(s); $('#endDate').value=fmt(e); };
  $('#btnYear').onclick  = ()=>{ const d=new Date(), s=new Date(d.getFullYear(),0,1), e=new Date(d.getFullYear(),11,31); $('#startDate').value=fmt(s); $('#endDate').value=fmt(e); };

  // Actions
  $('#btnSignOut').onclick = ()=>location.reload();
  $('#btnSync').onclick      = startSync;
  $('#btnAggregate').onclick = computeAggregate;
  $('#btnLoad').onclick      = loadPatients;
  $('#btnExport').onclick    = exportPatients;

  // GIS
  try{
    google.accounts.id.initialize({
      client_id: window.CLIENT_ID,
      callback: onSignIn,
      auto_select: false,
      ux_mode: 'popup',
      context: 'signin'
    });
    google.accounts.id.renderButton($('#gsiBtn'), { theme:'outline', size:'large', shape:'pill' });

    console.log('GIS initialised with CLIENT_ID =', window.CLIENT_ID, ' origin =', location.origin);
  }catch(err){
    $('#signinMsg').textContent = 'Ralat inisialisasi GIS. Semak Client ID & Origin di Google Cloud.';
    console.error(err);
  }
});

function onSignIn(resp){
  try{
    ID_TOKEN = resp.credential;
    $('#signinCard').classList.add('hidden');
    $('#app').classList.remove('hidden');
    $('#btnSignOut').classList.remove('hidden');
    $('#whoami').textContent = 'Log masuk berjaya';
    setStatus('Sedia.');
  }catch(e){
    $('#signinMsg').textContent = 'Log masuk gagal. Cuba lagi.';
    console.error(e);
  }
}

/* ====== BACKEND CALLER ====== */
async function callAPI(action, payload){
  if (!ID_TOKEN) throw new Error('Belum log masuk');
  const r = await fetch(window.BACKEND_URL, {
    method: 'POST',
    mode: 'cors',
    headers: { 'Content-Type': 'text/plain' },
    body: JSON.stringify({ action, id_token: ID_TOKEN, payload })
  });
  if (!r.ok){
    const txt = await r.text().catch(()=>String(r.status));
    throw new Error(txt || ('HTTP '+r.status));
  }
  return r.json();
}

/* ====== ACTIONS ====== */
async function startSync(){
  const start=$('#startDate').value, end=$('#endDate').value;
  if(!start||!end) return alert('Pilih tarikh mula & tamat.');
  setStatus('Memulakan sync…');
  try{
    const out = await callAPI('sync_range', { start, end });
    setStatus('Sync selesai. Rekod baharu: ' + (out.inserted||0));
  }catch(e){ setStatus('Ralat: ' + e.message); console.error(e); }
}

async function computeAggregate(){
  const start=$('#startDate').value, end=$('#endDate').value;
  if(!start||!end) return alert('Pilih tarikh mula & tamat.');
  setStatus('Mengira agregat…');
  try{
    const res = await callAPI('compute_aggregate', { start, end });
    const rows = res.rows || [];
    const labeled = res.labeled || 0;

    $('#kpiLabeled').textContent   = labeled;
    $('#kpiCategories').textContent= new Set(rows.map(x=>x[4])).size || 0;
    const top = rows.slice().sort((a,b)=>b[6]-a[6])[0];
    $('#kpiTop').textContent = top ? top[5] : '-';
    $('#legend1').textContent = `${res.start} → ${res.end}`;
    $('#legend2').textContent = `${res.start} → ${res.end}`;

    const list = rows.map(x=>({ code:x[4], name:x[5], count:x[6], pct:x[7] })).sort((a,b)=>b.count-a.count);
    drawDonut(list);
    drawBar(list.slice(0,10));

    setStatus('Agregat siap.');
  }catch(e){ setStatus('Ralat: ' + e.message); console.error(e); }
}

async function loadPatients(){
  const start=$('#startDate').value, end=$('#endDate').value;
  const code=$('#diagCode').value.trim(), area=$('#area').value.trim();
  if(!start||!end) return alert('Pilih tarikh mula & tamat.');
  setStatus('Memuat pesakit…');
  try{
    const r = await callAPI('list_patients', { start, end, code, area });
    patients = (r.items||[]).map(x=>({
      name:x.name||'', age:x.age||'', diag:shortText(x.diag||''), code:x.code||'',
      area:shortArea(x.area||''), date:x.date||'', phone:x.phone||''
    }));
    renderPatients();
    $('#kpiProspect').textContent = patients.length;
    setStatus('Siap memuat.');
  }catch(e){ setStatus('Ralat: ' + e.message); console.error(e); }
}

function renderPatients(){
  const tb = $('#tblBody'); tb.innerHTML='';
  patients.forEach(p=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${p.name}</td><td>${p.age}</td><td>${p.diag}</td><td>${p.code}</td><td>${p.area}</td><td>${p.date}</td><td>${p.phone}</td>`;
    tb.appendChild(tr);
  });
  $('#patientInfo').textContent = 'Jumlah: ' + patients.length;
}

function exportPatients(){
  if(!patients.length) return alert('Tiada data untuk dieksport.');
  const header=['name','age','diagnose','code','area','date','phone'];
  const rows = patients.map(p=>[p.name,p.age,p.diag,p.code,p.area,p.date,p.phone]);
  const csv = [header].concat(rows).map(r=>r.map(c=>String(c).replaceAll('"','""')).map(c=>`"${c}"`).join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv'}); const url = URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='patients_filtered.csv'; a.click(); URL.revokeObjectURL(url);
}

/* ====== CHARTS ====== */
function drawDonut(list){
  const ctx=document.getElementById('chartDonut');
  if (donutChart) donutChart.destroy();
  donutChart=new Chart(ctx,{ type:'doughnut', data:{ labels:list.map(d=>d.name), datasets:[{ data:list.map(d=>d.pct) }] },
    options:{ plugins:{ legend:{ position:'bottom' } }, cutout:'60%' }});
}
function drawBar(list){
  const ctx=document.getElementById('chartBar');
  if (barChart) barChart.destroy();
  barChart=new Chart(ctx,{ type:'bar', data:{ labels:list.map(d=>d.name), datasets:[{ data:list.map(d=>d.count) }] },
    options:{ plugins:{ legend:{ display:false }}}});
}
</script>
</body>
</html>
