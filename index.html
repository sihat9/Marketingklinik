<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- CSP: benarkan CDN penting + Apps Script + GIS; guna nonce untuk skrip inline -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'none';
                 script-src 'self' 'nonce-xyz123' https://accounts.google.com https://accounts.gstatic.com https://cdn.jsdelivr.net https://unpkg.com;
                 style-src  'self' 'unsafe-inline' https://cdn.jsdelivr.net https://unpkg.com;
                 img-src    'self' data:;
                 font-src   'self' https://cdn.jsdelivr.net https://fonts.gstatic.com;
                 connect-src https://script.google.com https://script.googleusercontent.com https://cdn.jsdelivr.net https://unpkg.com data: blob:;
                 frame-src  https://accounts.google.com;
                 base-uri 'none'; form-action 'none';" />

  <title>Clinic Marketing Dashboard</title>
  <meta name="referrer" content="no-referrer" />
  <meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=(), autoplay=(), fullscreen=()" />

  <!-- Bootstrap 5 -->
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- Bootstrap Icons (optional) -->
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
        crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"
          crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <!-- GIS -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <!-- Bootstrap JS bundle (optional, untuk komponen interaktif) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
          crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <style>
    :root{
      --card: #ffffff; --border:#e5e7eb; --muted:#6b7280; --brand:#0d6efd; --bg:#f7f8fa;
    }
    html, body { height:100%; }
    body{ background:var(--bg); }
    .brand { font-weight:800; letter-spacing:.2px; }
    .muted { color:var(--muted); }
    .card { border-radius:16px; border:1px solid var(--border); }
    .chip {
      display:inline-flex; align-items:center; gap:.5rem;
      background:#f3f4f6; border:1px solid var(--border); border-radius:999px;
      padding:.35rem .75rem; font-size:.9rem;
    }
    .hidden{ display:none !important; }
    .table thead th{ background:#f8fafc; }
  </style>
</head>
<body>
  <div class="container py-4">
    <!-- Header -->
    <div class="d-flex flex-wrap align-items-center justify-content-between mb-3">
      <div>
        <div class="brand h3 mb-1">Clinic Marketing Dashboard</div>
        <div class="muted">Ringkasan kategori & outreach — tanpa PII di UI awam</div>
      </div>
      <div class="d-flex align-items-center gap-2">
        <span id="whoami" class="small muted">Signed-in: -</span>
        <button id="btnSignOut" class="btn btn-outline-secondary btn-sm hidden">
          <i class="bi bi-box-arrow-right"></i> Keluar
        </button>
      </div>
    </div>

    <!-- Toolbar -->
    <div class="card p-3 mb-3">
      <div class="row g-2 align-items-end">
        <div class="col-12 col-md-3">
          <label class="form-label">Mula</label>
          <input type="date" id="startDate" class="form-control" />
        </div>
        <div class="col-12 col-md-3">
          <label class="form-label">Tamat</label>
          <input type="date" id="endDate" class="form-control" />
        </div>
        <div class="col-12 col-md-3">
          <label class="form-label">Diagnosis (kod)</label>
          <input type="text" id="dxCode" class="form-control" placeholder="cth: URTI" />
        </div>
        <div class="col-12 col-md-3">
          <label class="form-label">Kawasan / Alamat</label>
          <input type="text" id="area" class="form-control" placeholder="cth: Manir" />
        </div>

        <div class="col-12 mt-2 d-flex flex-wrap gap-2">
          <button id="btnSync" class="btn btn-warning">
            <i class="bi bi-arrow-repeat"></i> Sync (Yezza→Sheet)
          </button>
          <button id="btnLoad" class="btn btn-primary">
            <i class="bi bi-clipboard2-data"></i> Tapis & Muat
          </button>
          <button id="btnClear" class="btn btn-outline-secondary">
            <i class="bi bi-eraser"></i> Bersih
          </button>
          <button id="btnExport" class="btn btn-outline-success ms-auto">
            <i class="bi bi-download"></i> Export CSV (Ditapis)
          </button>
        </div>

        <div class="col-12">
          <small id="status" class="muted">-</small>
        </div>
      </div>
    </div>

    <!-- KPIs -->
    <div class="row g-3 mb-3">
      <div class="col-12 col-md-3">
        <div class="card p-3 h-100">
          <div class="chip">Labeled</div>
          <div class="h4 mt-2 mb-0" id="kpiLabeled">-</div>
          <div class="muted small">Lawatan dipadankan ≥ 1 kategori</div>
        </div>
      </div>
      <div class="col-12 col-md-3">
        <div class="card p-3 h-100">
          <div class="chip">Kategori</div>
          <div class="h4 mt-2 mb-0" id="kpiCats">-</div>
          <div class="muted small">Bilangan kategori dikesan</div>
        </div>
      </div>
      <div class="col-12 col-md-3">
        <div class="card p-3 h-100">
          <div class="chip">Top</div>
          <div class="h6 mt-2 mb-0" id="kpiTop">-</div>
          <div class="muted small">Kategori paling dominan</div>
        </div>
      </div>
      <div class="col-12 col-md-3">
        <div class="card p-3 h-100">
          <div class="chip">Prospek Outreach</div>
          <div class="h4 mt-2 mb-0" id="kpiProspects">0</div>
          <div class="muted small">Pesakit ditapis (jadual di bawah)</div>
        </div>
      </div>
    </div>

    <!-- Charts -->
    <div class="row g-3 mb-3">
      <div class="col-12 col-xl-6">
        <div class="card p-3">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Peratus Mengikut Kategori</h5>
            <span class="small muted" id="range1">-</span>
          </div>
          <canvas id="chartDonut" height="260"></canvas>
        </div>
      </div>
      <div class="col-12 col-xl-6">
        <div class="card p-3">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Top Kategori (Kiraan)</h5>
            <span class="small muted" id="range2">-</span>
          </div>
          <canvas id="chartBar" height="260"></canvas>
        </div>
      </div>
    </div>

    <!-- Patients table -->
    <div class="card p-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0">Senarai Pesakit (ditapis)</h5>
        <div class="d-flex align-items-center gap-2">
          <label class="small">Saiz halaman</label>
          <select id="pageSize" class="form-select form-select-sm" style="width:110px">
            <option>25</option><option selected>100</option><option>200</option>
          </select>
        </div>
      </div>
      <div class="table-responsive">
        <table class="table table-striped align-middle" id="tbl">
          <thead>
            <tr>
              <th style="width:60px;">#</th>
              <th>Nama</th>
              <th style="width:90px;">Umur</th>
              <th>Diagnose</th>
              <th>Kawasan</th>
              <th style="width:160px;">Tarikh</th>
              <th style="width:140px;">Telefon</th>
              <th style="width:120px;">WhatsApp</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="d-flex justify-content-end gap-2">
        <button class="btn btn-outline-secondary btn-sm" id="btnPrev">Sebelum</button>
        <button class="btn btn-outline-secondary btn-sm" id="btnNext">Seterusnya</button>
      </div>
    </div>

    <footer class="text-center muted small mt-4">
      © Klinik — Private console. Pastikan consent pesakit untuk sebarang outreach.
    </footer>
  </div>

  <!-- ======= APP SCRIPT (inline, dibenarkan oleh nonce) ======= -->
  <script nonce="xyz123">
    /*** KONFIG — GANTIKAN NILAI DI SINI ***/
    const CLIENT_ID   = '366415747851-9p6fegh84hkfs74prtmtj09ldsp2vi3m.apps.googleusercontent.com'; // <-- Ganti
    const BACKEND_URL = 'https://script.google.com/macros/s/AKfycby1A1DrDRsoW3CP9tDI1EMdLzVBaCeubhT5HOaFLQQtQ3K7GEYbgows-WgGLSQV71fX/exec'; // <-- Ganti (akhiri dengan /exec)

    /*** STATE ***/
    let ID_TOKEN = null;
    let donutChart, barChart;
    let patients = []; // hasil semasa
    let page = 0;

    /*** HELPERS ***/
    const $ = (q) => document.querySelector(q);
    const show = (el) => el.classList.remove('hidden');
    const hide = (el) => el.classList.add('hidden');
    const fmtPeriod = (s,e) => `${s} → ${e}`;

    function setNowMonth() {
      const d = new Date();
      const s = new Date(d.getFullYear(), d.getMonth(), 1);
      const e = new Date(d.getFullYear(), d.getMonth()+1, 0);
      $('#startDate').value = s.toISOString().slice(0,10);
      $('#endDate').value   = e.toISOString().slice(0,10);
    }

    /*** GIS ***/
    window.onload = () => {
      setNowMonth();

      if (!window.google || !google.accounts || !google.accounts.id) {
        $('#status').textContent = 'Ralat memuatkan Google Sign-In.';
        return;
      }
      google.accounts.id.initialize({
        client_id: CLIENT_ID,
        callback: onSignIn,
        auto_select: false,
        ux_mode: 'popup',
        context: 'signin'
      });
      google.accounts.id.renderButton(document.body.appendChild(document.createElement('div')), { theme:'outline', size:'large', shape:'pill' });
      $('#btnSignOut').addEventListener('click', signOut);

      // Actions
      $('#btnSync').addEventListener('click', startSync);
      $('#btnLoad').addEventListener('click', loadAll);
      $('#btnClear').addEventListener('click', () => { $('#dxCode').value=''; $('#area').value=''; $('#status').textContent='Dibersihkan.'; });
      $('#btnExport').addEventListener('click', exportCSV);
      $('#btnPrev').addEventListener('click', ()=>{ if(page>0){page--; renderTable();}});
      $('#btnNext').addEventListener('click', ()=>{ if((page+1)*pageSize()<patients.length){page++; renderTable();}});
      $('#pageSize').addEventListener('change', ()=>{ page=0; renderTable(); });
    };

    function onSignIn(resp){
      try {
        ID_TOKEN = resp.credential;
        $('#whoami').textContent = 'Signed-in';
        $('#status').textContent = 'Log masuk berjaya.';
        $('#btnSignOut').classList.remove('hidden');
        // Muat ringkasan awal
        loadAll();
      } catch(e){
        $('#status').textContent = 'Log masuk gagal.';
        console.error(e);
      }
    }
    function signOut(){ ID_TOKEN = null; location.reload(); }

    /*** BACKEND caller ***/
    async function callAPI(action, payload){
      if (!ID_TOKEN) throw new Error('Belum log masuk');
      const res = await fetch(BACKEND_URL, {
        method:'POST', mode:'cors', credentials:'omit',
        headers:{ 'Content-Type': 'text/plain' }, // elak preflight
        body: JSON.stringify({ action, id_token: ID_TOKEN, payload })
      });
      if (!res.ok){
        const t = await res.text();
        throw new Error('API ' + res.status + ': ' + t);
      }
      return res.json();
    }

    /*** PIPELINES ***/
    async function loadAll(){
      const s = $('#startDate').value, e = $('#endDate').value;
      const dx = $('#dxCode').value.trim(), ar = $('#area').value.trim();
      if (!s || !e) { alert('Sila pilih tarikh mula & tamat.'); return; }

      try{
        $('#status').textContent = 'Memuat ringkasan…';
        const sum = await callAPI('summary', { start:s, end:e });
        setKPIs(sum);
        const list = toUIRows(sum.rows).sort((a,b)=>b.count-a.count);
        drawDonut(list);
        drawBar(list.slice(0,10));
        $('#range1').textContent = fmtPeriod(sum.start,sum.end);
        $('#range2').textContent = fmtPeriod(sum.start,sum.end);
        $('#status').textContent = 'Ringkasan siap. Memuat pesakit…';

        const resp = await callAPI('patients', { start:s, end:e, dx: dx || null, area: ar || null, page:1, pageSize:1000 });
        patients = (resp.items || []).map(p => ({
          name: p.name || p.patient_name || '-',
          age:  p.age || '',
          dx:   p.dx_short || p.diagnose || p.diagnosis || '',
          area: p.area || '',
          date: p.visit_date || p.date || '',
          phone: p.phone || '',
        }));
        page = 0;
        renderTable();
        $('#status').textContent = `Selesai. Jumlah prospek: ${patients.length}.`;
        $('#kpiProspects').textContent = patients.length || 0;
      } catch(err){
        $('#status').textContent = 'Ralat: ' + err.message;
        console.error(err);
      }
    }

    async function startSync(){
      const s = $('#startDate').value, e = $('#endDate').value;
      if (!s || !e) { alert('Sila pilih tarikh mula & tamat.'); return; }
      $('#status').textContent = 'Memulakan sync…';
      try{
        const r = await callAPI('sync_range', { start:s, end:e });
        $('#status').textContent = `Sync siap: tulis ${r.written||0} baris. Memuat semula ringkasan…`;
        await loadAll();
      }catch(err){
        $('#status').textContent = 'Ralat sync: ' + err.message;
        console.error(err);
      }
    }

    /*** RENDER ***/
    function setKPIs(summary){
      const totalLabeled = summary.labeled || 0;
      const cats = new Set((summary.rows||[]).map(r=>r[4])).size;
      const top = (summary.rows||[]).slice().sort((a,b)=>b[6]-a[6])[0];
      $('#kpiLabeled').textContent = totalLabeled;
      $('#kpiCats').textContent = cats;
      $('#kpiTop').textContent = top ? top[5] : '-';
    }
    function toUIRows(rows){ return (rows||[]).map(r=>({ code:r[4], name:r[5], count:r[6], pct:r[7] })); }

    function drawDonut(list){
      const ctx = document.getElementById('chartDonut');
      const labels=list.map(d=>d.name), values=list.map(d=>d.pct);
      if (donutChart) donutChart.destroy();
      donutChart = new Chart(ctx,{
        type:'doughnut',
        data:{ labels, datasets:[{ data: values }] },
        options:{ plugins:{ legend:{ position:'bottom' }, tooltip:{ callbacks:{ label:(c)=>`${c.label}: ${c.raw}%` } } }, cutout:'60%' }
      });
    }
    function drawBar(list){
      const ctx = document.getElementById('chartBar');
      const labels=list.map(d=>d.name), values=list.map(d=>d.count);
      if (barChart) barChart.destroy();
      barChart = new Chart(ctx,{
        type:'bar',
        data:{ labels, datasets:[{ data: values }] },
        options:{ plugins:{ legend:{ display:false } }, scales:{ x:{ ticks:{} }, y:{ ticks:{} } } }
      });
    }

    function pageSize(){ return parseInt($('#pageSize').value,10) || 100; }
    function renderTable(){
      const tbody = $('#tbl tbody');
      tbody.innerHTML = '';
      const ps = pageSize();
      const start = page * ps;
      const pageRows = patients.slice(start, start+ps);
      pageRows.forEach((p,i)=>{
        const tr = document.createElement('tr');
        const wa = p.phone ? `<a class="btn btn-success btn-sm" target="_blank" rel="noopener" href="https://wa.me/${encodeURIComponent(p.phone)}?text=${encodeURIComponent('Assalamualaikum. Pihak klinik ingin berkongsi info kesihatan berkaitan ' + (p.dx||'kesihatan') + '.') }"><i class="bi bi-whatsapp"></i> Chat</a>` : '';
        tr.innerHTML = `
          <td>${start+i+1}</td>
          <td>${escapeHtml(p.name)}</td>
          <td>${p.age || ''}</td>
          <td>${escapeHtml(p.dx || '')}</td>
          <td>${escapeHtml(p.area || '')}</td>
          <td>${escapeHtml(p.date || '')}</td>
          <td>${escapeHtml(p.phone || '')}</td>
          <td>${wa}</td>`;
        tbody.appendChild(tr);
      });
    }

    function escapeHtml(s){ return (s||'').toString().replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[m])); }

    /*** EXPORT ***/
    function exportCSV(){
      const header = ['name','age','diagnose','area','date','phone'];
      const rows = patients.map(p=>[p.name,p.age,p.dx,p.area,p.date,p.phone]);
      const csv = [header].concat(rows).map(r=>r.map(cell=>{
        const v = (cell==null?'':String(cell));
        return /[",\n]/.test(v) ? `"${v.replace(/"/g,'""')}"` : v;
      }).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='patients_filtered.csv'; a.click(); URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
