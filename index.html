<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Clinic Marketing Dashboard</title>

  <!-- CSP untuk GitHub Pages + GIS + jsDelivr + Apps Script backend -->
  <meta http-equiv="Content-Security-Policy"
        content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' https://accounts.google.com https://accounts.gstatic.com;
        connect-src 'self' https://script.google.com https://script.googleusercontent.com https://oauth2.googleapis.com;
        style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net;
        img-src 'self' data:;
        font-src 'self' https://cdn.jsdelivr.net;
        frame-src https://accounts.google.com;
        " />

  <!-- UI (CSS sahaja) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

  <!-- Google Identity Services (WAJIB) -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    :root{--bg:#fff;--text:#111827;--muted:#6b7280;--card:#fff;--border:#e5e7eb}
    body{background:var(--bg);color:var(--text)}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px}
    .muted{color:var(--muted)}
    .hidden{display:none!important}
    .brand{font-weight:800}
    pre{white-space:pre-wrap}
  </style>
</head>
<body>
<div class="container py-4">

  <!-- Header -->
  <div class="d-flex align-items-center justify-content-between mb-4">
    <div>
      <div class="brand h3 mb-1">Clinic Marketing Dashboard</div>
      <div class="muted">Ringkasan kategori & outreach — tanpa PII di UI awam</div>
    </div>
    <div class="d-flex align-items-center gap-2">
      <small id="signinStatus" class="muted">Belum log masuk</small>
      <button id="btnSignOut" class="btn btn-outline-secondary btn-sm hidden">
        <i class="bi bi-box-arrow-right"></i> Keluar
      </button>
    </div>
  </div>

  <!-- Gate -->
  <div id="signinCard" class="card p-4 text-center">
    <h5 class="mb-2">Akses Terhad</h5>
    <p class="muted mb-3">Log masuk dengan akaun Google staf klinik.</p>
    <div id="gsiBtn" class="d-inline-block"></div>
    <div class="small muted mt-3">Origin: <code id="originText"></code></div>
    <div id="signinMsg" class="text-danger small mt-2"></div>
  </div>

  <!-- App -->
  <div id="app" class="hidden">

    <div class="card p-3 mb-3">
      <div class="row g-2">
        <div class="col-12 col-md-3">
          <label class="form-label mb-1">Mula</label>
          <input type="date" id="startDate" class="form-control" />
        </div>
        <div class="col-12 col-md-3">
          <label class="form-label mb-1">Tamat</label>
          <input type="date" id="endDate" class="form-control" />
        </div>
        <div class="col-12 col-md-3">
          <label class="form-label mb-1">Diagnosis (kod)</label>
          <input type="text" id="diagCode" class="form-control" placeholder="cth: URTI" />
        </div>
        <div class="col-12 col-md-3">
          <label class="form-label mb-1">Kawasan (kata kunci)</label>
          <input type="text" id="area" class="form-control" placeholder="cth: manir" />
        </div>
      </div>

      <div class="d-flex flex-wrap gap-2 mt-3">
        <button id="btnToday"  class="btn btn-outline-secondary btn-sm">Hari ini</button>
        <button id="btnMonth"  class="btn btn-outline-secondary btn-sm">Bulan ini</button>
        <button id="btnYear"   class="btn btn-outline-secondary btn-sm">Tahun ini</button>

        <button id="btnSync"        class="btn btn-warning btn-sm"><i class="bi bi-arrow-down-up"></i> Sync (Yezza→Sheet)</button>
        <button id="btnAggregate"   class="btn btn-primary btn-sm"><i class="bi bi-clipboard2-data"></i> Kira Agregat</button>
        <button id="btnLoadPatients" class="btn btn-success btn-sm"><i class="bi bi-people"></i> Muat Pesakit (ditapis)</button>
        <button id="btnMarketing" class="btn btn-info btn-sm text-white"><i class="bi bi-graph-up"></i> Analisis Marketing</button>
      </div>

      <div id="status" class="small muted mt-2">Sedia.</div>
    </div>

    <div class="card p-3">
      <h5 class="mb-2">Output (ringkas)</h5>
      <pre id="out" class="small mb-0"></pre>
    </div>

    <div class="card p-3 mt-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0">Analisis Marketing (Yezza)</h5>
        <span class="badge bg-info-subtle text-info-emphasis small">Beta</span>
      </div>
      <p class="muted small">Gunakan penapis di atas untuk menjana cerapan sasaran pelanggan, prestasi kempen, dan saranan tindakan.</p>
      <div id="insightsBody" class="small"></div>
    </div>
  </div>
</div>

<script>
/** ==================== KONFIG ==================== **/

// 1) CLIENT_ID (GIS) — gunakan client ID Web anda
const CLIENT_ID   = '366415747851-9p6fegh84hkfs74prtmtj09ldsp2vi3m.apps.googleusercontent.com';

// 2) BACKEND_URL (Apps Script Web App – exec)
const BACKEND_URL = 'https://script.google.com/macros/s/AKfycby1A1DrDRsoW3CP9tDI1EMdLzVBaCeubhT5HOaFLQQtQ3K7GEYbgows-WgGLSQV71fX/exec';

/** ==================== STATE/UTIL ==================== **/
let ID_TOKEN = null;
const $ = (s) => document.querySelector(s);
const fmt = (d)=> d ? new Date(d).toISOString().slice(0,10) : '';
const setStatus = (t)=> $('#status') && ($('#status').textContent=t);
const setOut = (o)=> { const el=$('#out'); if(el) el.textContent = typeof o==='string'? o : JSON.stringify(o,null,2); };

/** ==================== GOOGLE SIGN-IN ==================== **/
window.onload = () => {
  $('#originText').textContent = location.origin;

  // Tarikh lalai = hari ini
  const t=new Date(); $('#startDate').value=fmt(t); $('#endDate').value=fmt(t);

  // Shortcuts
  $('#btnToday')?.addEventListener('click', ()=>{const d=new Date();$('#startDate').value=fmt(d);$('#endDate').value=fmt(d);});
  $('#btnMonth')?.addEventListener('click', ()=>{const d=new Date(),s=new Date(d.getFullYear(),d.getMonth(),1),e=new Date(d.getFullYear(),d.getMonth()+1,0);$('#startDate').value=fmt(s);$('#endDate').value=fmt(e);});
  $('#btnYear')?.addEventListener('click', ()=>{const d=new Date(),s=new Date(d.getFullYear(),0,1),e=new Date(d.getFullYear(),11,31);$('#startDate').value=fmt(s);$('#endDate').value=fmt(e);});

  // Butang keluar
  $('#btnSignOut')?.addEventListener('click', ()=>location.reload());

  // Tindakan
  $('#btnSync')?.addEventListener('click', startSync);
  $('#btnAggregate')?.addEventListener('click', computeAggregate);
  $('#btnLoadPatients')?.addEventListener('click', loadPatients);
  $('#btnMarketing')?.addEventListener('click', analyzeMarketing);
  renderInsights(null);

  // Render GIS button
  if (!window.google || !google.accounts || !google.accounts.id){
    $('#signinMsg').textContent = 'Gagal memuatkan Google Sign-In. Semak internet/CSP.';
    return;
  }
  google.accounts.id.initialize({
    client_id: CLIENT_ID,
    callback: onSignIn,
    auto_select: false,
    ux_mode: 'popup'
  });
  google.accounts.id.renderButton($('#gsiBtn'), { theme:'outline', size:'large', shape:'pill' });
};

function onSignIn(resp){
  try{
    ID_TOKEN = resp.credential;
    $('#signinCard').classList.add('hidden');
    $('#app').classList.remove('hidden');
    $('#btnSignOut').classList.remove('hidden');
    $('#signinStatus').textContent = 'Log masuk berjaya';
    setStatus('Sedia.');
  }catch(e){
    $('#signinMsg').textContent = 'Log masuk gagal.';
    console.error(e);
  }
}

/** ==================== CALL BACKEND (tanpa preflight) ==================== **/
async function callAPI(action, payload){
  if (!ID_TOKEN) throw new Error('Belum log masuk');
  const res = await fetch(BACKEND_URL, {
    method: 'POST',
    mode: 'cors',
    headers: { 'Content-Type':'text/plain' }, // elak preflight
    body: JSON.stringify({ action, id_token: ID_TOKEN, payload })
  });
  if (!res.ok) throw new Error(await res.text());
  return res.json();
}

/** ==================== ACTIONS ==================== **/
async function startSync(){
  const start=$('#startDate').value, end=$('#endDate').value;
  if (!start || !end) return alert('Pilih tarikh mula & tamat.');
  try{
    setStatus('Memulakan sync…');
    const r = await callAPI('sync_range', { start, end });
    setOut(r);
    setStatus('Sync selesai. Rekod baharu: ' + (r.inserted||0));
  }catch(e){ setStatus('Ralat: ' + e.message); setOut(e.message); }
}

async function computeAggregate(){
  const start=$('#startDate').value, end=$('#endDate').value;
  if (!start || !end) return alert('Pilih tarikh mula & tamat.');
  try{
    setStatus('Mengira agregat…');
    const r = await callAPI('compute_aggregate', { start, end });
    setOut(r);
    setStatus('Agregat siap.');
  }catch(e){ setStatus('Ralat: ' + e.message); setOut(e.message); }
}

async function loadPatients(){
  const start=$('#startDate').value, end=$('#endDate').value;
  const code=$('#diagCode').value.trim(), area=$('#area').value.trim();
  if (!start || !end) return alert('Pilih tarikh mula & tamat.');
  try{
    setStatus('Memuat senarai pesakit…');
    const r = await callAPI('list_patients', { start, end, code, area });
    setOut(r);
    setStatus('Siap.');
  }catch(e){ setStatus('Ralat: ' + e.message); setOut(e.message); }
}

function renderInsights(data){
  const container = $('#insightsBody');
  if (!container) return;

  const fmtNumber = (value) => typeof value === 'number'
    ? value.toLocaleString('ms-MY', { maximumFractionDigits: 2 })
    : value;

  const formatKey = (key) => key
    .replace(/[_-]+/g, ' ')
    .replace(/\b\w/g, (c) => c.toUpperCase());

  const buildMetricCards = (metrics) => {
    if (!metrics || typeof metrics !== 'object') return '';
    const entries = Object.entries(metrics).filter(([,v]) => v !== undefined && v !== null);
    if (!entries.length) return '';
    return `
      <div class="row g-2 mb-3">
        ${entries.map(([k,v]) => `
          <div class="col-12 col-md-4">
            <div class="border rounded-3 p-3 h-100">
              <div class="muted text-uppercase small mb-1">${formatKey(k)}</div>
              <div class="h5 mb-0">${fmtNumber(v)}</div>
            </div>
          </div>
        `).join('')}
      </div>`;
  };

  const buildList = (items, title, icon) => {
    if (!Array.isArray(items) || !items.length) return '';
    return `
      <div class="mb-3">
        <div class="fw-semibold mb-1"><i class="bi ${icon} me-1"></i>${title}</div>
        <ul class="mb-0 ps-3">
          ${items.map((item) => `<li>${typeof item === 'string' ? item : Object.entries(item).map(([k,v]) => `<strong>${formatKey(k)}:</strong> ${fmtNumber(v)}`).join(', ')}</li>`).join('')}
        </ul>
      </div>`;
  };

  const buildTable = (rows, title) => {
    if (!Array.isArray(rows) || !rows.length) return '';
    const keys = Object.keys(rows[0] || {});
    if (!keys.length) return '';
    return `
      <div class="mb-3">
        <div class="fw-semibold mb-2"><i class="bi bi-bullseye me-1"></i>${title}</div>
        <div class="table-responsive">
          <table class="table table-sm mb-0 align-middle">
            <thead class="table-light">
              <tr>${keys.map((key) => `<th scope="col">${formatKey(key)}</th>`).join('')}</tr>
            </thead>
            <tbody>
              ${rows.map((row) => `
                <tr>${keys.map((key) => `<td>${fmtNumber(row[key]) ?? '-'}</td>`).join('')}</tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      </div>`;
  };

  let html = '';
  html += buildMetricCards(data?.summary || data?.metrics);
  html += buildTable(data?.channels || data?.channel_breakdown, 'Prestasi Saluran');
  html += buildTable(data?.campaigns, 'Prestasi Kempen');
  html += buildList(data?.top_keywords, 'Kata Kunci Teratas', 'bi-hash');
  html += buildList(data?.conversion_trends, 'Trend Penukaran', 'bi-activity');
  html += buildList(data?.recommendations, 'Saranan Tindakan', 'bi-lightbulb');

  if (!html) {
    html = `<div class="muted">Tiada cerapan khusus ditemui. Data mentah dipaparkan di bawah.</div>`;
    if (data) {
      html += `<pre class="mt-2">${JSON.stringify(data, null, 2)}</pre>`;
    }
  }

  container.innerHTML = html;
}

async function analyzeMarketing(){
  const start=$('#startDate').value, end=$('#endDate').value;
  const code=$('#diagCode').value.trim(), area=$('#area').value.trim();
  if (!start || !end) return alert('Pilih tarikh mula & tamat.');
  try{
    setStatus('Menjana analisis marketing…');
    const r = await callAPI('marketing_insights', { start, end, code, area });
    setOut(r);
    renderInsights(r);
    setStatus('Analisis marketing siap.');
  }catch(e){
    setStatus('Ralat: ' + e.message);
    setOut(e.message);
    renderInsights(null);
  }
}
</script>
</body>
</html>
