<!DOCTYPE html>
<html lang="ms">
<head>
  <!-- CSP: serasi GitHub Pages + GIS + jsDelivr + Apps Script -->
  <meta http-equiv="Content-Security-Policy"
        content="
        default-src 'none';
        script-src 'self' 'nonce-n123' https://accounts.google.com https://accounts.gstatic.com https://cdn.jsdelivr.net;
        style-src  'self' 'unsafe-inline' https://cdn.jsdelivr.net https://accounts.google.com;
        img-src    'self' data:;
        font-src   'self' https://cdn.jsdelivr.net;
        connect-src 'self' https://script.google.com https://script.googleusercontent.com https://cdn.jsdelivr.net;
        frame-src  https://accounts.google.com;">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard Pemasaran Klinik</title>

  <!-- UI libs -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    :root{
      --primary:#1a73e8; --primary-dark:#0d47a1;
      --secondary:#5f6368; --accent:#34a853;
      --warning:#fbbc05; --danger:#ea4335;
      --light-bg:#f7f9fc; --card-bg:#fff;
      --border:#e5e7eb; --text:#111827; --muted:#6b7280;
      --shadow:0 1px 2px rgba(0,0,0,.06),0 1px 3px rgba(0,0,0,.1);
    }
    body{background:var(--light-bg);color:var(--text);font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .brand{font-weight:800; letter-spacing:.2px; color:var(--primary);}
    .muted{color:var(--muted);}
    .card{border:1px solid var(--border); border-radius:14px; box-shadow:var(--shadow);}
    .stat{display:flex; gap:14px; align-items:center; background:var(--card-bg); border:1px solid var(--border); border-radius:14px; padding:16px 18px;}
    .stat .ico{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;background:#e8f0fe;color:var(--primary);}
    .stat .v{font-size:1.5rem; font-weight:800;}
    .chip{padding:.25rem .6rem;border-radius:16px;background:#eef2ff;color:#4338ca;font-weight:600;font-size:.75rem;border:1px solid #c7d2fe; cursor:pointer; user-select:none;}
    .chip.active{background:#111827;color:#fff;border-color:#111827}
    .chip-reset{background:#e5e7eb;color:#111827;border:1px solid #d1d5db}
    .hidden{display:none!important;}
    .toolbar .form-control,.toolbar .form-select{height:44px;border-radius:10px;}
    .btn{border-radius:10px;font-weight:600}
    .btn-primary{background:var(--primary);border-color:var(--primary)}
    .btn-primary:hover{background:var(--primary-dark);border-color:var(--primary-dark)}
    .section-title{font-weight:800}
    .chart-h{height:300px}
    .chart-h-lg{height:340px}
    .nav-pills .nav-link{border-radius:10px}
    footer{border-top:1px solid var(--border)}
    .table thead th{background:#f3f4f6}
    .progress-sm{height:6px}
    .toast-area{position: fixed; right: 16px; bottom: 16px; z-index: 1055;}
    .badge-code{background:#eef2ff;color:#4338ca;border:1px solid #c7d2fe}
    .btn-range.active{background:#111827;color:#fff;border-color:#111827}
    .chip-wrap{gap:.5rem .5rem}
    .small-mono{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace; font-size:.75rem}
  </style>
</head>
<body>
<div class="container py-4">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-start mb-3">
    <div>
      <div class="brand h3 mb-1">Dashboard Pemasaran Klinik</div>
      <div class="muted">Analisis data pesakit untuk strategi pemasaran yang lebih efektif</div>
      <div id="healthRow" class="mt-2 small"></div>
    </div>
    <div class="d-flex align-items-center gap-2">
      <span id="whoami" class="small muted"></span>
      <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" style="width:32px;height:32px" id="userAvatar">U</div>
      <button class="btn btn-outline-secondary btn-sm hidden" id="btnSignOut"><i class="bi bi-box-arrow-right"></i> Log Keluar</button>
    </div>
  </div>

  <!-- Sign-in Gate -->
  <div id="signinCard" class="card p-5 text-center mb-4">
    <div class="mb-3"><i class="bi bi-shield-lock" style="font-size:2.5rem;color:var(--primary)"></i></div>
    <h5 class="mb-2">Akses Terhad kepada Kakitangan</h5>
    <p class="muted mb-3">Sila log masuk dengan akaun Google yang dibenarkan untuk mengakses dashboard.</p>
    <div id="gsiBtn" class="d-inline-block"></div>
    <div id="signinMsg" class="small text-danger mt-3"></div>
    <div class="mt-3 small text-start">
      <div class="small-mono">Origin halaman: <span id="originStr"></span></div>
      <div class="small-mono">Client ID: <span id="clientStr"></span></div>
      <div id="originHelp" class="text-danger small mt-2"></div>
    </div>
  </div>

  <!-- App -->
  <div id="app" class="hidden">

    <!-- Penapis -->
    <div class="card p-4 mb-3">
      <div class="section-title mb-3"><i class="bi bi-funnel me-2"></i>Penapis Data</div>
      <div class="row g-3 toolbar">
        <div class="col-12 col-md-6 col-lg-3">
          <label class="form-label fw-semibold">Tarikh Mula</label>
          <input type="date" id="startDate" class="form-control">
        </div>
        <div class="col-12 col-md-6 col-lg-3">
          <label class="form-label fw-semibold">Tarikh Tamat</label>
          <input type="date" id="endDate" class="form-control">
        </div>
        <div class="col-12 col-md-6 col-lg-3">
          <label class="form-label fw-semibold">Kod Diagnosis</label>
          <input type="text" id="filterDiag" class="form-control" placeholder="cth: URTI, INFLUENZA, MSK">
        </div>
        <div class="col-12 col-md-6 col-lg-3">
          <label class="form-label fw-semibold">Kawasan / Lokasi</label>
          <input type="text" id="filterArea" class="form-control" placeholder="cth: Manir, Kuala Terengganu">
        </div>

        <div class="col-12 d-flex flex-wrap gap-2 align-items-center mt-1">
          <button id="btnApply" class="btn btn-primary" type="button"><i class="bi bi-funnel-fill"></i> Gunakan Penapis</button>
          <button id="btnClear" class="btn btn-outline-secondary" type="button"><i class="bi bi-arrow-clockwise"></i> Set Semula</button>

          <div class="ms-auto d-flex align-items-center gap-2">
            <span class="small fw-semibold">Kumpulan Data:</span>
            <div class="btn-group" role="group">
              <input type="radio" class="btn-check" name="gran" id="gDay" checked>
              <label class="btn btn-outline-dark" for="gDay">Harian</label>
              <input type="radio" class="btn-check" name="gran" id="gMonth">
              <label class="btn btn-outline-dark" for="gMonth">Bulanan</label>
              <input type="radio" class="btn-check" name="gran" id="gYear">
              <label class="btn btn-outline-dark" for="gYear">Tahunan</label>
            </div>
          </div>
        </div>

        <div class="col-12 mt-2">
          <div class="d-flex align-items-center gap-3">
            <div class="progress w-100 progress-sm" role="progressbar" aria-valuemin="0" aria-valuemax="100">
              <div class="progress-bar" id="progressFill" style="width:0%"></div>
            </div>
            <span id="statusLine" class="small muted">Sedia</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Trend Alerts -->
    <div class="card p-4 mb-3">
      <div class="d-flex justify-content-between align-items-center">
        <div class="section-title"><i class="bi bi-activity me-2"></i>Trend Alerts (14 hari vs 14 hari)</div>
        <button id="btnReloadTrend" class="btn btn-outline-secondary btn-sm" type="button"><i class="bi bi-arrow-repeat"></i> Muat Semula</button>
      </div>
      <div id="trendBox" class="mt-2 small muted">Tiada alert signifikan buat masa ini.</div>
    </div>

    <!-- KPI -->
    <div class="row g-3 mb-3">
      <div class="col-12 col-md-6 col-xl-3">
        <div class="stat"><div class="ico"><i class="bi bi-people"></i></div>
          <div><div class="v" id="kpiLabeled">0</div><div class="muted small">Pesakit Berlabel</div></div>
        </div>
      </div>
      <div class="col-12 col-md-6 col-xl-3">
        <div class="stat"><div class="ico"><i class="bi bi-tags"></i></div>
          <div><div class="v" id="kpiCats">0</div><div class="muted small">Kategori Diagnosis</div></div>
        </div>
      </div>
      <div class="col-12 col-md-6 col-xl-3">
        <div class="stat"><div class="ico"><i class="bi bi-graph-up-arrow"></i></div>
          <div><div class="v" id="kpiTop">-</div><div class="muted small">Diagnosis Terbanyak</div></div>
        </div>
      </div>
      <div class="col-12 col-md-6 col-xl-3">
        <div class="stat"><div class="ico"><i class="bi bi-telephone-outbound"></i></div>
          <div><div class="v" id="kpiProspects">0</div><div class="muted small">Prospek Outreach</div></div>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-pills mb-3" id="tabs">
      <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-data" type="button">Data & Carta</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-reactivate" type="button">Re-activation 30+</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-pricing" type="button">Harga & Reminder</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-repeat" type="button">Repeat Registry</button></li>
    </ul>

    <div class="tab-content">

      <!-- TAB: Data & Carta -->
      <div class="tab-pane fade show active" id="tab-data">
        <div class="d-flex flex-wrap gap-2 mb-3">
          <button id="btnSync" class="btn btn-warning" type="button"><i class="bi bi-arrow-repeat"></i> Sync Data</button>
          <button id="btnExport" class="btn btn-outline-success" type="button"><i class="bi bi-file-earmark-spreadsheet"></i> Eksport CSV</button>
          <button id="btnSort" class="btn btn-outline-secondary" type="button"><i class="bi bi-sort-alpha-down"></i> Susun Data</button>
          <button id="btnDelete" class="btn btn-outline-danger" type="button"><i class="bi bi-trash"></i> Padam Data</button>
          <div class="ms-auto small muted">Julat: <span id="legendPeriod">-</span></div>
        </div>

        <div class="row g-3 mb-3">
          <div class="col-12 col-xl-6">
            <div class="card p-3">
              <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Taburan Mengikut Kategori <span id="legendCalc" class="badge text-bg-light ms-2"></span></h6>
                <span id="legend1" class="small muted"></span>
              </div>
              <div class="small text-muted mb-2">Klik mana-mana kategori untuk tapis jadual pesakit.</div>
              <div class="chart-h"><canvas id="chartDonut"></canvas></div>
            </div>
          </div>
          <div class="col-12 col-xl-6">
            <div class="card p-3">
              <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Top Kategori Diagnosis</h6>
                <span id="legend2" class="small muted"></span>
              </div>
              <div class="small text-muted mb-2">Klik bar untuk tapis ikut kategori.</div>
              <div class="chart-h"><canvas id="chartBar"></canvas></div>
            </div>
          </div>
        </div>

        <!-- Senarai Pantas Kategori (chips) -->
        <div class="card p-3 mb-3">
          <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0">Senarai Pantas Kategori</h6>
            <small class="text-muted">Klik untuk tapis data. “Semua” untuk buang tapis.</small>
          </div>
          <div id="quickChips" class="d-flex flex-wrap chip-wrap mt-3"></div>
        </div>

        <!-- Graf Kehadiran -->
        <div class="card p-3 mb-3">
          <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div class="d-flex align-items-center gap-2">
              <h6 class="mb-0">Graf Kehadiran Pesakit</h6>
              <span id="attnInfo" class="badge text-bg-light"></span>
            </div>
            <div class="btn-group" role="group" aria-label="attn-range">
              <button class="btn btn-outline-dark btn-sm btn-range" id="attn7"  type="button">7H</button>
              <button class="btn btn-outline-dark btn-sm btn-range" id="attn14" type="button">14H</button>
              <button class="btn btn-outline-dark btn-sm btn-range active" id="attn30" type="button">30H</button>
              <button class="btn btn-outline-dark btn-sm btn-range" id="attn60" type="button">60H</button>
              <button class="btn btn-outline-dark btn-sm btn-range" id="attn365" type="button">1T</button>
            </div>
          </div>
          <div class="chart-h-lg"><canvas id="chartAttn"></canvas></div>
        </div>

        <!-- Jadual Pesakit -->
        <div class="card p-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">Senarai Pesakit (Ditapis)</h6>
            <div class="d-flex align-items-center gap-2">
              <label class="small fw-semibold me-1">Saiz Halaman:</label>
              <select id="pageSize" class="form-select form-select-sm" style="width:90px">
                <option>20</option><option>50</option><option selected>100</option><option>200</option>
              </select>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table align-middle" id="tbl">
              <thead>
                <tr>
                  <th>#</th><th>Nama Pesakit</th><th>Umur</th><th>Kod Diagnosis</th><th>Tarikh Lawatan</th><th>No. Telefon</th><th>WhatsApp</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="d-flex justify-content-between align-items-center mt-2">
            <div id="pageInfo" class="small muted">-</div>
            <div class="d-flex gap-2">
              <button class="btn btn-outline-secondary btn-sm" id="btnPrev" type="button"><i class="bi bi-chevron-left"></i> Sebelumnya</button>
              <button class="btn btn-outline-secondary btn-sm" id="btnNext" type="button">Seterusnya <i class="bi bi-chevron-right"></i></button>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: Re-activation -->
      <div class="tab-pane fade" id="tab-reactivate">
        <div class="d-flex align-items-center gap-2 mb-2">
          <div class="chip"><i class="bi bi-clock-history me-1"></i> Senarai pesakit tidak datang ≥30 hari</div>
          <button id="btnReloadReAct" class="btn btn-outline-secondary btn-sm" type="button"><i class="bi bi-arrow-repeat"></i> Muat Semula</button>
        </div>
        <div class="card p-3">
          <div class="table-responsive">
            <table class="table align-middle" id="tblReAct">
              <thead><tr><th>#</th><th>Nama</th><th>Telefon</th><th>Kategori Terakhir</th><th>Tarikh Terakhir</th><th>Hari Senyap</th><th>WhatsApp</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- TAB: Pricing -->
      <div class="tab-pane fade" id="tab-pricing">
        <div class="row g-3">
          <div class="col-12 col-lg-6">
            <div class="card p-3">
              <h6 class="mb-2">Harga Rawatan (Manual)</h6>
              <div class="row g-2">
                <div class="col-4"><input id="priceCode" class="form-control" placeholder="cth: URTI"></div>
                <div class="col-5"><input id="priceName" class="form-control" placeholder="Nama (opsyen)"></div>
                <div class="col-3"><input id="priceValue" class="form-control" type="number" placeholder="Harga"></div>
                <div class="col-12"><button id="btnSavePrice" class="btn btn-success w-100" type="button"><i class="bi bi-save"></i> Simpan Harga</button></div>
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-6">
            <div class="card p-3">
              <h6 class="mb-2">Senarai Harga</h6>
              <ul id="priceList" class="list-group small"></ul>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: Repeat Registry -->
      <div class="tab-pane fade" id="tab-repeat">
        <div class="row g-3">
          <div class="col-12 col-lg-6">
            <div class="card p-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Daftar Ulang Tahunan / Berkala</h6>
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" role="switch" id="autoVaxSwitch" checked>
                  <label class="form-check-label small" for="autoVaxSwitch">Auto daftar vaksin bila data dimuat</label>
                </div>
              </div>
              <div class="row g-2">
                <div class="col-6"><input id="repName" class="form-control" placeholder="Nama Pesakit"></div>
                <div class="col-6"><input id="repPhone" class="form-control" placeholder="Telefon"></div>
                <div class="col-6">
                  <label class="small fw-semibold ms-1">Tarikh Servis Terakhir</label>
                  <input id="repLast" type="date" class="form-control">
                </div>
                <div class="col-6"><input id="repType" class="form-control" placeholder="Jenis (cth: Influenza)"></div>
                <div class="col-6">
                  <label class="small fw-semibold ms-1">Kitaran (hari)</label>
                  <input id="repEvery" class="form-control" type="number" value="365">
                </div>
                <div class="col-6">
                  <label class="small fw-semibold ms-1">Due Seterusnya (opsyen)</label>
                  <input id="repNext" type="date" class="form-control">
                </div>
                <div class="col-12"><input id="repNote" class="form-control" placeholder="Nota (opsyen)"></div>
                <div class="col-12 d-flex gap-2">
                  <button id="btnRepSave" class="btn btn-success flex-fill" type="button"><i class="bi bi-plus-circle"></i> Simpan</button>
                  <button id="btnScanVaxNow" class="btn btn-outline-primary" type="button"><i class="bi bi-eyedropper"></i> Imbas Sekali Lagi</button>
                </div>
              </div>
              <div class="small text-muted mt-2" id="autoVaxMsg">-</div>
            </div>
          </div>
          <div class="col-12 col-lg-6">
            <div class="card p-3">
              <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-2">Akan Due (14 hari akan datang)</h6>
                <button id="btnRepDue" class="btn btn-outline-secondary btn-sm" type="button"><i class="bi bi-arrow-repeat"></i> Muat Semula</button>
              </div>
              <div class="table-responsive">
                <table class="table align-middle small" id="tblRepDue">
                  <thead><tr><th>#</th><th>Nama</th><th>Telefon</th><th>Jenis</th><th>Due</th><th>WhatsApp</th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div><!-- /tab-content -->

    <footer class="text-center muted small mt-4 py-3">
      © 2025 Klinik — Dashboard Pemasaran. Data adalah sulit dan hanya untuk kegunaan dalaman.
    </footer>
  </div><!-- /app -->

</div><!-- /container -->

<!-- Toast area -->
<div class="toast-area">
  <div id="toast" class="toast text-bg-dark border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="toastBody">OK</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>

<!-- ===== App Script ===== -->
<script nonce="n123">
/************ KONFIG ************/
const CLIENT_ID   = '366415747851-9p6fegh84hkfs74prtmtj09ldsp2vi3m.apps.googleusercontent.com';
const BACKEND_URL = 'https://script.google.com/macros/s/AKfycby1A1DrDRsoW3CP9tDI1EMdLzVBaCeubhT5HOaFLQQtQ3K7GEYbgows-WgGLSQV71fX/exec';

/************ STATE ************/
let ID_TOKEN=null;
let donutChart, barChart, attnChart;
let CUR_PAGE=1;
let LAST_PATIENT_ROWS=[];
let AUTO_VAX_SESSION_KEYS=new Set();
let CURRENT_LIST_DONUT=[], CURRENT_LIST_BAR=[];
let CODE_NAME_MAP = {}; // { URTI: 'Jangkitan Pernafasan Atas', ... }

/************ DOM helpers ************/
const $ = (q)=>document.querySelector(q);
const show = el => el.classList.remove('hidden');
const hide = el => el.classList.add('hidden');
const pickGran = () => $('#gYear').checked?'year':($('#gMonth').checked?'month':'day');
const fmtPeriod = (s,e)=>`${s} → ${e}`;
const Toast = { show(msg){ $('#toastBody').textContent=msg; const t=bootstrap.Toast.getOrCreateInstance($('#toast')); t.show(); } };

/************ AUTH + INIT ************/
window.onload = () => {
  $('#originStr').textContent = location.origin;
  $('#clientStr').textContent = CLIENT_ID;

  const d=new Date(), s=new Date(d.getFullYear(),d.getMonth(),1), e=new Date(d.getFullYear(),d.getMonth()+1,0);
  $('#startDate').value = s.toISOString().slice(0,10);
  $('#endDate').value   = e.toISOString().slice(0,10);

  $('#btnSignOut').addEventListener('click', ()=>location.reload());
  $('#btnApply').addEventListener('click', ()=>{ CUR_PAGE=1; loadPatients(true); });
  $('#btnClear').addEventListener('click', ()=>{ $('#filterDiag').value=''; $('#filterArea').value=''; CUR_PAGE=1; loadPatients(true); });
  $('#btnPrev').addEventListener('click', ()=>{ if (CUR_PAGE>1){ CUR_PAGE--; loadPatients(false); } });
  $('#btnNext').addEventListener('click', ()=>{ CUR_PAGE++; loadPatients(false); });
  $('#pageSize').addEventListener('change', ()=>{ CUR_PAGE=1; loadPatients(false); });
  $('#btnExport').addEventListener('click', exportCSV);

  $('#btnSync').addEventListener('click', startSync);
  $('#btnDelete').addEventListener('click', deleteRange);
  $('#btnSort').addEventListener('click', sortRange);

  $('#btnReloadTrend').addEventListener('click', loadTrends);
  $('#btnReloadReAct').addEventListener('click', loadReactivation);

  $('#btnSavePrice').addEventListener('click', savePrice);
  $('#btnRepSave').addEventListener('click', saveRepeat);
  $('#btnRepDue').addEventListener('click', loadRepeatDue);

  ['attn7','attn14','attn30','attn60','attn365'].forEach(id=>{
    $('#'+id).addEventListener('click', ()=>{
      document.querySelectorAll('.btn-range').forEach(b=>b.classList.remove('active'));
      $('#'+id).classList.add('active');
      const map={attn7:7, attn14:14, attn30:30, attn60:60, attn365:365};
      drawAttendance(map[id]);
    });
  });

  $('#btnScanVaxNow').addEventListener('click', ()=>scanVaccinations(LAST_PATIENT_ROWS,true));

  initGSI();
};

function initGSI(){
  const help = $('#originHelp');
  // Heuristik: jika origin bukan HTTPS atau localhost → beri mesej awal
  if (location.protocol !== 'https:' && location.hostname !== 'localhost'){
    help.textContent = 'Sila akses melalui HTTPS (GIS tidak benarkan HTTP).';
  }
  if (!window.google || !google.accounts || !google.accounts.id){
    $('#signinMsg').textContent='Gagal memuatkan Google SSO.';
    return;
  }
  try{
    google.accounts.id.initialize({ client_id:CLIENT_ID, callback:onSignIn, ux_mode:'popup' });
    google.accounts.id.renderButton($('#gsiBtn'), { theme:'outline', size:'large', shape:'pill' });

    // Jika 400 (origin tidak dibenarkan), butang tidak akan aktif.
    // Tunjuk bantuan yang spesifik selepas sedikit delay.
    setTimeout(()=>{
      const iframe = $('#gsiBtn')?.querySelector('iframe');
      if (!iframe){
        help.innerHTML = 'Butang SSO tidak dimuat. <strong>Pastikan origin ini ditambah dalam “Authorized JavaScript origins”</strong> untuk Client ID di Google Cloud Console.';
      }
    }, 1200);
  }catch(e){
    $('#signinMsg').textContent='SSO tidak dapat dimulakan.';
    help.textContent = 'Periksa konfigurasi Client ID & domain yang dibenarkan.';
  }
}

async function onSignIn(resp){
  try{
    ID_TOKEN = resp.credential;
    hide($('#signinCard')); show($('#app'));

    const payload = JSON.parse(atob(resp.credential.split('.')[1]));
    $('#whoami').textContent = payload.name || payload.email;
    $('#userAvatar').textContent = (payload.name || 'U').charAt(0).toUpperCase();

    healthCheck();
    await loadPatients(true);
    await Promise.all([loadPricing(), loadTrends(), loadReactivation(), loadRepeatDue()]);
  }catch(e){
    console.error(e);
    $('#signinMsg').textContent='Log masuk gagal.';
  }
}

/************ BACKEND CALL ************/
async function callAPI(action, payload){
  if (!ID_TOKEN) throw new Error('Belum log masuk');
  const res = await fetch(BACKEND_URL,{
    method:'POST', mode:'cors', credentials:'omit',
    headers:{ 'Content-Type':'text/plain' },
    body: JSON.stringify({ action, id_token:ID_TOKEN, payload })
  });
  if (!res.ok) throw new Error(await res.text());
  return res.json();
}

/************ HEALTH ************/
async function healthCheck(){
  try{
    const r = await callAPI('health',{});
    const ok = r && r.ok;
    const cfg = r.cfg || {};
    $('#healthRow').innerHTML =
      `<span class="badge bg-${ok?'success':'danger'} me-2"><i class="bi bi-heart-pulse"></i> Backend ${ok?'OK':'Down'}</span>
       <span class="badge text-bg-light me-1">ClientID:${cfg.clientIdSet?'✓':'✗'}</span>
       <span class="badge text-bg-light me-1">Token:${cfg.hasToken?'✓':'✗'}</span>
       <span class="badge text-bg-light me-1">Clinic:${cfg.hasClinic?'✓':'✗'}</span>`;
  }catch(e){
    $('#healthRow').innerHTML = `<span class="badge bg-danger">Backend Error</span>`;
  }
}

/************ SUMMARY & CHARTS ************/
async function loadSummary(){
  const s=$('#startDate').value, e=$('#endDate').value;
  try{
    await callAPI('compute_range',{ start:s, end:e });
    const data=await callAPI('get_summary_range',{ start:s, end:e });
    return data;
  }catch(err){
    console.warn('summary error:', err.message);
    return { labeled:0, rows:[] };
  }
}

function buildLocalSummary(rows){
  const counts={}; let labeled=0;
  rows.forEach(r=>{
    const codes=(r.diagnosisCodes||'').toString().toUpperCase().split(/[,\s]+/).filter(Boolean);
    if (codes.length){ labeled++; codes.forEach(c=>counts[c]=(counts[c]||0)+1); }
  });
  const list=Object.entries(counts).map(([code,count])=>({name:code,code,count,pct:0}));
  const total=Object.values(counts).reduce((a,b)=>a+b,0)||1;
  list.forEach(x=>x.pct=Math.round(x.count*1000/total)/10);
  list.sort((a,b)=>b.count-a.count);
  return { labeled, list, counts, topName:list[0]?.name||'-' };
}

function updateQuickChips(list){
  const wrap = $('#quickChips'); if (!wrap) return;
  wrap.innerHTML = '';
  const reset = document.createElement('span');
  reset.className='chip chip-reset';
  reset.textContent='Semua';
  reset.title='Buang penapis kategori';
  reset.addEventListener('click', ()=>{
    document.querySelectorAll('#quickChips .chip').forEach(c=>c.classList.remove('active'));
    $('#filterDiag').value='';
    CUR_PAGE=1; loadPatients(false);
  });
  wrap.appendChild(reset);

  const top = list.slice(0,12);
  top.forEach(item=>{
    const code=item.code || item.name;
    const name=CODE_NAME_MAP[code] || item.name || code;
    const chip=document.createElement('span');
    chip.className='chip';
    chip.innerHTML = `${escapeHTML(name)} <span class="ms-1 badge text-bg-light">${item.count}</span>`;
    chip.title = `${code} — klik untuk tapis`;
    chip.addEventListener('click', ()=>{
      document.querySelectorAll('#quickChips .chip').forEach(c=>c.classList.remove('active'));
      chip.classList.add('active');
      $('#filterDiag').value=code;
      CUR_PAGE=1; loadPatients(false);
    });
    wrap.appendChild(chip);
  });
}

function drawDonut(list){
  CURRENT_LIST_DONUT = list.slice();
  const ctx=$('#chartDonut');
  const labels=list.map(d=>(CODE_NAME_MAP[d.code]||d.name));
  const values=list.map(d=>d.pct);
  if (donutChart) donutChart.destroy();
  donutChart=new Chart(ctx,{
    type:'doughnut',
    data:{ labels, datasets:[{ data:values, backgroundColor:genColors(list.length), borderWidth:1, borderColor:'#fff' }]},
    options:{ plugins:{ legend:{ position:'bottom', labels:{ boxWidth:12, padding:14, font:{size:11} } } }, cutout:'65%', maintainAspectRatio:false,
      onClick: (_evt, el)=> {
        if (!el?.length) return;
        const idx = el[0].index;
        const code = CURRENT_LIST_DONUT[idx]?.code || CURRENT_LIST_DONUT[idx]?.name;
        if (!code) return;
        $('#filterDiag').value = code;
        CUR_PAGE=1;
        loadPatients(false);
        Toast.show(`Ditapis ikut kategori: ${code}`);
      }
    }
  });
}
function drawBar(list){
  CURRENT_LIST_BAR = list.slice();
  const ctx=$('#chartBar');
  const labels=list.map(d=>(CODE_NAME_MAP[d.code]||d.name));
  const values=list.map(d=>d.count);
  if (barChart) barChart.destroy();
  barChart=new Chart(ctx,{
    type:'bar',
    data:{ labels, datasets:[{ data:values, backgroundColor:genColors(list.length), borderWidth:0, borderRadius:4 }]},
    options:{ plugins:{ legend:{display:false}},
      scales:{ y:{beginAtZero:true, grid:{color:'rgba(0,0,0,.05)'}}, x:{grid:{display:false}} }, maintainAspectRatio:false,
      onClick: (_evt, el)=>{
        if (!el?.length) return;
        const idx = el[0].index;
        const code = CURRENT_LIST_BAR[idx]?.code || CURRENT_LIST_BAR[idx]?.name;
        if (!code) return;
        $('#filterDiag').value = code;
        CUR_PAGE=1;
        loadPatients(false);
        Toast.show(`Ditapis ikut kategori: ${code}`);
      }
    }
  });
}
function genColors(n){
  const base=['#1a73e8','#34a853','#fbbc05','#ea4335','#673ab7','#ff6d00','#00bcd4','#8bc34a','#e91e63','#009688'];
  return Array.from({length:n},(_,i)=>base[i%base.length]);
}

/************ ATTENDANCE ************/
function dateKey(d){ return d.toISOString().slice(0,10); }
function addDays(d, n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }

function buildAttendanceSeries(rows, days){
  const today = new Date(); today.setHours(0,0,0,0);
  let start = addDays(today, -days+1);
  const map = new Map();
  for(let i=0;i<days;i++){ const dk=dateKey(addDays(start,i)); map.set(dk,0); }
  rows.forEach(r=>{
    const v = new Date(r.visitDate); if(isNaN(+v)) return;
    v.setHours(0,0,0,0);
    const dk = dateKey(v);
    if (map.has(dk)) map.set(dk, map.get(dk)+1);
  });
  const labels=[...map.keys()];
  const data=[...map.values()];
  const total=data.reduce((a,b)=>a+b,0);
  return { labels, data, total };
}

function buildAttendanceYear(rows){
  const now=new Date(); const start=new Date(now.getFullYear(), now.getMonth()-11, 1);
  const buckets=new Map();
  for(let i=0;i<12;i++){
    const d=new Date(start.getFullYear(), start.getMonth()+i, 1);
    const key=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    buckets.set(key,0);
  }
  rows.forEach(r=>{
    const v=new Date(r.visitDate); if(isNaN(+v)) return;
    const key=`${v.getFullYear()}-${String(v.getMonth()+1).padStart(2,'0')}`;
    if (buckets.has(key)) buckets.set(key, buckets.get(key)+1);
  });
  const labels=[...buckets.keys()];
  const data=[...buckets.values()];
  const total=data.reduce((a,b)=>a+b,0);
  return { labels, data, total, monthly:true };
}

function drawAttendance(daysOrYear){
  const ctx=$('#chartAttn');
  if (attnChart) attnChart.destroy();
  let series, title='';
  if (daysOrYear===365){
    series = buildAttendanceYear(LAST_PATIENT_ROWS);
    title = `12 Bulan Terkini — Jumlah: ${series.total}`;
  }else{
    series = buildAttendanceSeries(LAST_PATIENT_ROWS, daysOrYear);
    title = `${daysOrYear} Hari Terkini — Jumlah: ${series.total}`;
  }
  $('#attnInfo').textContent = title;

  attnChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: series.labels,
      datasets: [{
        label: 'Kehadiran',
        data: series.data,
        fill: false,
        tension: 0.25,
        borderWidth: 2
      }]
    },
    options: {
      plugins: { legend:{ display:false } },
      scales: {
        y: { beginAtZero:true, grid:{ color:'rgba(0,0,0,.05)'} },
        x: { grid:{ display:false } }
      },
      maintainAspectRatio:false
    }
  });
}

/************ TREND & REACTIVATION ************/
async function loadTrends(){
  try{
    const r = await callAPI('trend_alerts',{});
    const arr = r.alerts || [];
    if (!arr.length){ $('#trendBox').innerHTML = 'Tiada alert signifikan buat masa ini.'; return; }
    $('#trendBox').innerHTML = arr.map(a=>`
      <div class="d-flex align-items-center gap-2 mb-1">
        <i class="bi bi-dot text-danger fs-3 lh-1"></i>
        <span><strong>${a.name}</strong> meningkat <strong>${a.growthPct}%</strong> (Kini: ${a.now}, Sebelum: ${a.prev})</span>
      </div>`).join('');
  }catch(e){ $('#trendBox').innerHTML='Gagal memuatkan alert.'; }
}

async function loadReactivation(){
  const tb = $('#tblReAct tbody'); if(!tb) return; tb.innerHTML='';
  try{
    const r = await callAPI('reactivation_list',{ days:30 });
    const rows = r.rows || [];
    if (!rows.length){ tb.innerHTML = `<tr><td colspan="7" class="text-center text-muted">Tiada rekod.</td></tr>`; return; }
    rows.forEach((x,i)=>{
      const msg = encodeURIComponent(`Hai ${x.name}, ini klinik anda. Bagaimana keadaan selepas lawatan terakhir (${x.lastVisit})? Jika perlu bantuan/temujanji, balas mesej ini ya.`);
      tb.insertAdjacentHTML('beforeend',`
        <tr>
          <td>${i+1}</td><td>${escapeHTML(x.name||'-')}</td><td>${escapeHTML(x.phone||'-')}</td>
          <td>${escapeHTML(x.lastCategory||'-')}</td><td>${x.lastVisit}</td><td>${x.daysSilent}</td>
          <td>${x.phone?`<a class="btn btn-sm btn-success" target="_blank" rel="noopener" href="https://wa.me/${String(x.phone).replace(/\D/g,'')}?text=${msg}"><i class="bi bi-whatsapp"></i></a>`:'-'}</td>
        </tr>`);
    });
  }catch(e){
    tb.innerHTML = `<tr><td colspan="7" class="text-danger">Ralat: ${e.message}</td></tr>`;
  }
}

/************ PATIENTS ************/
async function loadPatients(refreshSummary=true){
  const s=$('#startDate').value, e=$('#endDate').value;
  const diag=($('#filterDiag').value||'').trim();
  const area=($('#filterArea').value||'').trim();
  const pageSize=Number($('#pageSize').value||100);
  updateStatus('Memuat senarai pesakit…', 50);

  try{
    const res=await callAPI('patients',{
      startISO:s, endISO:e, page:CUR_PAGE, pageSize,
      diagnosisCode:diag, areaQuery:area
    });

    LAST_PATIENT_ROWS = res.rows||[];
    renderPatients(LAST_PATIENT_ROWS);

    const total=res.total||0;
    const from=(total===0)?0:((CUR_PAGE-1)*pageSize+1);
    const to=Math.min(CUR_PAGE*pageSize,total);
    $('#pageInfo').textContent = `Jumlah: ${total.toLocaleString()} | Halaman ${CUR_PAGE} (${from}-${to})`;

    const sStr=$('#startDate').value, eStr=$('#endDate').value;
    $('#legend1').textContent=fmtPeriod(sStr,eStr);
    $('#legend2').textContent=fmtPeriod(sStr,eStr);
    $('#legendPeriod').textContent=fmtPeriod(sStr,eStr);
    $('#legendCalc').textContent='';

    let data = await loadSummary();
    let list=[], labeled=0;
    if (data.rows && data.rows.length){
      labeled=(data.labeled)||0;
      $('#kpiLabeled').textContent=labeled.toLocaleString();
      const rows=data.rows||[];
      CODE_NAME_MAP = {};
      rows.forEach(r=>{ CODE_NAME_MAP[r[4]] = r[5]; });
      $('#kpiCats').textContent=new Set(rows.map(r=>r[4])).size||0;
      const top=rows.slice().sort((a,b)=>b[6]-a[6])[0];
      $('#kpiTop').textContent=top?top[5]:'-';
      list = rows.map(r=>({ name:r[5], code:r[4], count:r[6], pct:r[7] })).sort((a,b)=>b.count-a.count);
    }else{
      const local=buildLocalSummary(LAST_PATIENT_ROWS);
      $('#legendCalc').textContent='Local calc';
      $('#kpiLabeled').textContent=local.labeled.toLocaleString();
      $('#kpiCats').textContent=Object.keys(local.counts).length;
      $('#kpiTop').textContent=local.topName||'-';
      list = local.list.slice();
    }
    drawDonut(list); drawBar(list.slice(0,8));
    updateQuickChips(list);
    drawAttendance(30);
    document.querySelectorAll('.btn-range').forEach(b=>b.classList.remove('active'));
    $('#attn30').classList.add('active');

    if ($('#autoVaxSwitch')?.checked) {
      scanVaccinations(LAST_PATIENT_ROWS,false);
    }

    updateStatus('Data dimuat', 100);
  }catch(err){
    console.error(err);
    updateStatus('Ralat memuat pesakit: '+err.message, 0);
  }
}

function renderPatients(rows){
  const tb=$('#tbl tbody'); tb.innerHTML='';
  if (!rows.length) {
    tb.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-muted">Tiada data ditemui untuk penapis yang dipilih</td></tr>`;
    return;
  }
  rows.forEach((r,i)=>{
    const wa=r.phone?`https://wa.me/${String(r.phone).replace(/\D/g,'')}`:'';
    const codes = String(r.diagnosisCodes||'').toUpperCase().split(/[,\s]+/).filter(Boolean);
    const chips = codes.length
      ? codes.map(c=>{
          const nm = CODE_NAME_MAP[c] ? ` title="${escapeHTML(CODE_NAME_MAP[c])}"` : '';
          return `<span class="badge badge-code me-1"${nm}>${escapeHTML(c)}</span>`;
        }).join('')
      : '<span class="text-muted">-</span>';
    tb.insertAdjacentHTML('beforeend',`
      <tr>
        <td class="fw-semibold">${i+1 + (CUR_PAGE-1)*Number($('#pageSize').value||100)}</td>
        <td>${escapeHTML(r.name||'-')}</td>
        <td>${r.age||'-'}</td>
        <td>${chips}</td>
        <td>${r.visitDate||'-'}</td>
        <td>${escapeHTML(formatPhone(r.phone))||'-'}</td>
        <td>${wa?`<a class="btn btn-sm btn-success" target="_blank" rel="noopener" href="${wa}"><i class="bi bi-whatsapp"></i></a>`:'-'}</td>
      </tr>`);
  });
}

function formatPhone(phone) {
  if (!phone) return '';
  const cleaned = String(phone).replace(/\D/g, '');
  if (cleaned.length === 10) return cleaned.replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3');
  if (cleaned.length === 11) return cleaned.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
  return phone;
}
function escapeHTML(s){ 
  return String(s).replace(/[&<>"']/g, c=>({ 
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' 
  }[c])); 
}

/************ AUTO-DAFTAR VAKSIN ************/
const VAX_PATTERNS = [
  { re:/\b(influenza|flu)\b/i, type:'Influenza', days:365 },
  { re:/\b(covid|covid[-\s]?19)\b/i, type:'Covid', days:365 },
  { re:/\b(tetanus)\b/i, type:'Tetanus', days:365 },
  { re:/\b(hpv)\b/i, type:'HPV', days:365 },
  { re:/\b(hep[\s-]?b|hepatitis\s*b)\b/i, type:'HepB', days:365 },
  { re:/\b(vaksin|vaccine|vacc)\b/i, type:'Vaksin', days:365 },
];

function detectVaxType(text){
  if (!text) return null;
  for (const p of VAX_PATTERNS){
    if (p.re.test(text)) return { type:p.type, days:p.days };
  }
  return null;
}

async function scanVaccinations(rows, manualTriggered){
  if (!rows || !rows.length) { $('#autoVaxMsg').textContent='Tiada data untuk imbas.'; return; }
  let attempts=0, success=0;
  for (const r of rows){
    const blob = [r.diagnosisCodes||'', r.diagnosisText||''].join(' ');
    const hit = detectVaxType(blob);
    if (!hit) continue;
    const name = (r.name||'').trim();
    const phone= (r.phone||'').trim();
    const last = (r.visitDate||'').slice(0,10);
    if (!name || !phone || !last) continue;

    const key = `${phone}|${hit.type}|${last}`;
    if (AUTO_VAX_SESSION_KEYS.has(key)) continue;
    AUTO_VAX_SESSION_KEYS.add(key);

    attempts++;
    try{
      await callAPI('repeat_upsert',{
        patient_name:name,
        phone:phone,
        last_service:last,
        type:hit.type,
        due_every_days:hit.days,
        note:'auto'
      });
      success++;
    }catch(e){
      console.warn('auto vax upsert fail:', e.message);
    }
  }
  const msg = attempts ? `Auto-vaksin: ${success}/${attempts} didaftar.` : 'Auto-vaksin: Tiada kes vaksin dikesan.';
  $('#autoVaxMsg').textContent = msg;
  if (manualTriggered) Toast.show(msg);
}

/************ SYNC / PADAM / SUSUN ************/
async function startSync(){
  const s=$('#startDate').value, e=$('#endDate').value;
  const gran=pickGran();
  updateStatus('Memulakan sync…', 10);
  try{
    const { job } = await callAPI('sync_start',{ startISO:s, endISO:e, granularity:gran, dedup:true });
    await pollProgress(job);
    CUR_PAGE=1; 
    await loadPatients(true); 
  }catch(err){
    console.error(err); 
    updateStatus('Ralat sync: '+err.message, 0);
  }
}
async function pollProgress(job){
  return new Promise((resolve,reject)=>{
    const timer=setInterval(async ()=>{
      try{
        const p=await callAPI('sync_progress',{ job });
        let progress = 10;
        if (p.total && p.doneCount) progress = 10 + Math.floor((p.doneCount / p.total) * 80);
        updateStatus(`Menyelaraskan data… ${p.doneCount||0}/${p.total||0}`, progress);
        if (p.done){ clearInterval(timer); updateStatus('Sync selesai', 100); setTimeout(resolve, 400); }
      }catch(e){ clearInterval(timer); updateStatus('Ralat sync: ' + e.message, 0); reject(e); }
    }, 2000);
  });
}
function updateStatus(message, progress) {
  $('#statusLine').textContent = message;
  $('#progressFill').style.width = `${progress}%`;
}

async function deleteRange(){
  if (!confirm('Adakah anda pasti ingin memadam data dalam julat tarikh ini?')) return;
  const s=$('#startDate').value, e=$('#endDate').value, gran=pickGran();
  try{
    updateStatus('Memadam data…', 50);
    await callAPI('delete_range',{ start:s, end:e, granularity:gran });
    updateStatus('Data dipadam', 100);
    CUR_PAGE=1; 
    await loadPatients(true); 
  }catch(err){ 
    updateStatus('Padam gagal: ' + err.message, 0);
  }
}
async function sortRange(){
  const s=$('#startDate').value, e=$('#endDate').value, gran=pickGran();
  try{
    updateStatus('Menyusun data…', 50);
    await callAPI('sort_range',{ start:s, end:e, granularity:gran, by:'date', order:'asc' });
    updateStatus('Data disusun', 100);
    CUR_PAGE=1; 
    await loadPatients(false);
  }catch(err){ 
    updateStatus('Susun gagal: ' + err.message, 0);
  }
}

/************ CSV EXPORT ************/
function exportCSV(){
  const rows=[...document.querySelectorAll('#tbl tbody tr')].map(tr=>{
    const t=tr.querySelectorAll('td');
    return { name:t[1]?.textContent||'', age:t[2]?.textContent||'', codes:t[3]?.innerText||'', date:t[4]?.textContent||'', phone:t[5]?.textContent||'' };
  });
  if (!rows.length){ alert('Tiada data untuk dieksport'); return; }
  const header=['Nama','Umur','Kod Diagnosis','Tarikh','Telefon'];
  const csv=[header].concat(rows.map(r=>[r.name,r.age,r.codes,r.date,r.phone]))
    .map(a=>a.map(f=>`"${String(f).replace(/"/g,'""')}"`).join(',')).join('\n');
  const url=URL.createObjectURL(new Blob(["\uFEFF"+csv],{type:'text/csv;charset=utf-8;'}));
  const a=document.createElement('a'); a.href=url; a.download=`pesakit_${$('#startDate').value}_hingga_${$('#endDate').value}.csv`; a.click(); URL.revokeObjectURL(url);
}
</script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
