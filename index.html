<!DOCTYPE html>
<html lang="ms">
<head>
  <!-- === SECURITY (CSP via <meta>) ===
       Nota: 'frame-ancestors' tak berfungsi dalam <meta>, jadi tidak disertakan. -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'none';
                 script-src 'self' 'nonce-r4nd0m123' https://accounts.google.com https://accounts.gstatic.com https://cdn.jsdelivr.net;
                 connect-src https://script.google.com https://script.googleusercontent.com https://cdn.jsdelivr.net;
                 style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://accounts.google.com;
                 img-src 'self' data: https://accounts.google.com;
                 font-src 'self' https://cdn.jsdelivr.net;
                 frame-src https://accounts.google.com;
                 base-uri 'none'; form-action 'none';" />
  <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin-allow-popups">
  <meta name="referrer" content="no-referrer" />
  <meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=(), autoplay=(), fullscreen=()" />

  <!-- === META === -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Clinic Marketing Dashboard</title>

  <!-- === ASSETS === -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <!-- === THEME: LIGHT === -->
  <style>
    :root{
      --bg:#ffffff; --muted-bg:#f8fafc; --card:#ffffff; --border:#e5e7eb;
      --text:#0f172a; --muted:#64748b;
      --primary:#2563eb; --primary-600:#1d4ed8;
      --ok:#16a34a; --warn:#f59e0b; --danger:#dc2626;
      --ring: rgba(37,99,235,.20);
    }
    html,body{height:100%;}
    body{
      background: radial-gradient(1200px 600px at 20% -10%, rgba(37,99,235,.06) 0%, transparent 60%), var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    }
    .brand{ font-weight:800; letter-spacing:.3px; }
    .muted{ color: var(--muted); }
    .card{ background: var(--card); border:1px solid var(--border); border-radius:16px; }
    .btn-primary{ background: linear-gradient(180deg, var(--primary), var(--primary-600)); border:0; }
    .btn-outline-light{ border-color: var(--border); color: var(--text); }
    .btn-outline-light:hover{ background: var(--muted-bg); }
    .chip{ padding:.4rem .7rem; border-radius:999px; background:#eef2ff; color:#3730a3; font-weight:600; font-size:.85rem; }
    .hero{ background: linear-gradient(120deg, rgba(37,99,235,.08), rgba(34,197,94,.08)); border:1px solid var(--border); border-radius:16px; padding:18px; }
    .stat{ display:flex; align-items:center; gap:.75rem; padding:.75rem 1rem; border-radius:14px; background:var(--muted-bg); border:1px solid var(--border); }
    .ring{ box-shadow: 0 0 0 4px var(--ring); border-radius:12px; }
    .hidden{ display:none !important; }
    a, a:hover{ color: var(--primary); }
    .table-hover tbody tr:hover{ background-color:#f1f5f9; }
  </style>
</head>
<body>
  <div class="container py-4">

    <!-- HEADER -->
    <div class="d-flex flex-wrap align-items-center justify-content-between mb-3">
      <div>
        <div class="brand h3 mb-1">Clinic Marketing Dashboard</div>
        <div class="muted">Pola penyakit & peratusan — agregat, <strong>tanpa PII</strong></div>
      </div>
      <div class="d-flex gap-2 align-items-center">
        <span id="whoami" class="muted small"></span>
        <button class="btn btn-outline-light btn-sm hidden" id="btnSignOut"><i class="bi bi-box-arrow-right"></i> Keluar</button>
      </div>
    </div>

    <div class="hero mb-4">
      <div class="row align-items-center g-3">
        <div class="col-lg-8">
          <h4 class="mb-1">Gambaran Kesihatan Komuniti Bulan Ini</h4>
          <div class="muted">Lihat kategori dominan untuk kempen marketing — data dari catatan konsultasi doktor.</div>
        </div>
        <div class="col-lg-4 text-lg-end">
          <button class="btn btn-primary btn-sm" id="btnRefresh"><i class="bi bi-arrow-repeat"></i> Segarkan Bulan Ini</button>
        </div>
      </div>
    </div>

    <!-- SIGN-IN GATE -->
    <div id="signinCard" class="card p-4 text-center mb-4">
      <h4 class="mb-2">Akses Terhad</h4>
      <p class="muted mb-3">Log masuk dengan akaun Google staf klinik untuk melihat dashboard.</p>
      <div id="gsiBtn" class="d-inline-block ring"></div>
      <div id="signinMsg" class="small text-danger mt-3"></div>
      <div class="small muted mt-2">*Akses disahkan di pelayan; tiada data dipaparkan tanpa kebenaran.</div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="hidden">
      <div class="row g-3 mb-3">
        <div class="col-12 col-lg-5">
          <div class="card p-3 h-100">
            <h5 class="mb-3">Julat Tarikh</h5>
            <div class="row g-2">
              <div class="col-6">
                <label class="form-label">Mula</label>
                <input type="date" class="form-control" id="startDate" />
              </div>
              <div class="col-6">
                <label class="form-label">Tamat</label>
                <input type="date" class="form-control" id="endDate" />
              </div>
            </div>
            <div class="d-flex gap-2 mt-3">
              <button class="btn btn-success btn-sm" id="btnApplyRange"><i class="bi bi-clipboard2-data"></i> Kira & Kemas Kini</button>
              <button class="btn btn-outline-light btn-sm" id="btnExport"><i class="bi bi-download"></i> Export CSV</button>
            </div>
            <div class="mt-3 small muted" id="rangeInfo"></div>
            <div class="mt-1 small muted" id="lastUpdated"></div>
          </div>
        </div>
        <div class="col-12 col-lg-7">
          <div class="card p-3 h-100">
            <h5 class="mb-3">Sorotan Bulan Ini</h5>
            <div class="row g-3">
              <div class="col-12 col-md-4"><div class="stat"><div class="chip">Labeled</div><div class="ms-auto h5 mb-0" id="kpiLabeled">-</div></div></div>
              <div class="col-12 col-md-4"><div class="stat"><div class="chip">Kategori</div><div class="ms-auto h5 mb-0" id="kpiCategories">-</div></div></div>
              <div class="col-12 col-md-4"><div class="stat"><div class="chip">Top</div><div class="ms-auto h6 mb-0" id="kpiTop">-</div></div></div>
            </div>
            <div class="mt-2 small muted">“Labeled” = jumlah lawatan yang dipadankan ≥ 1 kategori.</div>
          </div>
        </div>
      </div>

      <div class="row g-3 mb-3">
        <div class="col-12 col-xl-6">
          <div class="card p-3">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-3">Peratus Mengikut Kategori</h5>
              <span class="muted small" id="legendPeriod1"></span>
            </div>
            <canvas id="chartDonut" height="260"></canvas>
          </div>
        </div>
        <div class="col-12 col-xl-6">
          <div class="card p-3">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-3">Top Kategori (Kiraan)</h5>
              <span class="muted small" id="legendPeriod2"></span>
            </div>
            <canvas id="chartBar" height="260"></canvas>
          </div>
        </div>
      </div>

      <div class="card p-3 mb-5">
        <h5 class="mb-3">Jadual Perincian</h5>
        <div class="table-responsive">
          <table class="table table-hover align-middle" id="tbl">
            <thead>
              <tr>
                <th style="width:60px;">#</th>
                <th>Kategori</th>
                <th style="width:140px;">Kod</th>
                <th style="width:140px;">Kiraan</th>
                <th style="width:140px;">Peratus</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <footer class="text-center muted small">© Klinik — Dashboard agregat (tiada PII). Akses disahkan di pelayan.</footer>
    </div>
  </div>

  <!-- === APP (inline dibenarkan melalui nonce) === -->
  <script nonce="r4nd0m123">
  /*** KONFIG — GUNA NILAI ANDA YANG SUDAH BERFUNGSI ***/
  const CLIENT_ID   = 'YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com'; // letak nilai anda yang sedang digunakan
  const BACKEND_URL = 'https://script.google.com/macros/s/…/exec';        // letak URL /exec yang sedang digunakan

  /*** STATE ***/
  let ID_TOKEN = null; let donutChart, barChart;

  /*** HELPERS ***/
  const $ = (q) => document.querySelector(q);
  const show = (el) => el.classList.remove('hidden');
  const hide = (el) => el.classList.add('hidden');
  const fmtPeriod = (s,e) => `${s} → ${e}`;

  /*** GOOGLE SSO ***/
  window.onload = () => {
    if (!window.google || !google.accounts || !google.accounts.id) {
      $('#signinMsg').textContent = 'Ralat memuatkan Google SSO. Semak sambungan internet.'; return;
    }
    // Pastikan "Authorized JavaScript origins" di OAuth Client mengandungi origin laman ini (cth: https://username.github.io)
    google.accounts.id.initialize({ client_id: CLIENT_ID, callback: onSignIn, auto_select:false, ux_mode:'popup', context:'signin' });
    google.accounts.id.renderButton($('#gsiBtn'), { theme:'outline', size:'large', shape:'pill' });
    $('#btnSignOut').addEventListener('click', signOut);

    // Tarikh lalai = bulan semasa
    const d=new Date(), s=new Date(d.getFullYear(), d.getMonth(), 1), e=new Date(d.getFullYear(), d.getMonth()+1, 0);
    $('#startDate').value = s.toISOString().slice(0,10);
    $('#endDate').value   = e.toISOString().slice(0,10);

    // Events
    $('#btnApplyRange').addEventListener('click', applyRange);
    $('#btnRefresh').addEventListener('click', refreshThisMonth);
    $('#btnExport').addEventListener('click', exportFromTable);
  };

  function onSignIn(resp){
    try{
      ID_TOKEN = resp.credential;
      $('#signinMsg').textContent = '';
      $('#whoami').textContent = 'Log masuk berjaya';
      hide($('#signinCard')); show($('#dashboard')); $('#btnSignOut').classList.remove('hidden');
      refreshThisMonth();
    }catch(e){ $('#signinMsg').textContent='Log masuk gagal. Cuba lagi.'; console.error(e); }
  }
  function signOut(){ ID_TOKEN = null; location.reload(); }

  /*** BACKEND (guna text/plain supaya tiada preflight OPTIONS) ***/
  async function callAPI(action, payload){
    if (!ID_TOKEN) throw new Error('Belum log masuk');
    const res = await fetch(BACKEND_URL, {
      method:'POST', mode:'cors', credentials:'omit',
      headers:{ 'Content-Type':'text/plain' },
      body: JSON.stringify({ action, id_token: ID_TOKEN, payload })
    });
    if (!res.ok){ throw new Error('API error: ' + await res.text()); }
    return res.json();
  }

  /*** RENDER & CHARTS ***/
  function setKPIs(summary){
    const totalLabeled = summary.labeled || 0;
    const cats = new Set((summary.rows||[]).map(r=>r[4])).size;
    const top = (summary.rows||[]).slice().sort((a,b)=>b[6]-a[6])[0];
    $('#kpiLabeled').textContent = totalLabeled;
    $('#kpiCategories').textContent = cats;
    $('#kpiTop').textContent = top ? top[5] : '-';
    $('#lastUpdated').textContent = 'Dikemas kini: ' + new Date().toLocaleString();
  }
  function toUIRows(rows){ return (rows||[]).map(r=>({ code:r[4], name:r[5], count:r[6], pct:r[7] })); }

  function drawDonut(list){
    const ctx=$('#chartDonut'); const labels=list.map(d=>d.name), values=list.map(d=>d.pct);
    if (donutChart) donutChart.destroy();
    donutChart=new Chart(ctx,{ type:'doughnut', data:{ labels, datasets:[{ data:values }] },
      options:{ plugins:{ legend:{ labels:{ color:'#0f172a' } }, tooltip:{ callbacks:{ label:(c)=>`${c.label}: ${c.raw}%` } } }, cutout:'60%' } });
  }
  function drawBar(list){
    const ctx=$('#chartBar'); const labels=list.map(d=>d.name), values=list.map(d=>d.count);
    if (barChart) barChart.destroy();
    barChart=new Chart(ctx,{ type:'bar', data:{ labels, datasets:[{ data:values }] },
      options:{ plugins:{ legend:{ display:false } }, scales:{ x:{ ticks:{ color:'#0f172a' } }, y:{ ticks:{ color:'#0f172a' } } } } });
  }
  function renderTable(list){
    const tbody=$('#tbl tbody'); tbody.innerHTML='';
    list.forEach((d,i)=>{ const tr=document.createElement('tr');
      tr.innerHTML=`<td>${i+1}</td><td>${d.name}</td><td>${d.code}</td><td>${d.count}</td><td>${d.pct}%</td>`; tbody.appendChild(tr); });
  }

  /*** FLOWS ***/
  async function refreshThisMonth(){
    const d=new Date(); const y=d.getFullYear(); const m=d.getMonth()+1;
    $('#rangeInfo').textContent='Mengira bulan ini…';
    try{
      const res=await callAPI('compute_month',{year:y,month:m});
      setKPIs(res); const list=toUIRows(res.rows).sort((a,b)=>b.count-a.count);
      drawDonut(list); drawBar(list.slice(0,10)); renderTable(list);
      $('#rangeInfo').textContent=`Julat: ${res.start} → ${res.end}`;
      $('#legendPeriod1').textContent = `${res.start} → ${res.end}`;
      $('#legendPeriod2').textContent = `${res.start} → ${res.end}`;
    }catch(err){ $('#rangeInfo').textContent='Ralat: '+err.message; console.error(err); }
  }
  async function applyRange(){
    const s=$('#startDate').value, e=$('#endDate').value; if(!s||!e){alert('Sila pilih tarikh mula & tamat.');return;}
    $('#rangeInfo').textContent='Mengira julat tarikh…';
    try{
      const res=await callAPI('compute_range',{start:s,end:e});
      setKPIs(res); const list=toUIRows(res.rows).sort((a,b)=>b.count-a.count);
      drawDonut(list); drawBar(list.slice(0,10)); renderTable(list);
      $('#rangeInfo').textContent=`Julat: ${res.start} → ${res.end}`;
      $('#legendPeriod1').textContent = `${res.start} → ${res.end}`;
      $('#legendPeriod2').textContent = `${res.start} → ${res.end}`;
    }catch(err){ $('#rangeInfo').textContent='Ralat: '+err.message; console.error(err); }
  }

  /*** EXPORT ***/
  function exportFromTable(){
    const rows=[...document.querySelectorAll('#tbl tbody tr')].map(tr=>{const t=tr.querySelectorAll('td');
      return { name:t[1].textContent, code:t[2].textContent, count:+t[3].textContent, pct:parseFloat(t[4].textContent) };});
    const csv=[['category','code','count','percentage']].concat(rows.map(d=>[d.name,d.code,d.count,d.pct])).map(r=>r.join(',')).join('\n');
    const url=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); const a=document.createElement('a'); a.href=url; a.download='marketing_summary.csv'; a.click(); URL.revokeObjectURL(url);
  }
  </script>
</body>
</html>
