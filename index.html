<!DOCTYPE html>
<html lang="ms">
<head>
  <!-- CSP sesuai untuk GitHub Pages + GIS -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'none';
                 script-src 'self' 'nonce-n123' https://accounts.google.com https://accounts.gstatic.com https://cdn.jsdelivr.net;
                 style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://accounts.google.com;
                 img-src 'self' data:;
                 font-src 'self' https://cdn.jsdelivr.net;
                 connect-src https://script.google.com https://script.googleusercontent.com;
                 frame-src https://accounts.google.com;">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard Pemasaran Klinik</title>
  <!-- UI libs -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    :root{
      --primary:#1a73e8;
      --primary-dark:#0d47a1;
      --secondary:#5f6368;
      --accent:#34a853;
      --warning:#fbbc05;
      --danger:#ea4335;
      --light-bg:#f8f9fa;
      --card-bg:#ffffff;
      --border:#dadce0;
      --text-primary:#202124;
      --text-secondary:#5f6368;
      --shadow:0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
      --shadow-hover:0 4px 12px rgba(0,0,0,0.15);
    }
    
    body{ 
      background:var(--light-bg); 
      color:var(--text-primary);
      font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }
    
    .brand{ 
      font-weight:700; 
      letter-spacing:-0.25px;
      color: var(--primary);
    }
    
    .muted{ color:var(--text-secondary); }
    
    .card{ 
      background:var(--card-bg); 
      border:1px solid var(--border); 
      border-radius:12px; 
      box-shadow: var(--shadow);
      transition: box-shadow 0.2s ease;
    }
    
    .card:hover {
      box-shadow: var(--shadow-hover);
    }
    
    .stat{ 
      display:flex; 
      gap:.75rem; 
      align-items:center; 
      background:var(--card-bg); 
      border:1px solid var(--border); 
      border-radius:12px; 
      padding:1rem 1.25rem; 
      box-shadow: var(--shadow);
    }
    
    .stat-icon {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 48px;
      height: 48px;
      border-radius: 12px;
      background: rgba(26, 115, 232, 0.1);
      color: var(--primary);
      font-size: 1.25rem;
    }
    
    .stat-content {
      flex: 1;
    }
    
    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
      line-height: 1.2;
    }
    
    .stat-label {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-top: 0.25rem;
    }
    
    .chip{ 
      padding:.25rem .75rem; 
      border-radius:16px; 
      background:#e8f0fe; 
      color:var(--primary); 
      font-size:.75rem;
      font-weight: 500;
    }
    
    .table thead th{ 
      background:var(--light-bg); 
      border-bottom: 2px solid var(--border);
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .table tbody tr {
      border-bottom: 1px solid var(--border);
    }
    
    .table tbody tr:hover {
      background-color: rgba(26, 115, 232, 0.04);
    }
    
    .hidden{ display:none !important; }
    
    .toolbar .form-control, .toolbar .form-select{ 
      height:44px; 
      border-radius: 8px;
      border: 1px solid var(--border);
    }
    
    .btn {
      border-radius: 8px;
      font-weight: 500;
      padding: 0.5rem 1rem;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.2s ease;
    }
    
    .btn-primary {
      background: var(--primary);
      border-color: var(--primary);
    }
    
    .btn-primary:hover {
      background: var(--primary-dark);
      border-color: var(--primary-dark);
      transform: translateY(-1px);
    }
    
    .btn-outline-secondary {
      color: var(--text-secondary);
      border-color: var(--border);
    }
    
    .btn-outline-secondary:hover {
      background: var(--light-bg);
      border-color: var(--text-secondary);
    }
    
    .btn-success {
      background: var(--accent);
      border-color: var(--accent);
    }
    
    .btn-warning {
      background: var(--warning);
      border-color: var(--warning);
      color: #000;
    }
    
    .btn-danger {
      background: var(--danger);
      border-color: var(--danger);
    }
    
    .btn-group .btn {
      border-radius: 0;
    }
    
    .btn-group .btn:first-child {
      border-top-left-radius: 8px;
      border-bottom-left-radius: 8px;
    }
    
    .btn-group .btn:last-child {
      border-top-right-radius: 8px;
      border-bottom-right-radius: 8px;
    }
    
    .btn-check:checked + .btn-outline-dark {
      background-color: var(--text-primary);
      border-color: var(--text-primary);
      color: white;
    }
    
    .filter-section {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    
    .section-title {
      font-size: 1.125rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .section-title i {
      color: var(--primary);
    }
    
    .chart-container {
      position: relative;
      height: 300px;
    }
    
    .action-buttons {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    
    .pagination-info {
      font-size: 0.875rem;
      color: var(--text-secondary);
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.875rem;
      font-weight: 500;
    }
    
    .progress-indicator {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      color: var(--text-secondary);
    }
    
    .progress-bar {
      width: 120px;
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: var(--primary);
      width: 0%;
      transition: width 0.3s ease;
    }
    
    footer {
      border-top: 1px solid var(--border);
      padding-top: 1.5rem;
      margin-top: 2rem;
    }
    
    @media (max-width: 768px) {
      .action-buttons {
        flex-direction: column;
        width: 100%;
      }
      
      .action-buttons .btn {
        width: 100%;
        justify-content: center;
      }
      
      .user-info {
        flex-direction: column;
        align-items: flex-end;
        gap: 0.5rem;
      }
    }
  </style>
</head>
<body>
  <div class="container py-4">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <div class="brand h3 mb-1">Dashboard Pemasaran Klinik</div>
        <div class="muted">Analisis data pesakit untuk strategi pemasaran yang lebih efektif</div>
      </div>
      <div class="user-info">
        <span id="whoami" class="small muted"></span>
        <div class="user-avatar" id="userAvatar">U</div>
        <button class="btn btn-outline-secondary btn-sm hidden" id="btnSignOut"><i class="bi bi-box-arrow-right"></i> Log Keluar</button>
      </div>
    </div>

    <!-- Sign-in Gate -->
    <div id="signinCard" class="card p-5 text-center mb-4">
      <div class="mb-4">
        <i class="bi bi-shield-lock" style="font-size: 3rem; color: var(--primary);"></i>
      </div>
      <h4 class="mb-3">Akses Terhad kepada Kakitangan</h4>
      <p class="muted mb-4">Sila log masuk dengan akaun Google yang dibenarkan untuk mengakses dashboard pemasaran klinik.</p>
      <div id="gsiBtn" class="d-inline-block"></div>
      <div id="signinMsg" class="small text-danger mt-3"></div>
    </div>

    <!-- Dashboard -->
    <div id="app" class="hidden">
      <!-- Filter Section -->
      <div class="filter-section">
        <div class="section-title">
          <i class="bi bi-funnel"></i>
          Penapis Data
        </div>
        <div class="row g-3 align-items-end">
          <div class="col-12 col-md-6 col-lg-3">
            <label class="form-label fw-semibold">Tarikh Mula</label>
            <input type="date" id="startDate" class="form-control">
          </div>
          <div class="col-12 col-md-6 col-lg-3">
            <label class="form-label fw-semibold">Tarikh Tamat</label>
            <input type="date" id="endDate" class="form-control">
          </div>
          <div class="col-12 col-md-6 col-lg-3">
            <label class="form-label fw-semibold">Kod Diagnosis</label>
            <input type="text" id="filterDiag" class="form-control" placeholder="cth: URTI, DM, HTN">
          </div>
          <div class="col-12 col-md-6 col-lg-3">
            <label class="form-label fw-semibold">Kawasan / Lokasi</label>
            <input type="text" id="filterArea" class="form-control" placeholder="cth: Manir, Kuala Terengganu">
          </div>
          
          <div class="col-12 mt-3">
            <div class="d-flex flex-wrap gap-2 align-items-center">
              <button id="btnApply" class="btn btn-primary">
                <i class="bi bi-funnel-fill"></i> Gunakan Penapis
              </button>
              <button id="btnClear" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-clockwise"></i> Set Semula
              </button>
              
              <div class="ms-auto d-flex flex-wrap gap-2 align-items-center">
                <span class="small fw-semibold">Kumpulan Data:</span>
                <div class="btn-group" role="group" aria-label="granular">
                  <input type="radio" class="btn-check" name="gran" id="gDay" autocomplete="off" checked>
                  <label class="btn btn-outline-dark" for="gDay">Harian</label>
                  <input type="radio" class="btn-check" name="gran" id="gMonth" autocomplete="off">
                  <label class="btn btn-outline-dark" for="gMonth">Bulanan</label>
                  <input type="radio" class="btn-check" name="gran" id="gYear" autocomplete="off">
                  <label class="btn btn-outline-dark" for="gYear">Tahunan</label>
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-12">
            <div class="progress-indicator mt-2">
              <span id="statusLine">Sedia</span>
              <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- KPI Cards -->
      <div class="row g-3 mb-4">
        <div class="col-12 col-md-6 col-lg-3">
          <div class="stat">
            <div class="stat-icon">
              <i class="bi bi-person-check"></i>
            </div>
            <div class="stat-content">
              <div class="stat-value" id="kpiLabeled">-</div>
              <div class="stat-label">Pesakit Berlabel</div>
            </div>
          </div>
        </div>
        <div class="col-12 col-md-6 col-lg-3">
          <div class="stat">
            <div class="stat-icon">
              <i class="bi bi-tags"></i>
            </div>
            <div class="stat-content">
              <div class="stat-value" id="kpiCats">-</div>
              <div class="stat-label">Kategori Diagnosis</div>
            </div>
          </div>
        </div>
        <div class="col-12 col-md-6 col-lg-3">
          <div class="stat">
            <div class="stat-icon">
              <i class="bi bi-graph-up-arrow"></i>
            </div>
            <div class="stat-content">
              <div class="stat-value" id="kpiTop">-</div>
              <div class="stat-label">Diagnosis Terbanyak</div>
            </div>
          </div>
        </div>
        <div class="col-12 col-md-6 col-lg-3">
          <div class="stat">
            <div class="stat-icon">
              <i class="bi bi-telephone-outbound"></i>
            </div>
            <div class="stat-content">
              <div class="stat-value" id="kpiProspects">0</div>
              <div class="stat-label">Prospek Outreach</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Charts Section -->
      <div class="row g-4 mb-4">
        <div class="col-12 col-xl-6">
          <div class="card p-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="mb-0">Taburan Mengikut Kategori</h5>
              <span class="small muted" id="legend1"></span>
            </div>
            <div class="chart-container">
              <canvas id="chartDonut"></canvas>
            </div>
          </div>
        </div>
        <div class="col-12 col-xl-6">
          <div class="card p-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="mb-0">Top Kategori Diagnosis</h5>
              <span class="small muted" id="legend2"></span>
            </div>
            <div class="chart-container">
              <canvas id="chartBar"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="d-flex flex-wrap gap-2 mb-3">
        <button id="btnSync" class="btn btn-warning">
          <i class="bi bi-arrow-repeat"></i> Sync Data
        </button>
        <button id="btnExport" class="btn btn-outline-success">
          <i class="bi bi-file-earmark-spreadsheet"></i> Eksport CSV
        </button>
        <button id="btnSort" class="btn btn-outline-secondary">
          <i class="bi bi-sort-alpha-down"></i> Susun Data
        </button>
        <button id="btnDelete" class="btn btn-outline-danger">
          <i class="bi bi-trash"></i> Padam Data
        </button>
      </div>

      <!-- Patient List -->
      <div class="card p-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="mb-0">Senarai Pesakit (Ditapis)</h5>
          <div class="d-flex align-items-center gap-2">
            <label class="small fw-semibold me-1">Saiz Halaman:</label>
            <select id="pageSize" class="form-select form-select-sm" style="width:90px">
              <option>20</option>
              <option>50</option>
              <option selected>100</option>
              <option>200</option>
            </select>
          </div>
        </div>
        
        <div class="table-responsive">
          <table class="table align-middle" id="tbl">
            <thead>
              <tr>
                <th>#</th>
                <th>Nama Pesakit</th>
                <th>Umur</th>
                <th>Diagnosis</th>
                <th>Kawasan</th>
                <th>Tarikh Lawatan</th>
                <th>No. Telefon</th>
                <th>WhatsApp</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        
        <div class="d-flex justify-content-between align-items-center mt-3">
          <div class="pagination-info" id="pageInfo">-</div>
          <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary btn-sm" id="btnPrev">
              <i class="bi bi-chevron-left"></i> Sebelumnya
            </button>
            <button class="btn btn-outline-secondary btn-sm" id="btnNext">
              Seterusnya <i class="bi bi-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>

      <footer class="text-center muted small mt-4">
        <p>© 2023 Klinik - Dashboard Pemasaran. Data adalah sulit dan hanya untuk kegunaan dalaman.</p>
        <p class="mb-0">Pastikan persetujuan pesakit untuk outreach pemasaran.</p>
      </footer>
    </div>
  </div>

  <!-- App Script -->
  <script nonce="n123">
  /************ KONFIG ************/
  const CLIENT_ID   = '366415747851-9p6fegh84hkfs74prtmtj09ldsp2vi3m.apps.googleusercontent.com';
  const BACKEND_URL = 'https://script.google.com/macros/s/AKfycby1A1DrDRsoW3CP9tDI1EMdLzVBaCeubhT5HOaFLQQtQ3K7GEYbgows-WgGLSQV71fX/exec';

  /************ STATE ************/
  let ID_TOKEN=null;
  let donutChart, barChart;
  let CUR_PAGE=1;

  const $=(q)=>document.querySelector(q);
  const show=(el)=>el.classList.remove('hidden');
  const hide=(el)=>el.classList.add('hidden');

  function fmtPeriod(s,e){ return `${s} → ${e}`; }
  function pickGran(){ if($('#gYear').checked) return 'year'; if($('#gMonth').checked) return 'month'; return 'day'; }

  // Shorten diagnose & area
  function shortenDiag(t){
    if(!t) return '';
    const s=String(t);
    const m=s.split(/[\n\.\,;|]/)[0];
    return (m||s).trim().slice(0,40);
  }
  function shortenArea(a){
    if(!a) return '';
    const parts=String(a).split(',').map(x=>x.trim()).filter(Boolean);
    const last2=parts.slice(-2).join(', ');
    return last2.replace(/\b\w/g, c=>c.toUpperCase());
  }

  /************ AUTH + INIT ************/
  window.onload = () => {
    if (!window.google || !google.accounts || !google.accounts.id){
      $('#signinMsg').textContent='Gagal memuatkan Google SSO.'; return;
    }
    google.accounts.id.initialize({ client_id:CLIENT_ID, callback:onSignIn, ux_mode:'popup' });
    google.accounts.id.renderButton($('#gsiBtn'), { theme:'outline', size:'large', shape:'pill' });

    // Tarikh lalai = bulan semasa
    const d=new Date(), s=new Date(d.getFullYear(),d.getMonth(),1), e=new Date(d.getFullYear(),d.getMonth()+1,0);
    $('#startDate').value = s.toISOString().slice(0,10);
    $('#endDate').value   = e.toISOString().slice(0,10);

    // Events
    $('#btnSignOut').addEventListener('click', ()=>location.reload());
    $('#btnApply').addEventListener('click', ()=>{ CUR_PAGE=1; loadPatients(); loadSummary(); });
    $('#btnClear').addEventListener('click', ()=>{ 
      $('#filterDiag').value=''; 
      $('#filterArea').value=''; 
      CUR_PAGE=1; 
      loadPatients(); 
      loadSummary(); 
    });
    $('#btnPrev').addEventListener('click', ()=>{ if (CUR_PAGE>1){ CUR_PAGE--; loadPatients(false); } });
    $('#btnNext').addEventListener('click', ()=>{ CUR_PAGE++; loadPatients(false); });
    $('#pageSize').addEventListener('change', ()=>{ CUR_PAGE=1; loadPatients(false); });
    $('#btnExport').addEventListener('click', exportCSV);

    $('#btnSync').addEventListener('click', startSync);
    $('#btnDelete').addEventListener('click', deleteRange);
    $('#btnSort').addEventListener('click', sortRange);
  };

  function onSignIn(resp){
    try{
      ID_TOKEN = resp.credential;
      hide($('#signinCard')); show($('#app'));
      
      // Decode token to get user info
      const payload = JSON.parse(atob(resp.credential.split('.')[1]));
      $('#whoami').textContent = payload.name || payload.email;
      $('#userAvatar').textContent = (payload.name || 'U').charAt(0).toUpperCase();
      
      loadSummary(); 
      loadPatients();
    }catch(e){ 
      console.error(e);
      $('#signinMsg').textContent='Log masuk gagal.'; 
    }
  }

  /************ BACKEND CALL ************/
  async function callAPI(action,payload){
    if (!ID_TOKEN) throw new Error('Belum log masuk');
    const res = await fetch(BACKEND_URL,{
      method:'POST', mode:'cors', credentials:'omit',
      headers:{ 'Content-Type':'text/plain' },
      body: JSON.stringify({ action, id_token:ID_TOKEN, payload })
    });
    if (!res.ok) throw new Error(await res.text());
    return res.json();
  }

  /************ SUMMARY & CHARTS ************/
  async function loadSummary(){
    const s=$('#startDate').value, e=$('#endDate').value;
    updateStatus('Memuat ringkasan…', 30);
    try{
      await callAPI('compute_range',{ start:s, end:e });
      const data=await callAPI('get_summary_range',{ start:s, end:e });
      const labeled=(data && data.labeled)||0;
      const rows=(data && data.rows)||[];
      
      $('#kpiLabeled').textContent=labeled.toLocaleString();
      $('#kpiCats').textContent=new Set(rows.map(r=>r[4])).size||0;
      const top=rows.slice().sort((a,b)=>b[6]-a[6])[0];
      $('#kpiTop').textContent=top?top[5]:'-';
      $('#legend1').textContent=fmtPeriod(s,e);
      $('#legend2').textContent=fmtPeriod(s,e);

      const list = rows.map(r=>({ name:r[5], code:r[4], count:r[6], pct:r[7] }))
                       .sort((a,b)=>b.count-a.count);
      drawDonut(list);
      drawBar(list.slice(0,8));
      updateStatus('Ringkasan dimuat', 100);
    }catch(err){
      console.error(err); 
      updateStatus('Ralat ringkasan: '+err.message, 0);
    }
  }
  
  function drawDonut(list){
    const ctx=$('#chartDonut');
    const labels=list.map(d=>d.name), values=list.map(d=>d.pct);
    if (donutChart) donutChart.destroy();
    
    // Generate colors
    const colors = generateColors(list.length);
    
    donutChart=new Chart(ctx,{ 
      type:'doughnut', 
      data:{ 
        labels, 
        datasets:[{ 
          data:values,
          backgroundColor: colors,
          borderWidth: 1,
          borderColor: '#fff'
        }] 
      },
      options:{ 
        plugins:{ 
          legend:{ 
            position:'bottom',
            labels: {
              boxWidth: 12,
              padding: 15,
              font: {
                size: 11
              }
            }
          } 
        }, 
        cutout:'65%',
        maintainAspectRatio: false
      } 
    });
  }
  
  function drawBar(list){
    const ctx=$('#chartBar');
    const labels=list.map(d=>d.name), values=list.map(d=>d.count);
    if (barChart) barChart.destroy();
    
    // Generate colors
    const colors = generateColors(list.length);
    
    barChart=new Chart(ctx,{ 
      type:'bar', 
      data:{ 
        labels, 
        datasets:[{ 
          data:values,
          backgroundColor: colors,
          borderWidth: 0,
          borderRadius: 4
        }] 
      },
      options:{ 
        plugins:{ 
          legend:{ display:false } 
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: {
              color: 'rgba(0,0,0,0.05)'
            }
          },
          x: {
            grid: {
              display: false
            }
          }
        },
        maintainAspectRatio: false
      } 
    });
  }
  
  function generateColors(count) {
    const baseColors = [
      '#1a73e8', '#34a853', '#fbbc05', '#ea4335', '#673ab7',
      '#ff6d00', '#00bcd4', '#8bc34a', '#e91e63', '#009688'
    ];
    
    let colors = [];
    for (let i = 0; i < count; i++) {
      colors.push(baseColors[i % baseColors.length]);
    }
    
    return colors;
  }

  /************ PATIENT LIST (FILTERED) ************/
  async function loadPatients(updateSummary=true){
    const s=$('#startDate').value, e=$('#endDate').value;
    const diag=($('#filterDiag').value||'').trim();
    const area=($('#filterArea').value||'').trim();
    const pageSize=Number($('#pageSize').value||100);
    updateStatus('Memuat senarai pesakit…', 50);

    try{
      const res=await callAPI('patients',{
        startISO:s, endISO:e, page:CUR_PAGE, pageSize,
        diagnosisCode:diag, areaQuery:area
      });
      renderPatients(res.rows||[]);
      const total=res.total||0;
      const from=(total===0)?0:((CUR_PAGE-1)*pageSize+1);
      const to=Math.min(CUR_PAGE*pageSize,total);
      $('#pageInfo').textContent = `Jumlah: ${total.toLocaleString()} | Halaman ${CUR_PAGE} (${from}-${to})`;
      if (updateSummary) await loadSummary();
      updateStatus('Data dimuat', 100);
    }catch(err){
      console.error(err); 
      updateStatus('Ralat memuat pesakit: '+err.message, 0);
    }
  }

  function renderPatients(rows){
    const tb=$('#tbl tbody'); tb.innerHTML='';
    
    if (rows.length === 0) {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="8" class="text-center py-4 text-muted">Tiada data ditemui untuk penapis yang dipilih</td>`;
      tb.appendChild(tr);
      return;
    }
    
    rows.forEach((r,i)=>{
      const tr=document.createElement('tr');
      const wa=r.phone?`https://wa.me/${String(r.phone).replace(/\D/g,'')}`:'';
      tr.innerHTML = `
        <td class="fw-semibold">${i+1 + (CUR_PAGE-1)*Number($('#pageSize').value||100)}</td>
        <td>${escapeHTML(r.name||'-')}</td>
        <td>${r.age||'-'}</td>
        <td>
          <div class="fw-medium">${escapeHTML(shortenDiag(r.diagnosisText||''))}</div>
          ${r.diagnosisCode ? `<small class="text-muted">${escapeHTML(r.diagnosisCode)}</small>` : ''}
        </td>
        <td>${escapeHTML(shortenArea(r.area||''))}</td>
        <td>${r.visitDate||'-'}</td>
        <td>${escapeHTML(formatPhone(r.phone))||'-'}</td>
        <td>${wa?`<a class="btn btn-sm btn-success" target="_blank" rel="noopener" href="${wa}"><i class="bi bi-whatsapp"></i></a>`:'-'}</td>
      `;
      tb.appendChild(tr);
    });
  }
  
  function formatPhone(phone) {
    if (!phone) return '';
    const cleaned = String(phone).replace(/\D/g, '');
    if (cleaned.length === 10) {
      return cleaned.replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3');
    } else if (cleaned.length === 11) {
      return cleaned.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
    }
    return phone;
  }

  function escapeHTML(s){ 
    return String(s).replace(/[&<>"']/g, c=>({ 
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' 
    }[c])); 
  }

  /************ SYNC (ASYNC + PROGRESS) ************/
  async function startSync(){
    const s=$('#startDate').value, e=$('#endDate').value;
    const gran=pickGran();
    updateStatus('Memulakan sync…', 10);
    try{
      const { job } = await callAPI('sync_start',{ startISO:s, endISO:e, granularity:gran, dedup:true });
      await pollProgress(job);
      CUR_PAGE=1; 
      await loadPatients(); 
      await loadSummary();
    }catch(err){
      console.error(err); 
      updateStatus('Ralat sync: '+err.message, 0);
    }
  }
  
  async function pollProgress(job){
    return new Promise(async (resolve,reject)=>{
      const timer=setInterval(async ()=>{
        try{
          const p=await callAPI('sync_progress',{ job });
          let progress = 10;
          if (p.total && p.doneCount) {
            progress = 10 + Math.floor((p.doneCount / p.total) * 80);
          }
          
          let txt='Menyelaraskan data… '; 
          if (p.step) txt+=`[${p.step}] `;
          if (p.total) txt+=`${p.doneCount||0}/${p.total}`;
          
          updateStatus(txt, progress);
          
          if (p.done){ 
            clearInterval(timer); 
            updateStatus('Sync selesai', 100);
            setTimeout(resolve, 500);
          }
        }catch(e){ 
          clearInterval(timer); 
          updateStatus('Ralat sync: ' + e.message, 0);
          reject(e); 
        }
      }, 2500);
    });
  }
  
  function updateStatus(message, progress) {
    $('#statusLine').textContent = message;
    $('#progressFill').style.width = `${progress}%`;
  }

  /************ PADAM / SUSUN ************/
  async function deleteRange(){
    if (!confirm('Adakah anda pasti ingin memadam data dalam julat tarikh ini?')) return;
    
    const s=$('#startDate').value, e=$('#endDate').value, gran=pickGran();
    try{
      updateStatus('Memadam data…', 50);
      const res=await callAPI('delete_range',{ start:s, end:e, granularity:gran });
      updateStatus('Data dipadam', 100);
      CUR_PAGE=1; 
      await loadPatients(); 
      await loadSummary();
    }catch(err){ 
      console.warn('delete_range belum tersedia di backend:', err.message); 
      updateStatus('Padam gagal: ' + err.message, 0);
    }
  }
  
  async function sortRange(){
    const s=$('#startDate').value, e=$('#endDate').value, gran=pickGran();
    try{
      updateStatus('Menyusun data…', 50);
      const res=await callAPI('sort_range',{ start:s, end:e, granularity:gran, by:'date', order:'asc' });
      updateStatus('Data disusun', 100);
      CUR_PAGE=1; 
      await loadPatients();
    }catch(err){ 
      console.warn('sort_range belum tersedia di backend:', err.message); 
      updateStatus('Susun gagal: ' + err.message, 0);
    }
  }

  /************ CSV eksport ************/
  function exportCSV(){
    const rows=[...document.querySelectorAll('#tbl tbody tr')].map(tr=>{
      const t=tr.querySelectorAll('td'); 
      return {
        name:t[1].textContent, 
        age:t[2].textContent, 
        diagnosis:t[3].textContent,
        area:t[4].textContent, 
        date:t[5].textContent, 
        phone:t[6].textContent
      };
    });
    
    if (rows.length === 0) {
      alert('Tiada data untuk dieksport');
      return;
    }
    
    const header=['Nama','Umur','Diagnosis','Kawasan','Tarikh','Telefon'];
    const csv=[header].concat(rows.map(r=>[
      r.name, r.age, r.diagnosis, r.area, r.date, r.phone
    ])).map(a=>a.map(field => `"${field.replace(/"/g, '""')}"`).join(',')).join('\n');
    
    const url=URL.createObjectURL(new Blob(["\uFEFF" + csv],{type:'text/csv;charset=utf-8;'}));
    const a=document.createElement('a'); 
    a.href=url; 
    a.download=`pesakit_${$('#startDate').value}_hingga_${$('#endDate').value}.csv`; 
    a.click(); 
    URL.revokeObjectURL(url);
  }
  </script>
</body>
</html>
