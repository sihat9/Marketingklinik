<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Clinic Marketing Dashboard</title>

  <!-- ========= CSP (sesuai GitHub Pages + broker Apps Script) ========= -->
  <meta http-equiv="Content-Security-Policy"
        content="
        default-src 'none';
        script-src 'self' 'unsafe-inline';
        connect-src 'self' https://script.google.com https://script.googleusercontent.com https://cdn.jsdelivr.net;
        style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net;
        img-src 'self' data:;
        font-src 'self' https://cdn.jsdelivr.net;
        frame-src 'self';
        " />

  <!-- UI (CSS sahaja, tiada skrip luar supaya patuh CSP) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

  <style>
    :root{
      --bg:#fff; --text:#111827; --muted:#6b7280; --card:#fff; --border:#e5e7eb;
      --primary:#0d6efd; --success:#16a34a; --danger:#dc3545;
    }
    body{background:var(--bg); color:var(--text)}
    .card{background:var(--card); border:1px solid var(--border); border-radius:16px}
    .muted{color:var(--muted)}
    .hidden{display:none !important}
    .brand{font-weight:800}
  </style>
</head>
<body>
<div class="container py-4">

  <!-- Header -->
  <div class="d-flex align-items-center justify-content-between mb-4">
    <div>
      <div class="brand h3 mb-1">Clinic Marketing Dashboard</div>
      <div class="muted">Ringkasan kategori & outreach — tanpa PII di UI awam</div>
    </div>
    <div class="d-flex align-items-center gap-2">
      <small id="signinStatus" class="muted">Belum log masuk</small>
      <button id="btnSignOut" class="btn btn-outline-secondary btn-sm hidden">
        <i class="bi bi-box-arrow-right"></i> Keluar
      </button>
    </div>
  </div>

  <!-- Gate (GitHub) -->
  <div id="signinCard" class="card p-4 text-center">
    <h5 class="mb-2">Akses Terhad</h5>
    <p class="muted mb-3">Log masuk dengan akaun Google staf klinik melalui tingkap selamat.</p>
    <button id="loginBtn" class="btn btn-light border px-4">
      <i class="bi bi-google me-2"></i> Log masuk dengan Google
    </button>
    <div class="small muted mt-3">Origin halaman: <code id="originText"></code></div>
  </div>

  <!-- App -->
  <div id="app" class="hidden">

    <div class="card p-3 mb-3">
      <div class="row g-2">
        <div class="col-12 col-md-3">
          <label class="form-label mb-1">Mula</label>
          <input type="date" id="startDate" class="form-control" />
        </div>
        <div class="col-12 col-md-3">
          <label class="form-label mb-1">Tamat</label>
          <input type="date" id="endDate" class="form-control" />
        </div>
        <div class="col-12 col-md-3">
          <label class="form-label mb-1">Diagnosis (kod)</label>
          <input type="text" id="diagCode" class="form-control" placeholder="cth: URTI" />
        </div>
        <div class="col-12 col-md-3">
          <label class="form-label mb-1">Kawasan (kata kunci)</label>
          <input type="text" id="area" class="form-control" placeholder="cth: manir" />
        </div>
      </div>

      <div class="d-flex flex-wrap gap-2 mt-3">
        <button id="btnToday"  class="btn btn-outline-secondary btn-sm">Hari ini</button>
        <button id="btnMonth"  class="btn btn-outline-secondary btn-sm">Bulan ini</button>
        <button id="btnYear"   class="btn btn-outline-secondary btn-sm">Tahun ini</button>

        <button id="btnSync"        class="btn btn-warning btn-sm"><i class="bi bi-arrow-down-up"></i> Sync (Yezza→Sheet)</button>
        <button id="btnAggregate"   class="btn btn-primary btn-sm"><i class="bi bi-clipboard2-data"></i> Kira Agregat</button>
        <button id="btnLoadPatients" class="btn btn-success btn-sm"><i class="bi bi-people"></i> Muat Pesakit (ditapis)</button>
      </div>

      <div id="status" class="small muted mt-2">Sedia.</div>
    </div>

    <div class="card p-3">
      <h5 class="mb-2">Output (ringkas)</h5>
      <pre id="out" class="small mb-0" style="white-space:pre-wrap"></pre>
    </div>
  </div>
</div>

<!-- ============ APP SCRIPT ============ -->
<script>
  // === 1) KONFIG ===
  // Backend (deployment URL) –> TETAPKAN DI SINI
  const BACKEND_URL = 'https://script.google.com/macros/s/AKfycby1A1DrDRsoW3CP9tDI1EMdLzVBaCeubhT5HOaFLQQtQ3K7GEYbgows-WgGLSQV71fX/exec';

  // Broker URL: broker=1 + origin (wajib supaya Apps Script tahu ke mana nak postMessage)
  const BROKER_URL  = BACKEND_URL + '?broker=1&origin=' + encodeURIComponent(location.origin);

  // === 2) STATE ===
  let ID_TOKEN = null;

  // === 3) HELPERS UI ===
  const $ = (s) => document.querySelector(s);
  const setStatus = (t) => $('#status') && ($('#status').textContent = t);
  const setOut = (o) => { const el = $('#out'); if (el) el.textContent = (typeof o === 'string') ? o : JSON.stringify(o, null, 2); };

  function fmt(d) { return d ? new Date(d).toISOString().slice(0,10) : ''; }

  // === 4) BROKER POPUP ===
  function openBroker() {
    const w = 500, h = 600;
    const y = window.top.outerHeight/2 + window.top.screenY - (h/2);
    const x = window.top.outerWidth /2 + window.top.screenX - (w/2);
    window.open(BROKER_URL, 'brokerWin', `popup=1,width=${w},height=${h},left=${x},top=${y}`);
  }

  // Terima token dari broker (Apps Script)
  window.addEventListener('message', (ev) => {
    if (!String(ev.origin).startsWith('https://script.google.com')) return;
    const msg = ev.data || {};
    if (msg.type === 'id_token') {
      ID_TOKEN = msg.token;
      $('#signinStatus').textContent = 'Log masuk berjaya';
      $('#signinCard').classList.add('hidden');
      $('#app').classList.remove('hidden');
      $('#btnSignOut').classList.remove('hidden');
      setStatus('Sedia.');
    } else if (msg.type === 'error') {
      $('#signinStatus').textContent = 'Ralat log masuk: ' + (msg.error || '');
    }
  });

  // === 5) PANGGIL BACKEND ===
  async function callAPI(action, payload) {
    if (!ID_TOKEN) throw new Error('Belum log masuk');
    const res = await fetch(BACKEND_URL, {
      method: 'POST',
      mode: 'cors',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({ action, id_token: ID_TOKEN, payload })
    });
    if (!res.ok) throw new Error(await res.text());
    return res.json();
  }

  // === 6) ACTION HANDLERS (contoh) ===
  async function startSync() {
    const start=$('#startDate').value, end=$('#endDate').value;
    if (!start || !end) return alert('Pilih tarikh mula & tamat.');
    try {
      setStatus('Memulakan sync…');
      const r = await callAPI('sync_range', { start, end });
      setOut(r);
      setStatus('Sync selesai. Rekod baharu: ' + (r.inserted||0));
    } catch (e) { setStatus('Ralat: ' + e.message); setOut(e.message); }
  }
  async function computeAggregate() {
    const start=$('#startDate').value, end=$('#endDate').value;
    if (!start || !end) return alert('Pilih tarikh mula & tamat.');
    try {
      setStatus('Mengira agregat…');
      const r = await callAPI('compute_aggregate', { start, end });
      setOut(r);
      setStatus('Agregat siap.');
    } catch (e) { setStatus('Ralat: ' + e.message); setOut(e.message); }
  }
  async function loadPatients() {
    const start=$('#startDate').value, end=$('#endDate').value;
    const code=$('#diagCode').value.trim(), area=$('#area').value.trim();
    if (!start || !end) return alert('Pilih tarikh mula & tamat.');
    try {
      setStatus('Memuat senarai pesakit…');
      const r = await callAPI('list_patients', { start, end, code, area });
      setOut(r);
      setStatus('Siap.');
    } catch (e) { setStatus('Ralat: ' + e.message); setOut(e.message); }
  }

  // === 7) INIT UI ===
  window.addEventListener('load', () => {
    // Papar origin
    $('#originText').textContent = location.origin;

    // Tarikh lalai = hari ini
    const t=new Date(); $('#startDate').value=fmt(t); $('#endDate').value=fmt(t);

    // Shortcuts
    $('#btnToday')?.addEventListener('click', () => {
      const d=new Date(); $('#startDate').value=fmt(d); $('#endDate').value=fmt(d);
    });
    $('#btnMonth')?.addEventListener('click', () => {
      const d=new Date(), s=new Date(d.getFullYear(), d.getMonth(), 1), e=new Date(d.getFullYear(), d.getMonth()+1, 0);
      $('#startDate').value=fmt(s); $('#endDate').value=fmt(e);
    });
    $('#btnYear')?.addEventListener('click', () => {
      const d=new Date(), s=new Date(d.getFullYear(),0,1), e=new Date(d.getFullYear(),11,31);
      $('#startDate').value=fmt(s); $('#endDate').value=fmt(e);
    });

    // Buttons
    $('#loginBtn')?.addEventListener('click', openBroker);
    $('#btnSignOut')?.addEventListener('click', ()=>location.reload());
    $('#btnSync')?.addEventListener('click', startSync);
    $('#btnAggregate')?.addEventListener('click', computeAggregate);
    $('#btnLoadPatients')?.addEventListener('click', loadPatients);
  });
</script>
</body>
</html>
