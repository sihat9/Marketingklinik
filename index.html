<!DOCTYPE html>
<html lang="ms">
<head>
  <!-- PENAMBAHAN: Mengatasi ralat Cross-Origin-Opener-Policy -->
  <meta http-equiv="Cross-Origin-Opener-Policy" content="unsafe-none">
  <!-- CSP: ketat + serasi GIS/Apps Script/JSDelivr -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'none';
                 script-src 'self' 'nonce-n123' https://accounts.google.com https://accounts.gstatic.com https://cdn.jsdelivr.net;
                 style-src  'self' 'unsafe-inline' https://cdn.jsdelivr.net https://accounts.google.com;
                 img-src    'self' data:;
                 font-src   'self' https://cdn.jsdelivr.net;
                 connect-src 'self' https://script.google.com https://script.googleusercontent.com https://cdn.jsdelivr.net;
                 frame-src  https://accounts.google.com;">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard Pemasaran Klinik (Laju)</title>

  <!-- Performance hints -->
  <link rel="preconnect" href="https://accounts.google.com">
  <link rel="preconnect" href="https://accounts.gstatic.com">
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="dns-prefetch" href="https://accounts.google.com">
  <link rel="dns-prefetch" href="https://accounts.gstatic.com">
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">

  <!-- UI libs -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    :root{--primary:#0d6efd;--primary-dark:#0a58ca;--secondary:#6c757d;--success:#198754;--info:#0dcaf0;--warning:#ffc107;--danger:#dc3545;--light:#f8f9fa;--dark:#212529;--border:#dee2e6;--text:#212529;--muted:#6c757d;--light-bg:#f8f9fa;--card-bg:#fff;--shadow:0 0.125rem 0.25rem rgba(0,0,0,0.075);--shadow-lg:0 0.5rem 1rem rgba(0,0,0,0.15)}
    body{background:linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;min-height:100vh}
    .brand{font-weight:800;color:var(--primary);letter-spacing:-0.5px} .muted{color:var(--muted)}
    .card{border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);transition:all 0.3s ease}
    .card:hover{box-shadow:var(--shadow-lg);transform:translateY(-2px)}
    .stat{display:flex;gap:14px;align-items:center;background:var(--card-bg);border:1px solid var(--border);border-radius:12px;padding:16px 18px;transition:all 0.3s ease}
    .stat:hover{transform:translateY(-2px);box-shadow:var(--shadow-lg)}
    .stat .ico{width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center;background:rgba(13, 110, 253, 0.1);color:var(--primary);transition:all 0.3s ease}
    .stat:hover .ico{background:var(--primary);color:white}
    .stat .v{font-size:1.75rem;font-weight:800;line-height:1}
    .hidden{display:none!important}.section-title{font-weight:700;letter-spacing:-0.3px}
    .toolbar .form-control,.toolbar .form-select{height:44px;border-radius:10px;border:1px solid var(--border);transition:all 0.2s ease}
    .toolbar .form-control:focus,.toolbar .form-select:focus{border-color:var(--primary);box-shadow:0 0 0 0.2rem rgba(13, 110, 253, 0.25)}
    .btn{border-radius:10px;font-weight:600;transition:all 0.2s ease}
    .btn-primary{background:var(--primary);border-color:var(--primary)}
    .btn-primary:hover{background:var(--primary-dark);border-color:var(--primary-dark);transform:translateY(-1px)}
    .btn-outline-primary:hover{transform:translateY(-1px)}
    .chart-h{height:300px}.chart-h-lg{height:340px}
    .btn-range.active{background:var(--primary);color:#fff;border-color:var(--primary)}
    .badge-code{background:rgba(13, 110, 253, 0.1);color:var(--primary);border:1px solid rgba(13, 110, 253, 0.2)}
    .cat-chip{border:1px solid var(--border);border-radius:20px;background:#fff;padding:.25rem .6rem;cursor:pointer;transition:all 0.2s ease}
    .cat-chip:hover{background:var(--light);transform:translateY(-1px)}
    .cat-chip.active{background:var(--primary);color:#fff;border-color:var(--primary)}
    .toast-area{position:fixed;right:16px;bottom:16px;z-index:1055}
    .subtle{font-size:.8rem;color:var(--muted)}
    .nav-pills .nav-link{border-radius:10px;font-weight:500;transition:all 0.2s ease}
    .nav-pills .nav-link.active{background:var(--primary)}
    .table{border-radius:10px;overflow:hidden}
    .table thead th{background:var(--light);border-bottom:2px solid var(--border);font-weight:600}
    .table tbody tr:hover{background-color:rgba(13, 110, 253, 0.05)}
    .progress{height:8px;border-radius:4px;overflow:hidden}
    .progress-bar{transition:width 0.6s ease}
    .loading-skeleton{background:linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);background-size:200% 100%;animation:loading 1.5s infinite}
    @keyframes loading{0%{background-position:200% 0}100%{background-position:-200% 0}}
    .fade-in{animation:fadeIn 0.5s ease}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .slide-up{animation:slideUp 0.3s ease}
    @keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
    .floating-action{position:fixed;bottom:20px;right:20px;z-index:1000}
    .pulse{animation:pulse 2s infinite}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(13, 110, 253, 0.7)}70%{box-shadow:0 0 0 10px rgba(13, 110, 253, 0)}100%{box-shadow:0 0 0 0 rgba(13, 110, 253, 0)}}
    .health-indicator{width:12px;height:12px;border-radius:50%;display:inline-block;margin-right:6px}
    .health-ok{background-color:var(--success);animation:pulse 2s infinite}
    .health-warning{background-color:var(--warning)}
    .health-error{background-color:var(--danger)}
    .skeleton{background:linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);background-size:200% 100%;animation:loading 1.5s infinite;border-radius:4px;height:20px;margin-bottom:10px}
    .data-empty{padding:40px;text-align:center;color:var(--muted)}
    .data-empty i{font-size:3rem;margin-bottom:15px;color:var(--muted)}
    .trend-up{color:var(--success)}
    .trend-down{color:var(--danger)}
    .trend-neutral{color:var(--muted)}
    .badge-trend{font-size:0.75rem;padding:0.25rem 0.5rem;border-radius:20px}
    .quick-filter{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:15px}
    .quick-filter button{border-radius:20px;font-size:0.875rem;padding:0.25rem 0.75rem}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:15px}
    @media (max-width: 768px){.stats-grid{grid-template-columns:repeat(2, 1fr)}}
    @media (max-width: 576px){.stats-grid{grid-template-columns:1fr}}
    .sync-status{position:fixed;top:0;left:0;width:100%;z-index:9999;background:var(--primary);color:white;padding:8px;text-align:center;transform:translateY(-100%);transition:transform 0.3s ease}
    .sync-status.show{transform:translateY(0)}
    .prediction-card { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-left: 4px solid var(--primary); }
    .patient-journey-step { position: relative; padding-left: 30px; }
    .patient-journey-step::before { content: ''; position: absolute; left: 0; top: 8px; width: 16px; height: 16px; border-radius: 50%; background: var(--primary); }
    .patient-journey-step::after { content: ''; position: absolute; left: 7px; top: 24px; width: 2px; height: calc(100% - 16px); background: var(--border); }
    .patient-journey-step:last-child::after { display: none; }
    .segment-card { transition: all 0.3s ease; cursor: pointer; }
    .segment-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-lg); }
    .segment-card .segment-size { position: absolute; top: 10px; right: 10px; font-size: 0.8rem; opacity: 0.7; }
    .campaign-card { border-left: 4px solid var(--success); }
    .campaign-status { position: absolute; top: 10px; right: 10px; }
    .geo-heatmap { height: 400px; border-radius: 12px; overflow: hidden; }
    .insight-card { background: linear-gradient(135deg, #e7f5ff 0%, #d0ebff 100%); border-left: 4px solid var(--info); }
    .insight-card .insight-icon { font-size: 2rem; color: var(--info); opacity: 0.7; }
    .persona-card { text-align: center; padding: 20px; }
    .persona-avatar { width: 80px; height: 80px; border-radius: 50%; margin: 0 auto 15px; background: var(--light); display: flex; align-items: center; justify-content: center; font-size: 2rem; }
    .roi-positive { color: var(--success); }
    .roi-negative { color: var(--danger); }
    .roi-neutral { color: var(--warning); }
    .feature-disabled { opacity: 0.6; }
    .feature-disabled .card { background: #f8f9fa; }
    .alert-warning { background-color: #fff3cd; border-color: #ffeaa7; color: #856404; }
  </style>
</head>
<body>
<!-- Sync Status Bar -->
<div id="syncStatusBar" class="sync-status">
  <i class="bi bi-arrow-repeat me-2"></i>
  <span id="syncStatusText">Menyegerakkan data...</span>
</div>

<div class="container py-4">

  <!-- Header -->
  <header class="d-flex justify-content-between align-items-start mb-4 fade-in">
    <div>
      <div class="brand h3 mb-1">Dashboard Pemasaran Klinik</div>
      <div class="muted">Analisis pantas & responsif</div>
      <div id="healthRow" class="mt-2 small"></div>
    </div>
    <div class="d-flex align-items-center gap-2">
      <span id="whoami" class="small muted"></span>
      <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" style="width:32px;height:32px" id="userAvatar">U</div>
    </div>
  </header>

  <!-- Sign-in Gate -->
  <div id="signinCard" class="card p-5 text-center mb-4 slide-up">
    <div class="mb-3"><i class="bi bi-shield-lock" style="font-size:2.5rem;color:var(--primary)"></i></div>
    <h5 class="mb-2">Akses Terhad kepada Kakitangan</h5>
    <p class="muted mb-3">Log masuk dengan akaun Google yang dibenarkan.</p>
    <div id="gsiBtn" class="d-inline-block"></div>
    <div id="signinMsg" class="small text-danger mt-3"></div>
  </div>

  <!-- App -->
  <main id="app" class="hidden">

    <!-- ================== MODUL BARU: UCAPAN HARI LAHIR ================== -->
    <section class="card p-4 mb-3 slide-up" id="bdayPanel">
      <div class="d-flex justify-content-between align-items-center">
        <div class="section-title"><i class="bi bi-cake me-2"></i>Ucapan Hari Lahir</div>
        <div class="d-flex align-items-center gap-2">
          <div class="btn-group" role="group">
            <input type="radio" class="btn-check" name="bdtab" id="bdayToday" checked>
            <label class="btn btn-outline-dark" for="bdayToday">Hari ini</label>
            <input type="radio" class="btn-check" name="bdtab" id="bdayTomorrow">
            <label class="btn btn-outline-dark" for="bdayTomorrow">Esok</label>
          </div>
          <button id="bdayRefresh" class="btn btn-outline-secondary btn-sm"><i class="bi bi-arrow-repeat"></i> Refresh</button>
        </div>
      </div>

      <div class="row g-3 mt-2">
        <div class="col-12">
          <label class="form-label fw-semibold">Template</label>
          <textarea id="bdayTemplate" class="form-control" rows="3">Hai {{NAMA}}, saya dari {{KLINIK}}. Selamat hari lahir! ðŸŽ‰ Jika perlukan apa-apa bantuan, hubungi {{HOTLINE}}.</textarea>
          <div class="d-flex align-items-center gap-2 mt-2">
            <button id="bdaySaveTpl" class="btn btn-primary btn-sm"><i class="bi bi-save"></i> Simpan Template</button>
            <span class="small muted">Placeholder: <code>{{NAMA}}</code>, <code>{{KLINIK}}</code>, <code>{{HOTLINE}}</code>, <code>{{TARIKH}}</code></span>
          </div>
        </div>

        <div class="col-12 col-xl-8">
          <div class="d-flex align-items-center gap-2 mb-2">
            <span class="badge text-bg-light"> <span id="bdayCount">0</span> pesakit </span>
            <div class="ms-auto d-flex gap-2">
              <button id="bdayCopyAll" class="btn btn-outline-secondary btn-sm"><i class="bi bi-clipboard"></i> Copy Semua</button>
              <button id="bdaySendAllApi" class="btn btn-success btn-sm"><i class="bi bi-rocket"></i> Hantar via API</button>
            </div>
          </div>
          <div id="bdayList" class="vstack gap-3"></div>
          <div id="bdayEmpty" class="data-empty hidden">
            <i class="bi bi-emoji-smile"></i>
            <p>Tiada pesakit untuk dihantar pada hari dipilih.</p>
          </div>
        </div>

        <div class="col-12 col-xl-4">
          <div class="card p-3">
            <div class="section-title mb-2"><i class="bi bi-gear me-2"></i>Settings</div>
            <div class="row g-2">
              <div class="col-12">
                <label class="form-label small fw-semibold">Nama Klinik</label>
                <input id="clinicName" class="form-control" placeholder="Contoh: Klinik Sihatsokmo">
              </div>
              <div class="col-12">
                <label class="form-label small fw-semibold">Hotline</label>
                <input id="clinicHotline" class="form-control" placeholder="Contoh: 0123456789">
              </div>
              <div class="col-12">
                <button id="btnSaveClinicCfg" class="btn btn-outline-primary w-100"><i class="bi bi-save"></i> Simpan Config</button>
              </div>
            </div>

            <hr class="my-3">

            <div class="section-title mb-2"><i class="bi bi-plug me-2"></i>Integrations</div>
            <div class="row g-2">
              <div class="col-12">
                <label class="form-label small fw-semibold">Provider</label>
                <select id="intProvider" class="form-select">
                  <option value="manual">manual (WhatsApp Web)</option>
                  <option value="api">api (WhatsApp API)</option>
                  <option value="dummy">dummy (ujian)</option>
                </select>
              </div>
              <div class="col-12">
                <label class="form-label small fw-semibold">Status</label>
                <select id="intStatus" class="form-select">
                  <option value="true">Enabled</option>
                  <option value="false">Disabled</option>
                </select>
              </div>

              <!-- Medan API (opsyen) -->
              <div class="col-12">
                <label class="form-label small fw-semibold">API Base URL</label>
                <input id="apiBaseUrl" class="form-control" placeholder="https://api.vendor.com">
              </div>
              <div class="col-12">
                <label class="form-label small fw-semibold">Endpoint Path</label>
                <input id="apiEndpoint" class="form-control" value="/messages">
              </div>
              <div class="col-12">
                <label class="form-label small fw-semibold">API Token</label>
                <input id="apiToken" class="form-control" placeholder="Bearer token / key">
              </div>
              <div class="col-12">
                <label class="form-label small fw-semibold">Sender (jika perlu)</label>
                <input id="apiSender" class="form-control" placeholder="6xxxxxxxx">
              </div>
              <div class="col-12">
                <button id="btnSaveIntegration" class="btn btn-success w-100"><i class="bi bi-check2-circle"></i> Simpan Integrasi</button>
              </div>
            </div>

            <div class="mt-3">
              <div class="d-flex justify-content-between align-items-center">
                <div class="section-title mb-0"><i class="bi bi-journal-text me-2"></i>Log Terkini</div>
                <button id="btnRefreshLog" class="btn btn-outline-secondary btn-sm"><i class="bi bi-arrow-repeat"></i> Refresh Log</button>
              </div>
              <div class="table-responsive mt-2">
                <table class="table table-sm align-middle mb-0">
                  <thead><tr><th>Masa</th><th>Hari</th><th>Provider</th><th>Status</th><th>Nama</th><th>Phone</th><th>Mesaj</th></tr></thead>
                  <tbody id="outboxTbody"></tbody>
                </table>
              </div>
            </div>

          </div>
        </div>
      </div>
    </section>
    <!-- ================== TAMAT MODUL HARI LAHIR ================== -->

    <!-- ====== Seksyen Data & Carta asal diringkaskan untuk fail contoh ====== -->
    <section class="card p-4 mb-3 slide-up">
      <div class="section-title mb-3"><i class="bi bi-funnel me-2"></i>Penapis Data</div>
      <div class="row g-3 toolbar">
        <div class="col-12 col-md-6 col-lg-3">
          <label class="form-label fw-semibold">Tarikh Mula</label>
          <input type="date" id="startDate" class="form-control">
        </div>
        <div class="col-12 col-md-6 col-lg-3">
          <label class="form-label fw-semibold">Tarikh Tamat</label>
          <input type="date" id="endDate" class="form-control">
        </div>
        <div class="col-12 col-md-6 col-lg-3">
          <label class="form-label fw-semibold">Kod Diagnosis</label>
          <input type="text" id="filterDiag" class="form-control" placeholder="cth: URTI, INFLUENZA, MSK">
        </div>
        <div class="col-12 col-md-6 col-lg-3">
          <label class="form-label fw-semibold">Kawasan / Lokasi</label>
          <input type="text" id="filterArea" class="form-control" placeholder="cth: Manir, Kuala Terengganu">
        </div>
        <div class="col-12 mt-2">
          <div class="d-flex align-items-center gap-3 w-100">
            <div class="progress w-100" style="height:8px"><div class="progress-bar" id="progressFill" style="width:0%"></div></div>
            <span id="statusLine" class="small muted">Sedia</span>
          </div>
          <div class="subtle mt-2" id="activeFilterMsg">Penapis: Semua kategori</div>
        </div>
      </div>
    </section>

    <footer class="text-center muted small mt-4 py-3">
      Â© 2025 Klinik â€” Dashboard Pemasaran. Data dalaman.
    </footer>
  </main><!-- /app -->

  <!-- Floating Action Button -->
  <div class="floating-action">
    <button id="fabSync" class="btn btn-primary btn-lg rounded-circle pulse" style="width:56px;height:56px;display:none">
      <i class="bi bi-arrow-repeat"></i>
    </button>
  </div>

</div><!-- /container -->

<!-- Toast area -->
<div class="toast-area">
  <div id="toast" class="toast text-bg-dark border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="toastBody">OK</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>

<!-- ===== App Script ===== -->
<script nonce="n123">
/************ KONFIG ************/
const CLIENT_ID   = '366415747851-9p6fegh84hkfs74prtmtj09ldsp2vi3m.apps.googleusercontent.com';
const BACKEND_URL = 'https://script.google.com/macros/s/AKfycby1A1DrDRsoW3CP9tDI1EMdLzVBaCeubhT5HOaFLQQtQ3K7GEYbgows-WgGLSQV71fX/exec';

/************ STATE ************/
let ID_TOKEN=null;
let isSyncing=false;
const $ = (q)=>document.querySelector(q);
const show = el => el.classList.remove('hidden');
const hide = el => el.classList.add('hidden');
const Toast = { show(msg){ $('#toastBody').textContent=msg; const t=bootstrap.Toast.getOrCreateInstance($('#toast')); t.show(); } };

/************ AUTH + INIT ************/
window.onload = () => {
  // default: bulan semasa
  const d=new Date(), s=new Date(d.getFullYear(),d.getMonth(),1), e=new Date(d.getFullYear(),d.getMonth()+1,0);
  $('#startDate').value = s.toISOString().slice(0,10);
  $('#endDate').value   = e.toISOString().slice(0,10);

  initGSI();
  bindBirthdayUi();
  loadClinicConfig().then(()=>bdayLoad());
};
function initGSI(){
  if (!window.google || !google.accounts || !google.accounts.id){
    $('#signinMsg').textContent='Gagal memuatkan Google SSO.'; return;
  }
  google.accounts.id.initialize({ client_id:CLIENT_ID, callback:onSignIn, ux_mode:'popup' });
  google.accounts.id.renderButton($('#gsiBtn'), { theme:'outline', size:'large', shape:'pill' });
}
async function onSignIn(resp){
  try{
    ID_TOKEN = resp.credential;
    hide($('#signinCard')); show($('#app'));

    const payload = JSON.parse(atob(resp.credential.split('.')[1]));
    $('#whoami').textContent = payload.name || payload.email;
    $('#userAvatar').textContent = (payload.name || 'U').charAt(0).toUpperCase();
  }catch(e){
    console.error(e);
    $('#signinMsg').textContent='Log masuk gagal.';
  }
}

/************ BACKEND CALL ************/
async function callAPI(action, payload){
  if (!ID_TOKEN) throw new Error('Belum log masuk');
  const res = await fetch(BACKEND_URL,{
    method:'POST', headers:{ 'Content-Type':'text/plain' },
    body: JSON.stringify({ action, id_token:ID_TOKEN, payload })
  });
  if (!res.ok) throw new Error(await res.text());
  return res.json();
}

/* =========================================================================
   =====================   MODUL UCAPAN HARI LAHIR   =======================
   ========================================================================= */

const LOCAL = {
  birthdaysToday : '/api/birthdays/today',
  birthdaysTomorrow: '/api/birthdays/tomorrow',
  send           : '/api/send',
  config         : '/api/config',
  outboxToday    : '/api/outbox/today',
  integrations   : '/api/integrations'
};

let BD_ROWS = [];
let BD_DAY  = 'today';

function bdayTplFill(tpl, row, cfg){
  const name = (row.name||'').trim();
  const klinik = ($('#clinicName').value||cfg?.clinic_name||'').trim();
  const hotline= ($('#clinicHotline').value||cfg?.clinic_phone||'').trim();
  const dt = (row.dob||'').slice(0,10);
  return tpl
    .replace(/\{\{NAMA\}\}/gi, name)
    .replace(/\{\{KLINIK\}\}/gi, klinik)
    .replace(/\{\{HOTLINE\}\}/gi, hotline)
    .replace(/\{\{TARIKH\}\}/gi, dt);
}

function bindBirthdayUi(){
  $('#bdayToday')?.addEventListener('change', ()=>{ BD_DAY='today'; bdayLoad(); });
  $('#bdayTomorrow')?.addEventListener('change', ()=>{ BD_DAY='tomorrow'; bdayLoad(); });
  $('#bdayRefresh')?.addEventListener('click', bdayLoad);
  const saved = localStorage.getItem('bday_template'); if(saved) $('#bdayTemplate').value = saved;
  $('#bdaySaveTpl')?.addEventListener('click', ()=>{ localStorage.setItem('bday_template', $('#bdayTemplate').value||''); Toast.show('Template disimpan di pelayar'); });
  $('#bdayCopyAll')?.addEventListener('click', bdayCopyAll);
  $('#bdaySendAllApi')?.addEventListener('click', bdaySendAllAPI);
  $('#btnSaveClinicCfg')?.addEventListener('click', saveClinicConfig);
  $('#btnSaveIntegration')?.addEventListener('click', saveIntegration);
  $('#btnRefreshLog')?.addEventListener('click', loadOutboxToday);
}

async function loadClinicConfig(){
  try{
    const r = await fetch(LOCAL.config).then(x=>x.json());
    const cfg = r?.integration?.config || {};
    $('#clinicName').value   = cfg.clinic_name  || '';
    $('#clinicHotline').value= cfg.clinic_phone || '';
    const provider = r?.integration?.provider || 'manual';
    const enabled  = r?.integration?.is_enabled ? 'true':'false';
    $('#intProvider').value = provider;
    $('#intStatus').value   = enabled;
    $('#apiBaseUrl').value  = cfg.api_base_url || '';
    $('#apiEndpoint').value = cfg.endpoint_path || '/messages';
    $('#apiToken').value    = cfg.api_token || '';
    $('#apiSender').value   = cfg.sender || '';
  }catch(e){ console.warn('config:', e.message); }
}

async function saveClinicConfig(){
  try{
    const body = { clinic_name: $('#clinicName').value.trim(), clinic_phone: $('#clinicHotline').value.trim() };
    const res = await fetch(LOCAL.config,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) }).then(r=>r.json());
    if(!res?.ok) throw new Error(res?.detail||'Gagal');
    Toast.show('Config klinik disimpan');
  }catch(e){ Toast.show('Ralat simpan config: '+e.message); }
}

async function saveIntegration(){
  try{
    const body = {
      provider: $('#intProvider').value,
      is_enabled: $('#intStatus').value==='true',
      config: {
        clinic_name  : $('#clinicName').value.trim(),
        clinic_phone : $('#clinicHotline').value.trim(),
        api_base_url : $('#apiBaseUrl').value.trim(),
        endpoint_path: $('#apiEndpoint').value.trim()||'/messages',
        api_token    : $('#apiToken').value.trim(),
        sender       : $('#apiSender').value.trim()
      }
    };
    const res = await fetch(LOCAL.integrations,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) }).then(r=>r.json());
    if(!res?.ok) throw new Error(res?.detail||'Gagal');
    Toast.show('Integrasi disimpan');
  }catch(e){ Toast.show('Ralat simpan integrasi: '+e.message); }
}

async function loadOutboxToday(){
  try{
    const r = await fetch(LOCAL.outboxToday).then(x=>x.json());
    const rows = r?.rows||[];
    const tb = $('#outboxTbody'); tb.innerHTML='';
    rows.forEach(x=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${x.sent_at||'-'}</td><td>${x.day||'-'}</td><td>${x.provider||'-'}</td><td>${x.status||'-'}</td><td>${escapeHTML(x.name||'-')}</td><td>${escapeHTML(x.phone||'-')}</td><td class="text-truncate" style="max-width:200px">${escapeHTML(x.message||'')}</td>`;
      tb.appendChild(tr);
    });
  }catch(e){ console.warn('outbox:', e.message); }
}

async function bdayLoad(){
  try{
    const url = (BD_DAY==='today') ? LOCAL.birthdaysToday : LOCAL.birthdaysTomorrow;
    const r = await fetch(url).then(x=>x.json());
    BD_ROWS = r?.rows||[];
    $('#bdayCount').textContent = BD_ROWS.length;
    renderBdayList(BD_ROWS);
    loadOutboxToday();
  }catch(e){
    $('#bdayList').innerHTML=''; show($('#bdayEmpty')); Toast.show('Ralat memuat senarai hari lahir');
  }
}
function renderBdayList(rows){
  const box = $('#bdayList'); box.innerHTML='';
  if(!rows.length){ show($('#bdayEmpty')); return; } else hide($('#bdayEmpty'));
  const cfg = {
    clinic_name: $('#clinicName').value.trim(),
    clinic_phone: $('#clinicHotline').value.trim()
  };
  const tpl = $('#bdayTemplate').value||'';
  rows.forEach(r=>{
    const msg = bdayTplFill(tpl, r, cfg);
    const div = document.createElement('div');
    div.className='card p-3';
    div.innerHTML = `
      <div class="d-flex flex-wrap justify-content-between align-items-start gap-3">
        <div>
          <div class="fw-semibold">${escapeHTML(r.name||'-')}</div>
          <div class="small text-muted">${escapeHTML(r.phone||'-')} â€¢ ${escapeHTML(r.area||'-')}</div>
          <div class="small text-muted">DOB: ${escapeHTML((r.dob||'').slice(0,10))} â€¢ Umur: ${r.age_years??'-'} â€¢ DX: ${escapeHTML(r.diagnosis_text||'-')}</div>
        </div>
        <div class="flex-grow-1" style="min-width:260px">
          <textarea class="form-control bmsg" rows="3">${msg}</textarea>
        </div>
        <div class="d-flex flex-column gap-2">
          <button class="btn btn-outline-secondary btn-sm bc-copy"><i class="bi bi-clipboard"></i> Copy</button>
          <button class="btn btn-outline-success btn-sm bc-waweb"><i class="bi bi-whatsapp"></i> WhatsApp Web</button>
          <button class="btn btn-primary btn-sm bc-api"><i class="bi bi-send"></i> Hantar via API</button>
        </div>
      </div>`;
    div.querySelector('.bc-copy').addEventListener('click', async ()=>{
      await navigator.clipboard.writeText(div.querySelector('.bmsg').value||''); Toast.show('Teks disalin');
    });
    div.querySelector('.bc-waweb').addEventListener('click', ()=>{
      const phone = String(r.phone||'').replace(/\D/g,''); if(!phone){ Toast.show('Tiada nombor telefon'); return; }
      const text  = div.querySelector('.bmsg').value||'';
      const url   = `https://wa.me/${phone}?text=${encodeURIComponent(text)}`;
      window.open(url,'_blank','noopener');
    });
    div.querySelector('.bc-api').addEventListener('click', ()=> bdaySendOneAPI(r.phone, div.querySelector('.bmsg').value||'') );
    box.appendChild(div);
  });
}

async function bdaySendOneAPI(phone, message){
  try{
    const res = await fetch(LOCAL.send,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ phone, message }) }).then(r=>r.json());
    if(!res?.ok) throw new Error(res?.detail||'Gagal');
    Toast.show('Dihantar (API)'); loadOutboxToday();
  }catch(e){ Toast.show('Ralat hantar API: '+e.message); }
}
async function bdaySendAllAPI(){
  try{
    if(!BD_ROWS.length){ Toast.show('Tiada data'); return; }
    let ok=0, fail=0;
    const cards = [...document.querySelectorAll('#bdayList .card')];
    for(let i=0;i<BD_ROWS.length;i++){
      const r = BD_ROWS[i]; const text = cards[i].querySelector('.bmsg').value||'';
      try{ const res = await fetch(LOCAL.send,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ phone:r.phone, message:text }) }).then(r=>r.json());
           if(res?.ok) ok++; else fail++; }catch(_){ fail++; }
      await new Promise(res=>setTimeout(res, 120));
    }
    Toast.show(`Selesai: ${ok} berjaya, ${fail} gagal`); loadOutboxToday();
  }catch(e){ Toast.show('Ralat bulk API: '+e.message); }
}

/************ UTIL ************/
function escapeHTML(s){ return String(s).replace(/[&<>\"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
</script>

<!-- Bootstrap JS (defer) -->
<script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
