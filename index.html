<!DOCTYPE html>
<html lang="ms">
<head>
  <!-- CSP: ketat + serasi GIS/Apps Script/JSDelivr -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'none';
                 script-src 'self' 'nonce-n123' https://accounts.google.com https://accounts.gstatic.com https://cdn.jsdelivr.net;
                 style-src  'self' 'unsafe-inline' https://cdn.jsdelivr.net https://accounts.google.com;
                 img-src    'self' data:;
                 font-src   'self' https://cdn.jsdelivr.net;
                 connect-src 'self' https://script.google.com https://script.googleusercontent.com https://cdn.jsdelivr.net;
                 frame-src  https://accounts.google.com;">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard Pemasaran Klinik (Profesional)</title>

  <!-- Performance hints -->
  <link rel="preconnect" href="https://accounts.google.com">
  <link rel="preconnect" href="https://accounts.gstatic.com">
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="dns-prefetch" href="https://accounts.google.com">
  <link rel="dns-prefetch" href="https://accounts.gstatic.com">
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">

  <!-- UI libs -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    :root{--primary:#0d6efd;--primary-dark:#0a58ca;--secondary:#6c757d;--success:#198754;--info:#0dcaf0;--warning:#ffc107;--danger:#dc3545;--light:#f8f9fa;--dark:#212529;--border:#dee2e6;--text:#212529;--muted:#6c757d;--light-bg:#f8f9fa;--card-bg:#fff;--shadow:0 0.125rem 0.25rem rgba(0,0,0,0.075);--shadow-lg:0 0.5rem 1rem rgba(0,0,0,0.15);--gradient-1:linear-gradient(135deg, #667eea 0%, #764ba2 100%);--gradient-2:linear-gradient(135deg, #f093fb 0%, #f5576c 100%);--gradient-3:linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);--gradient-4:linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)}
    body{background:linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;min-height:100vh}
    .brand{font-weight:800;color:var(--primary);letter-spacing:-0.5px} .muted{color:var(--muted)}
    .card{border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);transition:all 0.3s ease}
    .card:hover{box-shadow:var(--shadow-lg);transform:translateY(-2px)}
    .stat{display:flex;gap:14px;align-items:center;background:var(--card-bg);border:1px solid var(--border);border-radius:12px;padding:16px 18px;transition:all 0.3s ease}
    .stat:hover{transform:translateY(-2px);box-shadow:var(--shadow-lg)}
    .stat .ico{width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center;background:rgba(13, 110, 253, 0.1);color:var(--primary);transition:all 0.3s ease}
    .stat:hover .ico{background:var(--primary);color:white}
    .stat .v{font-size:1.75rem;font-weight:800;line-height:1}
    .hidden{display:none!important}.section-title{font-weight:700;letter-spacing:-0.3px}
    .toolbar .form-control,.toolbar .form-select{height:44px;border-radius:10px;border:1px solid var(--border);transition:all 0.2s ease}
    .toolbar .form-control:focus,.toolbar .form-select:focus{border-color:var(--primary);box-shadow:0 0 0 0.2rem rgba(13, 110, 253, 0.25)}
    .btn{border-radius:10px;font-weight:600;transition:all 0.2s ease}
    .btn-primary{background:var(--primary);border-color:var(--primary)}
    .btn-primary:hover{background:var(--primary-dark);border-color:var(--primary-dark);transform:translateY(-1px)}
    .btn-outline-primary:hover{transform:translateY(-1px)}
    .chart-h{height:300px}.chart-h-lg{height:340px}
    .btn-range.active{background:var(--primary);color:#fff;border-color:var(--primary)}
    .badge-code{background:rgba(13, 110, 253, 0.1);color:var(--primary);border:1px solid rgba(13, 110, 253, 0.2)}
    .cat-chip{border:1px solid var(--border);border-radius:20px;background:#fff;padding:.25rem .6rem;cursor:pointer;transition:all 0.2s ease}
    .cat-chip:hover{background:var(--light);transform:translateY(-1px)}
    .cat-chip.active{background:var(--primary);color:#fff;border-color:var(--primary)}
    .toast-area{position:fixed;right:16px;bottom:16px;z-index:1055}
    .subtle{font-size:.8rem;color:var(--muted)}
    .nav-pills .nav-link{border-radius:10px;font-weight:500;transition:all 0.2s ease}
    .nav-pills .nav-link.active{background:var(--primary)}
    .table{border-radius:10px;overflow:hidden}
    .table thead th{background:var(--light);border-bottom:2px solid var(--border);font-weight:600}
    .table tbody tr:hover{background-color:rgba(13, 110, 253, 0.05)}
    .progress{height:8px;border-radius:4px;overflow:hidden}
    .progress-bar{transition:width 0.6s ease}
    .loading-skeleton{background:linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);background-size:200% 100%;animation:loading 1.5s infinite}
    @keyframes loading{0%{background-position:200% 0}100%{background-position:-200% 0}}
    .fade-in{animation:fadeIn 0.5s ease}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .slide-up{animation:slideUp 0.3s ease}
    @keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
    .floating-action{position:fixed;bottom:20px;right:20px;z-index:1000}
    .pulse{animation:pulse 2s infinite}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(13, 110, 253, 0.7)}70%{box-shadow:0 0 0 10px rgba(13, 110, 253, 0)}100%{box-shadow:0 0 0 0 rgba(13, 110, 253, 0)}}
    .health-indicator{width:12px;height:12px;border-radius:50%;display:inline-block;margin-right:6px}
    .health-ok{background-color:var(--success);animation:pulse 2s infinite}
    .health-warning{background-color:var(--warning)}
    .health-error{background-color:var(--danger)}
    .skeleton{background:linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);background-size:200% 100%;animation:loading 1.5s infinite;border-radius:4px;height:20px;margin-bottom:10px}
    .data-empty{padding:40px;text-align:center;color:var(--muted)}
    .data-empty i{font-size:3rem;margin-bottom:15px;color:var(--muted)}
    .trend-up{color:var(--success)}
    .trend-down{color:var(--danger)}
    .trend-neutral{color:var(--muted)}
    .badge-trend{font-size:0.75rem;padding:0.25rem 0.5rem;border-radius:20px}
    .quick-filter{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:15px}
    .quick-filter button{border-radius:20px;font-size:0.875rem;padding:0.25rem 0.75rem}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:15px}
    @media (max-width: 768px){.stats-grid{grid-template-columns:repeat(2, 1fr)}}
    @media (max-width: 576px){.stats-grid{grid-template-columns:1fr}}
    .sync-status{position:fixed;top:0;left:0;width:100%;z-index:9999;background:var(--primary);color:white;padding:8px;text-align:center;transform:translateY(-100%);transition:transform 0.3s ease}
    .sync-status.show{transform:translateY(0)}
    
    /* New styles for marketing features */
    .gradient-card{background:var(--gradient-1);color:white;border-radius:12px;padding:20px;margin-bottom:20px}
    .gradient-card h2{margin-bottom:15px}
    .gradient-card p{opacity:0.9}
    .prediction-card{border-left:4px solid var(--primary);background:rgba(13, 110, 253, 0.05)}
    .segment-card{border-radius:12px;padding:15px;margin-bottom:15px;transition:all 0.3s ease}
    .segment-card:hover{transform:translateY(-2px);box-shadow:var(--shadow-lg)}
    .segment-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .segment-title{font-weight:600;font-size:1.1rem}
    .segment-size{background:var(--primary);color:white;border-radius:20px;padding:2px 10px;font-size:0.8rem}
    .journey-step{position:relative;padding-left:30px;margin-bottom:20px}
    .journey-step:before{content:'';position:absolute;left:0;top:5px;width:20px;height:20px;border-radius:50%;background:var(--primary)}
    .journey-step:after{content:'';position:absolute;left:9px;top:25px;width:2px;height:calc(100% - 20px);background:var(--border)}
    .journey-step:last-child:after{display:none}
    .journey-title{font-weight:600;margin-bottom:5px}
    .journey-desc{color:var(--muted);font-size:0.9rem}
    .prediction-confidence{display:inline-block;background:var(--success);color:white;border-radius:20px;padding:2px 8px;font-size:0.8rem;margin-left:10px}
    .prediction-confidence.low{background:var(--warning)}
    .prediction-confidence.medium{background:var(--info)}
    .prediction-confidence.high{background:var(--success)}
    .ltv-badge{background:var(--gradient-2);color:white;border-radius:20px;padding:2px 8px;font-size:0.8rem}
    .churn-risk{display:inline-block;border-radius:20px;padding:2px 8px;font-size:0.8rem;margin-left:10px}
    .churn-risk.low{background:var(--success);color:white}
    .churn-risk.medium{background:var(--warning);color:white}
    .churn-risk.high{background:var(--danger);color:white}
    .persona-card{border-radius:12px;padding:15px;margin-bottom:15px;background:var(--light-bg)}
    .persona-avatar{width:60px;height:60px;border-radius:50%;background:var(--gradient-3);display:flex;align-items:center;justify-content:center;color:white;font-size:1.5rem;font-weight:700;margin-right:15px}
    .persona-info{flex:1}
    .persona-name{font-weight:600;font-size:1.1rem;margin-bottom:5px}
    .persona-desc{color:var(--muted);font-size:0.9rem}
    .persona-stats{display:flex;gap:10px;margin-top:10px}
    .persona-stat{text-align:center}
    .persona-stat-value{font-weight:700;font-size:1.1rem}
    .persona-stat-label{font-size:0.8rem;color:var(--muted)}
    .marketing-action{background:var(--gradient-4);color:white;border-radius:10px;padding:15px;margin-top:15px}
    .marketing-action h5{margin-bottom:10px}
    .marketing-action ul{padding-left:20px;margin-bottom:0}
    .marketing-action li{margin-bottom:5px}
    .insight-card{border-radius:12px;padding:15px;margin-bottom:15px;background:var(--light-bg)}
    .insight-header{display:flex;justify-content:space-between;align-items-center;margin-bottom:10px}
    .insight-title{font-weight:600}
    .insight-type{background:var(--info);color:white;border-radius:20px;padding:2px 8px;font-size:0.8rem}
    .insight-content{color:var(--text)}
    .journey-timeline{position:relative;margin:20px 0}
    .journey-timeline:before{content:'';position:absolute;left:20px;top:0;width:2px;height:100%;background:var(--border)}
    .journey-event{position:relative;padding-left:50px;margin-bottom:20px}
    .journey-event:before{content:'';position:absolute;left:10px;top:5px;width:20px;height:20px;border-radius:50%;background:var(--primary)}
    .journey-date{font-weight:600;color:var(--primary);margin-bottom:5px}
    .journey-event-title{font-weight:600;margin-bottom:5px}
    .journey-event-desc{color:var(--muted);font-size:0.9rem}
    .segment-metrics{display:flex;gap:10px;margin-top:10px}
    .segment-metric{text-align:center;background:var(--light);border-radius:8px;padding:8px;flex:1}
    .segment-metric-value{font-weight:700;font-size:1.1rem}
    .segment-metric-label{font-size:0.8rem;color:var(--muted)}
  </style>
</head>
<body>
<!-- Sync Status Bar -->
<div id="syncStatusBar" class="sync-status">
  <i class="bi bi-arrow-repeat me-2"></i>
  <span id="syncStatusText">Menyegerakkan data...</span>
</div>

<div class="container py-4">

  <!-- Header -->
  <header class="d-flex justify-content-between align-items-start mb-4 fade-in">
    <div>
      <div class="brand h3 mb-1">Dashboard Pemasaran Klinik</div>
      <div class="muted">Analisis pantas & responsif</div>
      <div id="healthRow" class="mt-2 small"></div>
    </div>
    <div class="d-flex align-items-center gap-2">
      <span id="whoami" class="small muted"></span>
      <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" style="width:32px;height:32px" id="userAvatar">U</div>
    </div>
  </header>

  <!-- Sign-in Gate -->
  <div id="signinCard" class="card p-5 text-center mb-4 slide-up">
    <div class="mb-3"><i class="bi bi-shield-lock" style="font-size:2.5rem;color:var(--primary)"></i></div>
    <h5 class="mb-2">Akses Terhad kepada Kakitangan</h5>
    <p class="muted mb-3">Log masuk dengan akaun Google yang dibenarkan.</p>
    <div id="gsiBtn" class="d-inline-block"></div>
    <div id="signinMsg" class="small text-danger mt-3"></div>
  </div>

  <!-- App -->
  <main id="app" class="hidden">

    <!-- Marketing Insights Section -->
    <section class="gradient-card mb-4 fade-in">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h2><i class="bi bi-lightbulb me-2"></i>Wawasan Pemasaran Hari Ini</h2>
          <p>Berdasarkan analisis data terkini, berikut adalah peluang pemasaran yang mungkin anda terlepas:</p>
        </div>
        <button id="btnRefreshInsights" class="btn btn-light"><i class="bi bi-arrow-repeat"></i> Refresh</button>
      </div>
      <div id="marketingInsights" class="row mt-3">
        <!-- Insights will be populated here -->
      </div>
    </section>

    <!-- Penapis -->
    <section class="card p-4 mb-3 slide-up">
      <div class="section-title mb-3"><i class="bi bi-funnel me-2"></i>Penapis Data</div>
      <div class="row g-3 toolbar">
        <div class="col-12 col-md-6 col-lg-3">
          <label class="form-label fw-semibold">Tarikh Mula</label>
          <input type="date" id="startDate" class="form-control">
        </div>
        <div class="col-12 col-md-6 col-lg-3">
          <label class="form-label fw-semibold">Tarikh Tamat</label>
          <input type="date" id="endDate" class="form-control">
        </div>
        <div class="col-12 col-md-6 col-lg-3">
          <label class="form-label fw-semibold">Kod Diagnosis</label>
          <input type="text" id="filterDiag" class="form-control" placeholder="cth: URTI, INFLUENZA, MSK">
        </div>
        <div class="col-12 col-md-6 col-lg-3">
          <label class="form-label fw-semibold">Kawasan / Lokasi</label>
          <input type="text" id="filterArea" class="form-control" placeholder="cth: Manir, Kuala Terengganu">
        </div>

        <div class="col-12 d-flex flex-wrap gap-2 align-items-center mt-1">
          <button id="btnApply" class="btn btn-primary" type="button"><i class="bi bi-funnel-fill"></i> Gunakan Penapis</button>
          <button id="btnClear" class="btn btn-outline-secondary" type="button"><i class="bi bi-arrow-clockwise"></i> Set Semula</button>
          <div class="ms-auto d-flex align-items-center gap-2">
            <span class="small fw-semibold">Kumpulan Data:</span>
            <div class="btn-group" role="group">
              <input type="radio" class="btn-check" name="gran" id="gDay" checked>
              <label class="btn btn-outline-dark" for="gDay">Harian</label>
              <input type="radio" class="btn-check" name="gran" id="gMonth">
              <label class="btn btn-outline-dark" for="gMonth">Bulanan</label>
              <input type="radio" class="btn-check" name="gran" id="gYear">
              <label class="btn btn-outline-dark" for="gYear">Tahunan</label>
            </div>
          </div>
        </div>

        <div class="col-12 mt-2">
          <div class="d-flex align-items-center gap-3 w-100">
            <div class="progress w-100" style="height:8px"><div class="progress-bar" id="progressFill" style="width:0%"></div></div>
            <span id="statusLine" class="small muted">Sedia</span>
          </div>
          <div class="subtle mt-2" id="activeFilterMsg">Penapis: Semua kategori</div>
        </div>
      </div>
    </section>

    <!-- Trend Alerts -->
    <section class="card p-4 mb-3 slide-up">
      <div class="d-flex justify-content-between align-items-center">
        <div class="section-title"><i class="bi bi-activity me-2"></i>Trend Alerts (14 hari vs 14 hari)</div>
        <button id="btnReloadTrend" class="btn btn-outline-secondary btn-sm" type="button"><i class="bi bi-arrow-repeat"></i> Muat Semula</button>
      </div>
      <div id="trendBox" class="mt-2 small muted">Tiada alert signifikan buat masa ini.</div>
    </section>

    <!-- KPI -->
    <section class="stats-grid g-3 mb-3">
      <div class="stat slide-up">
        <div class="ico"><i class="bi bi-people"></i></div>
        <div>
          <div class="v" id="kpiLabeled">0</div>
          <div class="muted small">Pesakit Berlabel</div>
        </div>
      </div>
      <div class="stat slide-up" style="animation-delay:0.1s">
        <div class="ico"><i class="bi bi-tags"></i></div>
        <div>
          <div class="v" id="kpiCats">0</div>
          <div class="muted small">Kategori Diagnosis</div>
        </div>
      </div>
      <div class="stat slide-up" style="animation-delay:0.2s">
        <div class="ico"><i class="bi bi-graph-up-arrow"></i></div>
        <div>
          <div class="v" id="kpiTop">-</div>
          <div class="muted small">Diagnosis Terbanyak</div>
        </div>
      </div>
      <div class="stat slide-up" style="animation-delay:0.3s">
        <div class="ico"><i class="bi bi-telephone-outbound"></i></div>
        <div>
          <div class="v" id="kpiProspects">0</div>
          <div class="muted small">Prospek Outreach</div>
        </div>
      </div>
    </section>

    <!-- Tabs -->
    <ul class="nav nav-pills mb-3" id="tabs">
      <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-data" type="button">Data & Carta</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-predictive" type="button">Analisis Prediktif</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-journey" type="button">Perjalanan Pesakit</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-segment" type="button">Segmentasi Pesakit</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-reactivate" type="button">Re-activation 30+</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-pricing" type="button">Harga & Reminder</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-repeat" type="button">Repeat Registry</button></li>
    </ul>

    <div class="tab-content">

      <!-- TAB: Data & Carta -->
      <div class="tab-pane fade show active" id="tab-data">
        <div class="d-flex flex-wrap gap-2 mb-3">
          <button id="btnSync" class="btn btn-warning" type="button"><i class="bi bi-arrow-repeat"></i> Sync Data</button>
          <button id="btnExport" class="btn btn-outline-success" type="button"><i class="bi bi-file-earmark-spreadsheet"></i> Eksport CSV</button>
          <button id="btnSort" class="btn btn-outline-secondary" type="button"><i class="bi bi-sort-alpha-down"></i> Susun Data</button>
          <button id="btnDelete" class="btn btn-outline-danger" type="button"><i class="bi bi-trash"></i> Padam Data</button>
          <div class="ms-auto small muted">Julat: <span id="legendPeriod">-</span></div>
        </div>

        <div class="row g-3 mb-3">
          <div class="col-12 col-xl-6">
            <div class="card p-3 slide-up">
              <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Taburan Mengikut Kategori <span id="legendCalc" class="badge text-bg-light ms-2"></span></h6>
                <span id="legend1" class="small muted"></span>
              </div>
              <div class="small text-muted mb-2">Klik kategori untuk tapis jadual.</div>
              <div class="chart-h"><canvas id="chartDonut"></canvas></div>
            </div>
          </div>
          <div class="col-12 col-xl-6">
            <div class="card p-3 slide-up" style="animation-delay:0.1s">
              <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Top Kategori Diagnosis</h6>
                <span id="legend2" class="small muted"></span>
              </div>
              <div class="small text-muted mb-2">Klik bar untuk tapis ikut kategori.</div>
              <div class="chart-h"><canvas id="chartBar"></canvas></div>
            </div>
          </div>
        </div>

        <!-- Kategori Pantas -->
        <div class="card p-3 mb-3 slide-up" style="animation-delay:0.2s">
          <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <h6 class="mb-0">Kategori Pantas</h6>
            <div class="subtle">Klik kategori untuk tapis. "Semua" untuk buang penapis.</div>
          </div>
          <div id="quickCats" class="d-flex flex-wrap gap-2 mt-2"></div>
        </div>

        <!-- Graf Kehadiran -->
        <div class="card p-3 mb-3 slide-up" style="animation-delay:0.3s">
          <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div class="d-flex align-items-center gap-2">
              <h6 class="mb-0">Graf Kehadiran Pesakit</h6>
              <span id="attnInfo" class="badge text-bg-light"></span>
            </div>
            <div class="btn-group" role="group" aria-label="attn-range">
              <button class="btn btn-outline-dark btn-sm btn-range" id="attn7"  type="button">7H</button>
              <button class="btn btn-outline-dark btn-sm btn-range" id="attn14" type="button">14H</button>
              <button class="btn btn-outline-dark btn-sm btn-range active" id="attn30" type="button">30H</button>
              <button class="btn btn-outline-dark btn-sm btn-range" id="attn60" type="button">60H</button>
              <button class="btn btn-outline-dark btn-sm btn-range" id="attn365" type="button">1T</button>
            </div>
          </div>
          <div class="chart-h-lg"><canvas id="chartAttn"></canvas></div>
        </div>

        <!-- Jadual Pesakit -->
        <div class="card p-3 slide-up" style="animation-delay:0.4s">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">Senarai Pesakit (Ditapis)</h6>
            <div class="d-flex align-items-center gap-2">
              <label class="small fw-semibold me-1">Saiz Halaman:</label>
              <select id="pageSize" class="form-select form-select-sm" style="width:90px">
                <option>20</option><option>50</option><option selected>100</option><option>200</option>
              </select>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table align-middle" id="tbl">
              <thead><tr><th>#</th><th>Nama Pesakit</th><th>Umur</th><th>Kod Diagnosis</th><th>Tarikh Lawatan</th><th>No. Telefon</th><th>WhatsApp</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="d-flex justify-content-between align-items-center mt-2">
            <div id="pageInfo" class="small muted">-</div>
            <div class="d-flex gap-2">
              <button class="btn btn-outline-secondary btn-sm" id="btnPrev" type="button"><i class="bi bi-chevron-left"></i> Sebelumnya</button>
              <button class="btn btn-outline-secondary btn-sm" id="btnNext" type="button">Seterusnya <i class="bi bi-chevron-right"></i></button>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: Predictive Analytics -->
      <div class="tab-pane fade" id="tab-predictive">
        <div class="row g-3 mb-3">
          <div class="col-12 col-lg-6">
            <div class="card p-3">
              <h6 class="mb-3">Ramalan Trend Penyakit</h6>
              <div class="mb-3">
                <label class="form-label">Pilih Penyakit:</label>
                <select id="diseaseSelect" class="form-select">
                  <option value="">Pilih penyakit...</option>
                </select>
              </div>
              <div class="chart-h-lg"><canvas id="predictionChart"></canvas></div>
              <div class="mt-2 small text-muted">
                <i class="bi bi-info-circle me-1"></i>
                Ramalan berdasarkan data historikal 6 bulan terakhir
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-6">
            <div class="card p-3">
              <h6 class="mb-3">Analisis Nilai Sepanjang Hayat Pesakit (LTV)</h6>
              <div class="chart-h-lg"><canvas id="ltvChart"></canvas>
              <div class="mt-2 small text-muted">
                <i class="bi bi-info-circle me-1"></i>
                LTV dianggarkan berdasarkan frekuensi lawatan dan jenis rawatan
              </div>
            </div>
          </div>
        </div>
        
        <div class="row g-3 mb-3">
          <div class="col-12 col-lg-6">
            <div class="card p-3">
              <h6 class="mb-3">Ramalan Kadar Pertukaran Prospek</h6>
              <div class="chart-h-lg"><canvas id="conversionChart"></canvas>
              <div class="mt-2 small text-muted">
                <i class="bi bi-info-circle me-1"></i>
                Analisis kadar pertukaran dari prospek ke pesakit aktif
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-6">
            <div class="card p-3">
              <h6 class="mb-3">Risiko Kehilangan Pesakit</h6>
              <div id="churnRiskList" class="mt-3">
                <!-- Churn risk list will be populated here -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: Patient Journey -->
      <div class="tab-pane fade" id="tab-journey">
        <div class="row g-3 mb-3">
          <div class="col-12 col-lg-8">
            <div class="card p-3">
              <h6 class="mb-3">Peta Perjalanan Pesakit</h6>
              <div class="mb-3">
                <label class="form-label">Pilih Pesakit:</label>
                <select id="patientSelect" class="form-select">
                  <option value="">Pilih pesakit...</option>
                </select>
              </div>
              <div class="journey-timeline" id="patientJourney">
                <!-- Patient journey will be populated here -->
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-4">
            <div class="card p-3">
              <h6 class="mb-3">Titik Sentuh Kritikal</h6>
              <div id="touchpointsList">
                <!-- Touchpoints list will be populated here -->
              </div>
            </div>
          </div>
        </div>
        
        <div class="row g-3 mb-3">
          <div class="col-12">
            <div class="card p-3">
              <h6 class="mb-3">Analisis Tempoh Menunggu</h6>
              <div class="chart-h-lg"><canvas id="waitingTimeChart"></canvas>
              <div class="mt-2 small text-muted">
                <i class="bi bi-info-circle me-1"></i>
                Impak tempoh menunggu terhadap kepuasan pesakit
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: Patient Segmentation -->
      <div class="tab-pane fade" id="tab-segment">
        <div class="row g-3 mb-3">
          <div class="col-12 col-lg-8">
            <div class="card p-3">
              <h6 class="mb-3">Segmentasi Pesakit Dinamik</h6>
              <div class="chart-h-lg"><canvas id="segmentChart"></canvas>
              <div class="mt-2 small text-muted">
                <i class="bi bi-info-circle me-1"></i>
                Segmentasi berdasarkan demografi, diagnosis, frekuensi lawatan, dan nilai
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-4">
            <div class="card p-3">
              <h6 class="mb-3">Potensi Pemasaran Segmen</h6>
              <div id="segmentPotential">
                <!-- Segment potential will be populated here -->
              </div>
            </div>
          </div>
        </div>
        
        <div class="row g-3 mb-3">
          <div class="col-12">
            <div class="card p-3">
              <h6 class="mb-3">Persona Pesakit</h6>
              <div id="personasList" class="row">
                <!-- Personas will be populated here -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: Re-activation -->
      <div class="tab-pane fade" id="tab-reactivate">
        <div class="d-flex align-items-center gap-2 mb-2">
          <div class="chip"><i class="bi bi-clock-history me-1"></i> Tidak datang ≥30 hari</div>
          <button id="btnReloadReAct" class="btn btn-outline-secondary btn-sm" type="button"><i class="bi bi-arrow-repeat"></i> Muat Semula</button>
        </div>
        <div class="card p-3">
          <div class="table-responsive">
            <table class="table align-middle" id="tblReAct">
              <thead><tr><th>#</th><th>Nama</th><th>Telefon</th><th>Kategori Terakhir</th><th>Tarikh Terakhir</th><th>Hari Senyap</th><th>WhatsApp</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- TAB: Pricing -->
      <div class="tab-pane fade" id="tab-pricing">
        <div class="row g-3">
          <div class="col-12 col-lg-6">
            <div class="card p-3">
              <h6 class="mb-2">Harga Rawatan (Manual)</h6>
              <div class="row g-2">
                <div class="col-4"><input id="priceCode" class="form-control" placeholder="cth: URTI"></div>
                <div class="col-5"><input id="priceName" class="form-control" placeholder="Nama (opsyen)"></div>
                <div class="col-3"><input id="priceValue" class="form-control" type="number" placeholder="Harga"></div>
                <div class="col-12"><button id="btnSavePrice" class="btn btn-success w-100" type="button"><i class="bi bi-save"></i> Simpan Harga</button></div>
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-6">
            <div class="card p-3">
              <h6 class="mb-2">Senarai Harga</h6>
              <ul id="priceList" class="list-group small"></ul>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: Repeat Registry -->
      <div class="tab-pane fade" id="tab-repeat">
        <div class="row g-3">
          <div class="col-12 col-lg-6">
            <div class="card p-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Daftar Ulang Tahunan / Berkala</h6>
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" role="switch" id="autoVaxSwitch" checked>
                  <label class="form-check-label small" for="autoVaxSwitch">Auto daftar vaksin bila data dimuat</label>
                </div>
              </div>
              <div class="row g-2">
                <div class="col-6"><input id="repName" class="form-control" placeholder="Nama Pesakit"></div>
                <div class="col-6"><input id="repPhone" class="form-control" placeholder="Telefon"></div>
                <div class="col-6">
                  <label class="small fw-semibold ms-1">Tarikh Servis Terakhir</label>
                  <input id="repLast" type="date" class="form-control">
                </div>
                <div class="col-6"><input id="repType" class="form-control" placeholder="Jenis (cth: Influenza)"></div>
                <div class="col-6">
                  <label class="small fw-semibold ms-1">Kitaran (hari)</label>
                  <input id="repEvery" class="form-control" type="number" value="365">
                </div>
                <div class="col-6">
                  <label class="small fw-semibold ms-1">Due Seterusnya (opsyen)</label>
                  <input id="repNext" type="date" class="form-control">
                </div>
                <div class="col-12"><input id="repNote" class="form-control" placeholder="Nota (opsyen)"></div>
                <div class="col-12 d-flex gap-2">
                  <button id="btnRepSave" class="btn btn-success flex-fill" type="button"><i class="bi bi-plus-circle"></i> Simpan</button>
                  <button id="btnScanVaxNow" class="btn btn-outline-primary" type="button"><i class="bi bi-eyedropper"></i> Imbas Sekali Lagi</button>
                </div>
              </div>
              <div class="small text-muted mt-2" id="autoVaxMsg">-</div>
            </div>
          </div>
          <div class="col-12 col-lg-6">
            <div class="card p-3">
              <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-2">Akan Due (14 hari akan datang)</h6>
                <button id="btnRepDue" class="btn btn-outline-secondary btn-sm" type="button"><i class="bi bi-arrow-repeat"></i> Muat Semula</button>
              </div>
              <div class="table-responsive">
                <table class="table align-middle small" id="tblRepDue">
                  <thead><tr><th>#</th><th>Nama</th><th>Telefon</th><th>Jenis</th><th>Due</th><th>WhatsApp</th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div><!-- /tab-content -->

    <footer class="text-center muted small mt-4 py-3">
      © 2025 Klinik — Dashboard Pemasaran. Data dalaman.
    </footer>
  </main><!-- /app -->

  <!-- Floating Action Button -->
  <div class="floating-action">
    <button id="fabSync" class="btn btn-primary btn-lg rounded-circle pulse" style="width:56px;height:56px;display:none">
      <i class="bi bi-arrow-repeat"></i>
    </button>
  </div>

</div><!-- /container -->

<!-- Toast area -->
<div class="toast-area">
  <div id="toast" class="toast text-bg-dark border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="toastBody">OK</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>

<!-- ===== App Script ===== -->
<script nonce="n123">
/************ KONFIG ************/
const CLIENT_ID   = '366415747851-9p6fegh84hkfs74prtmtj09ldsp2vi3m.apps.googleusercontent.com';
const BACKEND_URL = 'https://script.google.com/macros/s/AKfycby1A1DrDRsoW3CP9tDI1EMdLzVBaCeubhT5HOaFLQQtQ3K7GEYbgows-WgGLSQV71fX/exec';

/************ STATE ************/
let ID_TOKEN=null;
let donutChart, barChart, attnChart, predictionChart, ltvChart, conversionChart, waitingTimeChart, segmentChart;
let CUR_PAGE=1;
let LAST_PATIENT_ROWS=[];
let AUTO_VAX_SESSION_KEYS=new Set();
let CURRENT_LIST_DONUT=[], CURRENT_LIST_BAR=[];
let CODE_NAME_MAP = {}; // code -> friendly name
const CHART_ANIM = false;
let isLoading = false;
let loadingTimeout;
let isSyncing = false;
let PATIENT_JOURNEY_DATA = {};
let SEGMENTATION_DATA = {};
let PREDICTIVE_DATA = {};

/************ DOM helpers ************/
const $ = (q)=>document.querySelector(q);
const show = el => el.classList.remove('hidden');
const hide = el => el.classList.add('hidden');
const pickGran = () => $('#gYear').checked?'year':($('#gMonth').checked?'month':'day');
const fmtPeriod = (s,e)=>`${s} → ${e}`;
const Toast = { show(msg){ $('#toastBody').textContent=msg; const t=bootstrap.Toast.getOrCreateInstance($('#toast')); t.show(); } };

// Loading states
const setLoading = (loading) => {
  isLoading = loading;
  if (loading) {
    clearTimeout(loadingTimeout);
    loadingTimeout = setTimeout(() => {
      document.querySelectorAll('.card').forEach(card => {
        if (!card.querySelector('.skeleton-container')) {
          const skeletonContainer = document.createElement('div');
          skeletonContainer.className = 'skeleton-container';
          skeletonContainer.innerHTML = '<div class="skeleton"></div><div class="skeleton"></div><div class="skeleton"></div>';
          card.appendChild(skeletonContainer);
        }
      });
    }, 300);
  } else {
    clearTimeout(loadingTimeout);
    document.querySelectorAll('.skeleton-container').forEach(el => el.remove());
  }
};

// Sync status bar
const showSyncStatus = (message, show = true) => {
  const statusBar = $('#syncStatusBar');
  const statusText = $('#syncStatusText');
  
  statusText.textContent = message;
  if (show) {
    statusBar.classList.add('show');
  } else {
    statusBar.classList.remove('show');
  }
};

// Performance optimization: Debounce function
const debounce = (func, wait) => {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
};

// Performance optimization: Throttle function
const throttle = (func, limit) => {
  let inThrottle;
  return function() {
    const args = arguments;
    const context = this;
    if (!inThrottle) {
      func.apply(context, args);
      inThrottle = true;
      setTimeout(() => inThrottle = false, limit);
    }
  };
};

/************ AUTH + INIT ************/
window.onload = () => {
  // default: bulan semasa
  const d=new Date(), s=new Date(d.getFullYear(),d.getMonth(),1), e=new Date(d.getFullYear(),d.getMonth()+1,0);
  $('#startDate').value = s.toISOString().slice(0,10);
  $('#endDate').value   = e.toISOString().slice(0,10);

  // Actions with debouncing for performance
  $('#btnApply').addEventListener('click', debounce(() => { CUR_PAGE=1; loadPatients(true,{refreshGlobal:true}); }, 300));
  $('#btnClear').addEventListener('click', debounce(() => { $('#filterDiag').value=''; $('#filterArea').value=''; CUR_PAGE=1; loadPatients(true,{refreshGlobal:true}); }, 300));
  $('#btnPrev').addEventListener('click', () => { if (CUR_PAGE>1){ CUR_PAGE--; loadPatients(false); } });
  $('#btnNext').addEventListener('click', () => { CUR_PAGE++; loadPatients(false); });
  $('#pageSize').addEventListener('change', () => { CUR_PAGE=1; loadPatients(false); });
  $('#btnExport').addEventListener('click', exportCSV);

  $('#btnSync').addEventListener('click', startSync);
  $('#btnDelete').addEventListener('click', deleteRange);
  $('#btnSort').addEventListener('click', sortRange);

  $('#btnReloadTrend').addEventListener('click', loadTrends);
  $('#btnReloadReAct').addEventListener('click', loadReactivation);
  $('#btnRefreshInsights').addEventListener('click', loadMarketingInsights);

  $('#btnSavePrice').addEventListener('click', savePrice);
  $('#btnRepSave').addEventListener('click', saveRepeat);
  $('#btnRepDue').addEventListener('click', loadRepeatDue);

  // Floating action button
  $('#fabSync').addEventListener('click', startSync);

  ['attn7','attn14','attn30','attn60','attn365'].forEach(id=>{
    $('#'+id).addEventListener('click', async ()=>{
      document.querySelectorAll('.btn-range').forEach(b=>b.classList.remove('active'));
      $('#'+id).classList.add('active');
      const map={attn7:7, attn14:14, attn30:30, attn60:60, attn365:365};
      await drawAttendance(map[id]);
    });
  });

  $('#btnScanVaxNow').addEventListener('click', ()=>scanVaccinations(LAST_PATIENT_ROWS,true));

  // Tab change events for new features
  document.querySelectorAll('[data-bs-toggle="pill"]').forEach(tab => {
    tab.addEventListener('shown.bs.tab', (e) => {
      const target = e.target.getAttribute('data-bs-target');
      
      if (target === '#tab-predictive') {
        loadPredictiveAnalytics();
      } else if (target === '#tab-journey') {
        loadPatientJourney();
      } else if (target === '#tab-segment') {
        loadPatientSegmentation();
      }
    });
  });

  // Disease selection change event
  $('#diseaseSelect').addEventListener('change', () => {
    updateDiseasePrediction();
  });

  // Patient selection change event
  $('#patientSelect').addEventListener('change', () => {
    updatePatientJourney();
  });

  // Show/hide FAB based on scroll
  window.addEventListener('scroll', throttle(() => {
    if (window.scrollY > 200) {
      $('#fabSync').style.display = 'flex';
    } else {
      $('#fabSync').style.display = 'none';
    }
  }, 100));

  initGSI();
};

function initGSI(){
  if (!window.google || !google.accounts || !google.accounts.id){
    $('#signinMsg').textContent='Gagal memuatkan Google SSO.'; return;
  }
  google.accounts.id.initialize({ client_id:CLIENT_ID, callback:onSignIn, ux_mode:'popup' });
  google.accounts.id.renderButton($('#gsiBtn'), { theme:'outline', size:'large', shape:'pill' });
}

async function onSignIn(resp){
  try{
    ID_TOKEN = resp.credential;
    hide($('#signinCard')); show($('#app'));

    const payload = JSON.parse(atob(resp.credential.split('.')[1]));
    $('#whoami').textContent = payload.name || payload.email;
    $('#userAvatar').textContent = (payload.name || 'U').charAt(0).toUpperCase();

    healthCheck();

    await loadPatients(true, { refreshGlobal:true });
    await Promise.all([loadPricing(), loadRepeatDue(), loadMarketingInsights()]);
  }catch(e){
    console.error(e);
    $('#signinMsg').textContent='Log masuk gagal.';
  }
}

/************ BACKEND CALL ************/
async function callAPI(action, payload){
  if (!ID_TOKEN) throw new Error('Belum log masuk');
  const res = await fetch(BACKEND_URL,{
    method:'POST', mode:'cors', credentials:'omit',
    headers:{ 'Content-Type':'text/plain' },
    body: JSON.stringify({ action, id_token:ID_TOKEN, payload })
  });
  if (!res.ok) throw new Error(await res.text());
  return res.json();
}

/************ HEALTH ************/
async function healthCheck(){
  try{
    const r = await callAPI('health',{});
    const ok = r && r.ok;
    const cfg = r.cfg || {};
    $('#healthRow').innerHTML =
      `<span class="health-indicator health-${ok?'ok':'error'}"></span>
       <span class="badge bg-${ok?'success':'danger'} me-2"><i class="bi bi-heart-pulse"></i> Backend ${ok?'OK':'Down'}</span>
       <span class="badge text-bg-light me-1">ClientID:${cfg.clientIdSet?'✓':'✗'}</span>
       <span class="badge text-bg-light me-1">Token:${cfg.hasToken?'✓':'✗'}</span>
       <span class="badge text-bg-light me-1">Clinic:${cfg.hasClinic?'✓':'✗'}</span>`;
  }catch(e){
    $('#healthRow').innerHTML = `<span class="health-indicator health-error"></span><span class="badge bg-danger">Backend Error</span>`;
  }
}

/************ SUMMARY (FAST PATH + cache klien) ************/
let LAST_SUMMARY_KEY = '';
let LAST_SUMMARY_OBJ = null;

async function loadSummary(){
  const s=$('#startDate').value, e=$('#endDate').value;
  const key = `${s}|${e}`;
  if (LAST_SUMMARY_KEY===key && LAST_SUMMARY_OBJ) return LAST_SUMMARY_OBJ;

  try{
    let data = await callAPI('get_summary_range',{ start:s, end:e });
    if (!data.rows || !data.rows.length){
      await callAPI('compute_range',{ start:s, end:e });
      data = await callAPI('get_summary_range',{ start:s, end:e });
    }
    LAST_SUMMARY_KEY = key;
    LAST_SUMMARY_OBJ = data || { labeled:0, rows:[] };
    return LAST_SUMMARY_OBJ;
  }catch(err){
    console.warn('summary error:', err.message);
    return { labeled:0, rows:[] };
  }
}

/************ MARKETING INSIGHTS ************/
async function loadMarketingInsights(){
  try{
    const insights = await callAPI('marketing_insights',{});
    renderMarketingInsights(insights);
  }catch(err){
    console.warn('marketing insights error:', err.message);
    renderMarketingInsights([]);
  }
}

function renderMarketingInsights(insights){
  const container = $('#marketingInsights');
  container.innerHTML = '';
  
  if (!insights || !insights.length) {
    container.innerHTML = '<div class="col-12"><div class="alert alert-info">Tiada wawasan pemasaran tersedia pada masa ini.</div></div>';
    return;
  }
  
  insights.forEach((insight, index) => {
    const col = document.createElement('div');
    col.className = 'col-md-6 col-lg-4 mb-3';
    
    const bgColor = index % 3 === 0 ? 'rgba(13, 110, 253, 0.1)' : 
                   index % 3 === 1 ? 'rgba(25, 135, 84, 0.1)' : 
                   'rgba(255, 193, 7, 0.1)';
    
    const iconColor = index % 3 === 0 ? 'text-primary' : 
                     index % 3 === 1 ? 'text-success' : 
                     'text-warning';
    
    col.innerHTML = `
      <div class="card h-100" style="background-color: ${bgColor}">
        <div class="card-body">
          <div class="d-flex align-items-center mb-2">
            <i class="bi ${insight.icon || 'bi-lightbulb'} ${iconColor} me-2"></i>
            <h6 class="card-title mb-0">${insight.title || 'Wawasan Pemasaran'}</h6>
          </div>
          <p class="card-text">${insight.description || 'Tiada deskripsi tersedia.'}</p>
          <div class="d-flex justify-content-between align-items-center">
            <span class="badge bg-light text-dark">${insight.type || 'Umum'}</span>
            <button class="btn btn-sm btn-outline-primary" onclick="applyInsight('${insight.id || ''}')">
              <i class="bi bi-arrow-right"></i> Tindakan
            </button>
          </div>
        </div>
      </div>
    `;
    
    container.appendChild(col);
  });
}

function applyInsight(insightId) {
  // This function would apply the recommended marketing action
  Toast.show('Tindakan pemasaran akan dilaksanakan');
  // Implementation would depend on the specific insight
}

/************ PREDICTIVE ANALYTICS ************/
async function loadPredictiveAnalytics(){
  try{
    // Load disease data for dropdown
    const taxonomy = await callAPI('taxonomy_list',{});
    populateDiseaseSelect(taxology.items || []);
    
    // Load predictive data
    const predictiveData = await callAPI('predictive_analytics',{});
    PREDICTIVE_DATA = predictiveData;
    
    // Initialize charts
    initializePredictionCharts();
    
    // Load churn risk data
    const churnData = await callAPI('churn_risk',{});
    renderChurnRisk(churnData.risks || []);
    
  }catch(err){
    console.warn('predictive analytics error:', err.message);
  }
}

function populateDiseaseSelect(diseases) {
  const select = $('#diseaseSelect');
  select.innerHTML = '<option value="">Pilih penyakit...</option>';
  
  // Filter to only include actual diseases
  const actualDiseases = diseases.filter(d => d.is_disease === 'true');
  
  actualDiseases.forEach(disease => {
    const option = document.createElement('option');
    option.value = disease.code;
    option.textContent = disease.name;
    select.appendChild(option);
  });
}

function initializePredictionCharts() {
  // Disease trend prediction chart
  const predictionCtx = $('#predictionChart');
  if (predictionChart) predictionChart.destroy();
  
  predictionChart = new Chart(predictionCtx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label: 'Data Sebenar',
        data: [],
        borderColor: 'rgb(13, 110, 253)',
        backgroundColor: 'rgba(13, 110, 253, 0.1)',
        tension: 0.1
      }, {
        label: 'Ramalan',
        data: [],
        borderColor: 'rgb(255, 99, 132)',
        backgroundColor: 'rgba(255, 99, 132, 0.1)',
        borderDash: [5, 5]
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Bilangan Kes'
          }
        },
        x: {
          title: {
            display: true,
            text: 'Tarikh'
          }
        }
      },
      plugins: {
        tooltip: {
          mode: 'index',
          intersect: false
        }
      }
    }
  });
  
  // LTV chart
  const ltvCtx = $('#ltvChart');
  if (ltvChart) ltvChart.destroy();
  
  ltvChart = new Chart(ltvCtx, {
    type: 'bar',
    data: {
      labels: [],
      datasets: [{
        label: 'Nilai Sepanjang Hayat (RM)',
        data: [],
        backgroundColor: 'rgba(25, 135, 84, 0.7)',
        borderColor: 'rgb(25, 135, 84)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'RM'
          }
        }
      }
    }
  });
  
  // Conversion chart
  const conversionCtx = $('#conversionChart');
  if (conversionChart) conversionChart.destroy();
  
  conversionChart = new Chart(conversionCtx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label: 'Kadar Pertukaran (%)',
        data: [],
        borderColor: 'rgb(255, 193, 7)',
        backgroundColor: 'rgba(255, 193, 7, 0.1)',
        tension: 0.1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          max: 100,
          title: {
            display: true,
            text: '%'
          }
        }
      }
    }
  });
}

function updateDiseasePrediction() {
  const selectedDisease = $('#diseaseSelect').value;
  
  if (!selectedDisease || !PREDICTIVE_DATA.disease_trends) {
    return;
  }
  
  const diseaseData = PREDICTIVE_DATA.disease_trends[selectedDisease];
  
  if (!diseaseData) {
    return;
  }
  
  // Update prediction chart
  predictionChart.data.labels = diseaseData.labels || [];
  predictionChart.data.datasets[0].data = diseaseData.actual || [];
  predictionChart.data.datasets[1].data = diseaseData.predicted || [];
  predictionChart.update();
}

function renderChurnRisk(risks) {
  const container = $('#churnRiskList');
  container.innerHTML = '';
  
  if (!risks.length) {
    container.innerHTML = '<div class="alert alert-info">Tiada risiko kehilangan pesakit yang tinggi dikesan.</div>';
    return;
  }
  
  risks.forEach(risk => {
    const riskLevel = risk.risk_level || 'medium';
    const riskClass = riskLevel === 'high' ? 'danger' : 
                     riskLevel === 'medium' ? 'warning' : 'success';
    
    const riskItem = document.createElement('div');
    riskItem.className = 'card mb-2';
    riskItem.innerHTML = `
      <div class="card-body p-3">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="mb-1">${risk.name || 'Pesakit Tanpa Nama'}</h6>
            <div class="small text-muted">Lawatan terakhir: ${risk.last_visit || 'Tidak diketahui'}</div>
          </div>
          <span class="churn-risk ${riskLevel}">${riskLevel === 'high' ? 'Tinggi' : riskLevel === 'medium' ? 'Sederhana' : 'Rendah'}</span>
        </div>
        <div class="mt-2">
          <div class="small text-muted">Cadangan tindakan:</div>
          <div class="small">${risk.recommendation || 'Hubungi pesakit untuk temujanji susulan'}</div>
        </div>
      </div>
    `;
    
    container.appendChild(riskItem);
  });
}

/************ PATIENT JOURNEY ************/
async function loadPatientJourney(){
  try{
    // Load patient data for dropdown
    const patients = await callAPI('patients_list',{});
    populatePatientSelect(patients.rows || []);
    
    // Load touchpoints data
    const touchpoints = await callAPI('touchpoints',{});
    renderTouchpoints(touchpoints.points || []);
    
    // Initialize waiting time chart
    initializeWaitingTimeChart();
    
  }catch(err){
    console.warn('patient journey error:', err.message);
  }
}

function populatePatientSelect(patients) {
  const select = $('#patientSelect');
  select.innerHTML = '<option value="">Pilih pesakit...</option>';
  
  patients.forEach(patient => {
    const option = document.createElement('option');
    option.value = patient.phone || patient.name;
    option.textContent = `${patient.name} (${patient.phone})`;
    select.appendChild(option);
  });
}

function renderTouchpoints(touchpoints) {
  const container = $('#touchpointsList');
  container.innerHTML = '';
  
  if (!touchpoints.length) {
    container.innerHTML = '<div class="alert alert-info">Tiada titik sentuh kritikal dikesan.</div>';
    return;
  }
  
  touchpoints.forEach(point => {
    const pointItem = document.createElement('div');
    pointItem.className = 'journey-step';
    pointItem.innerHTML = `
      <div class="journey-title">${point.name || 'Titik Sentuh'}</div>
      <div class="journey-desc">${point.description || 'Tiada deskripsi'}</div>
      <div class="mt-2">
        <span class="badge bg-primary">${point.conversion_rate || 0}% pertukaran</span>
        <span class="badge bg-secondary ms-1">${point.avg_time || 0} min</span>
      </div>
    `;
    
    container.appendChild(pointItem);
  });
}

function initializeWaitingTimeChart() {
  const ctx = $('#waitingTimeChart');
  if (waitingTimeChart) waitingTimeChart.destroy();
  
  waitingTimeChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: [],
      datasets: [{
        label: 'Tempoh Menunggu (minit)',
        data: [],
        backgroundColor: 'rgba(13, 110, 253, 0.7)',
        borderColor: 'rgb(13, 110, 253)',
        borderWidth: 1
      }, {
        label: 'Kepuasan Pesakit',
        data: [],
        backgroundColor: 'rgba(25, 135, 84, 0.7)',
        borderColor: 'rgb(25, 135, 84)',
        borderWidth: 1,
        yAxisID: 'y1'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Minit'
          }
        },
        y1: {
          position: 'right',
          beginAtZero: true,
          max: 100,
          title: {
            display: true,
            text: 'Kepuasan (%)'
          },
          grid: {
            drawOnChartArea: false
          }
        }
      }
    }
  });
}

function updatePatientJourney() {
  const selectedPatient = $('#patientSelect').value;
  
  if (!selectedPatient) {
    $('#patientJourney').innerHTML = '<div class="alert alert-info">Sila pilih pesakit untuk melihat perjalanan mereka.</div>';
    return;
  }
  
  // In a real implementation, this would fetch the patient journey data
  // For now, we'll use mock data
  const mockJourney = [
    { date: '2023-01-15', title: 'Temujanji Pertama', desc: 'Pesakit datang untuk konsultasi awal' },
    { date: '2023-01-22', title: 'Ujian Makmal', desc: 'Pesakit menjalani ujian makmal' },
    { date: '2023-01-29', title: 'Diagnosis', desc: 'Pesakit menerima diagnosis rasmi' },
    { date: '2023-02-05', title: 'Rawatan Pertama', desc: 'Pesakit memulakan rawatan' },
    { date: '2023-02-19', title: 'Tindak Susulan', desc: 'Pesakit datang untuk tinjauan semula' }
  ];
  
  const container = $('#patientJourney');
  container.innerHTML = '';
  
  mockJourney.forEach(event => {
    const eventItem = document.createElement('div');
    eventItem.className = 'journey-event';
    eventItem.innerHTML = `
      <div class="journey-date">${event.date}</div>
      <div class="journey-event-title">${event.title}</div>
      <div class="journey-event-desc">${event.desc}</div>
    `;
    
    container.appendChild(eventItem);
  });
}

/************ PATIENT SEGMENTATION ************/
async function loadPatientSegmentation(){
  try{
    // Load segmentation data
    const segmentationData = await callAPI('patient_segmentation',{});
    SEGMENTATION_DATA = segmentationData;
    
    // Initialize segment chart
    initializeSegmentChart();
    
    // Render segment potential
    renderSegmentPotential(segmentationData.segments || []);
    
    // Render personas
    renderPersonas(segmentationData.personas || []);
    
  }catch(err){
    console.warn('patient segmentation error:', err.message);
  }
}

function initializeSegmentChart() {
  const ctx = $('#segmentChart');
  if (segmentChart) segmentChart.destroy();
  
  segmentChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: [],
      datasets: [{
        data: [],
        backgroundColor: [
          'rgba(13, 110, 253, 0.7)',
          'rgba(25, 135, 84, 0.7)',
          'rgba(255, 193, 7, 0.7)',
          'rgba(220, 53, 69, 0.7)',
          'rgba(111, 66, 193, 0.7)'
        ],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom'
        }
      }
    }
  });
  
  // Update with actual data if available
  if (SEGMENTATION_DATA.segments) {
    segmentChart.data.labels = SEGMENTATION_DATA.segments.map(s => s.name);
    segmentChart.data.datasets[0].data = SEGMENTATION_DATA.segments.map(s => s.count);
    segmentChart.update();
  }
}

function renderSegmentPotential(segments) {
  const container = $('#segmentPotential');
  container.innerHTML = '';
  
  if (!segments.length) {
    container.innerHTML = '<div class="alert alert-info">Tiada segmen pesakit dikesan.</div>';
    return;
  }
  
  segments.forEach(segment => {
    const segmentItem = document.createElement('div');
    segmentItem.className = 'segment-card';
    segmentItem.innerHTML = `
      <div class="segment-header">
        <div class="segment-title">${segment.name || 'Segmen Tanpa Nama'}</div>
        <div class="segment-size">${segment.count || 0} pesakit</div>
      </div>
      <div class="segment-metrics">
        <div class="segment-metric">
          <div class="segment-metric-value">RM${segment.avg_ltv || 0}</div>
          <div class="segment-metric-label">LTV Purata</div>
        </div>
        <div class="segment-metric">
          <div class="segment-metric-value">${segment.conversion_rate || 0}%</div>
          <div class="segment-metric-label">Kadar Pertukaran</div>
        </div>
        <div class="segment-metric">
          <div class="segment-metric-value">${segment.retention_rate || 0}%</div>
          <div class="segment-metric-label">Kadar Kekalan</div>
        </div>
      </div>
      <div class="marketing-action">
        <h5><i class="bi bi-megaphone me-2"></i>Strategi Pemasaran</h5>
        <ul>
          <li>${segment.strategy_1 || 'Fokus pada komunikasi peribadi'}</li>
          <li>${segment.strategy_2 || 'Tawarkan promosi eksklusif'}</li>
          <li>${segment.strategy_3 || 'Sediakan maklumat berkaitan'}</li>
        </ul>
      </div>
    `;
    
    container.appendChild(segmentItem);
  });
}

function renderPersonas(personas) {
  const container = $('#personasList');
  container.innerHTML = '';
  
  if (!personas.length) {
    container.innerHTML = '<div class="col-12"><div class="alert alert-info">Tiada persona pesakit dikesan.</div></div>';
    return;
  }
  
  personas.forEach(persona => {
    const personaCol = document.createElement('div');
    personaCol.className = 'col-md-6 col-lg-4 mb-3';
    
    personaCol.innerHTML = `
      <div class="persona-card">
        <div class="d-flex align-items-center">
          <div class="persona-avatar">${persona.name ? persona.name.charAt(0).toUpperCase() : 'P'}</div>
          <div class="persona-info">
            <div class="persona-name">${persona.name || 'Persona Tanpa Nama'}</div>
            <div class="persona-desc">${persona.description || 'Tiada deskripsi'}</div>
          </div>
        </div>
        <div class="persona-stats">
          <div class="persona-stat">
            <div class="persona-stat-value">${persona.age_range || 'Tidak diketahui'}</div>
            <div class="persona-stat-label">Umur</div>
          </div>
          <div class="persona-stat">
            <div class="persona-stat-value">${persona.visit_frequency || 'Tidak diketahui'}</div>
            <div class="persona-stat-label">Frekuensi Lawatan</div>
          </div>
          <div class="persona-stat">
            <div class="persona-stat-value">RM${persona.avg_spend || 0}</div>
            <div class="persona-stat-label">Perbelanjaan Purata</div>
          </div>
        </div>
        <div class="marketing-action">
          <h5><i class="bi bi-bullseye me-2"></i>Tindakan Pemasaran</h5>
          <ul>
            <li>${persona.action_1 || 'Hantar promosi berkaitan'}</li>
            <li>${persona.action_2 || 'Sediakan maklumat relevan'}</li>
            <li>${persona.action_3 || 'Gunakan saluran komunikasi pilihan'}</li>
          </ul>
        </div>
      </div>
    `;
    
    container.appendChild(personaCol);
  });
}

/************ CHARTS + QUICK CATS ************/
function buildLocalSummary(rows){
  const counts={}; let labeled=0;
  rows.forEach(r=>{
    const codes=(r.diagnosisCodes||'').toString().toUpperCase().split(/[,\s]+/).filter(Boolean);
    if (codes.length){ labeled++; codes.forEach(c=>counts[c]=(counts[c]||0)+1); }
  });
  const list=Object.entries(counts).map(([code,count])=>({name:CODE_NAME_MAP[code]||code, code, count, pct:0}));
  const total=Object.values(counts).reduce((a,b)=>a+b,0)||1;
  list.forEach(x=>x.pct=Math.round(x.count*1000/total)/10);
  list.sort((a,b)=>b.count-a.count);
  return { labeled, list, counts, topName:list[0]?.name||'-' };
}
function drawDonut(list){
  CURRENT_LIST_DONUT = list.slice();
  const ctx=$('#chartDonut');
  const labels=list.map(d=>d.name), values=list.map(d=>d.pct);
  if (donutChart) donutChart.destroy();
  donutChart=new Chart(ctx,{
    type:'doughnut',
    data:{ labels, datasets:[{ data:values, backgroundColor:genColors(list.length), borderWidth:1, borderColor:'#fff' }]},
    options:{ animation:CHART_ANIM, plugins:{ legend:{ position:'bottom', labels:{ boxWidth:12, padding:14, font:{size:11} } } }, cutout:'65%', maintainAspectRatio:false,
      onClick: (_evt, el)=> {
        if (!el?.length) return;
        const idx = el[0].index;
        const code = CURRENT_LIST_DONUT[idx]?.code || CURRENT_LIST_DONUT[idx]?.name;
        if (!code) return;
        applyCategoryFilter(code);
      }
    }
  });
}
function drawBar(list){
  CURRENT_LIST_BAR = list.slice();
  const ctx=$('#chartBar');
  const labels=list.map(d=>d.name), values=list.map(d=>d.count);
  if (barChart) barChart.destroy();
  barChart=new Chart(ctx,{
    type:'bar',
    data:{ labels, datasets:[{ data:values, backgroundColor:genColors(list.length), borderWidth:0, borderRadius:4 }]},
    options:{ animation:CHART_ANIM, plugins:{ legend:{display:false}},
      scales:{ y:{beginAtZero:true, grid:{color:'rgba(0,0,0,.05)'}}, x:{grid:{display:false}} }, maintainAspectRatio:false,
      onClick: (_evt, el)=>{
        if (!el?.length) return;
        const idx = el[0].index;
        const code = CURRENT_LIST_BAR[idx]?.code || CURRENT_LIST_BAR[idx]?.name;
        if (!code) return;
        applyCategoryFilter(code);
      }
    }
  });
}
function genColors(n){
  const base=['#0d6efd','#198754','#ffc107','#dc3545','#6f42c1','#fd7e14','#20c997','#0dcaf0','#d63384','#6610f2'];
  return Array.from({length:n},(_,i)=>base[i%base.length]);
}
function renderQuickCats(list){
  const box = $('#quickCats'); box.innerHTML='';
  if (!list || !list.length){ box.innerHTML = `<span class="subtle">Tiada kategori ditemui.</span>`; return; }
  const all = document.createElement('button'); all.className = 'cat-chip'; all.textContent = 'Semua';
  all.addEventListener('click', ()=>applyCategoryFilter('')); box.appendChild(all);
  list.slice(0,12).forEach(item=>{
    const btn=document.createElement('button');
    btn.className='cat-chip'; btn.setAttribute('data-code', item.code || item.name);
    const friendly = item.name || item.code;
    btn.innerHTML = `${escapeHTML(friendly)} <span class="subtle">(${item.count})</span>`;
    btn.title = (item.code && CODE_NAME_MAP[item.code] && CODE_NAME_MAP[item.code]!==item.code) ? `${item.code} • ${CODE_NAME_MAP[item.code]}` : (item.code || friendly);
    btn.addEventListener('click', ()=>applyCategoryFilter(item.code || item.name));
    box.appendChild(btn);
  });
  highlightActiveChip();
}
function applyCategoryFilter(code){
  $('#filterDiag').value = (code||'').toUpperCase();
  CUR_PAGE=1;
  loadPatients(false, { refreshGlobal:false });
  highlightActiveChip();
  const name = code ? (CODE_NAME_MAP[code] || code) : 'Semua kategori';
  $('#activeFilterMsg').textContent = `Penapis: ${name}`;
  Toast.show(code ? `Ditapis ikut kategori: ${name}` : 'Penapis kategori dibuang');
}
function highlightActiveChip(){
  const code = ($('#filterDiag').value||'').trim().toUpperCase();
  document.querySelectorAll('#quickCats .cat-chip').forEach(btn=>{
    const c = (btn.getAttribute('data-code')||'').toUpperCase();
    btn.classList.toggle('active', code && c===code);
    if (!code && btn.textContent.trim()==='Semua') btn.classList.add('active');
  });
}

/************ ATTENDANCE (FAST VIA BACKEND) ************/
async function drawAttendance(daysOrYear){
  const days = daysOrYear===365 ? 365 : daysOrYear;
  try{
    const r = await callAPI('attendance_series',{ days });
    const labels = r.series.map(x=>x.date);
    const data   = r.series.map(x=>x.count);

    $('#attnInfo').textContent = (days===365) ? `12 Bulan Terkini — Jumlah: ${r.total}` : `${days} Hari Terkini — Jumlah: ${r.total}`;

    const ctx=$('#chartAttn');
    if (attnChart) attnChart.destroy();
    attnChart = new Chart(ctx, {
      type: 'line',
      data: { labels, datasets: [{ label:'Kehadiran', data, fill:false, tension:0.25, borderWidth:2, pointRadius:0, borderColor: '#0d6efd' }]},
      options: { animation:CHART_ANIM, plugins:{ legend:{ display:false } },
        scales:{ y:{ beginAtZero:true, grid:{ color:'rgba(0,0,0,.05)'}}, x:{ grid:{ display:false } } },
        maintainAspectRatio:false }
    });
  }catch(e){ console.warn('attendance error:', e.message); }
}

/************ TREND ALERTS & REACTIVATION ************/
async function loadTrends(){
  try{
    const r = await callAPI('trend_alerts',{});
    const arr = r.alerts || [];
    if (!arr.length){ 
      $('#trendBox').innerHTML = '<div class="data-empty"><i class="bi bi-check-circle"></i><p>Tiada alert signifikan buat masa ini.</p></div>'; 
      return; 
    }
    $('#trendBox').innerHTML = arr.map(a=>`
      <div class="d-flex align-items-center gap-2 mb-1 alert alert-${a.growthPct > 0 ? 'danger' : 'success'} py-2">
        <i class="bi bi-arrow-${a.growthPct > 0 ? 'up' : 'down'} text-${a.growthPct > 0 ? 'danger' : 'success'}"></i>
        <span><strong>${a.name}</strong> ${a.growthPct > 0 ? 'meningkat' : 'menurun'} <strong>${Math.abs(a.growthPct)}%</strong> (Kini: ${a.now}, Sebelum: ${a.prev})</span>
      </div>`).join('');
  }catch(e){ $('#trendBox').innerHTML='<div class="alert alert-warning">Gagal memuatkan alert.</div>'; }
}
async function loadReactivation(){
  const tb = $('#tblReAct tbody'); if(!tb) return; tb.innerHTML='';
  try{
    const r = await callAPI('reactivation_list',{ days:30 });
    const rows = r.rows || [];
    if (!rows.length){ 
      tb.innerHTML = `<tr><td colspan="7" class="text-center py-4"><div class="data-empty"><i class="bi bi-people"></i><p>Tiada rekod.</p></div></td></tr>`; 
      return; 
    }
    rows.forEach((x,i)=>{
      const wa = x.phone?`https://wa.me/${String(x.phone).replace(/\D/g,'')}`:'';
      const msg = encodeURIComponent(`Hai ${x.name}, ini klinik anda. Bagaimana keadaan selepas lawatan terakhir (${x.lastVisit})? Jika perlu bantuan/temujanji, balas mesej ini ya.`);
      tb.insertAdjacentHTML('beforeend',`
        <tr>
          <td>${i+1}</td><td>${escapeHTML(x.name||'-')}</td><td>${escapeHTML(x.phone||'-')}</td>
          <td>${escapeHTML(x.lastCategory||'-')}</td><td>${x.lastVisit}</td><td>${x.daysSilent}</td>
          <td>${wa?`<a class="btn btn-sm btn-success" target="_blank" rel="noopener" href="${wa}?text=${msg}"><i class="bi bi-whatsapp"></i></a>`:'-'}</td>
        </tr>`);
    });
  }catch(e){ tb.innerHTML = `<tr><td colspan="7" class="text-danger">Ralat: ${e.message}</td></tr>`; }
}

/************ PATIENTS ************/
async function loadPatients(refreshSummary=true, opts={}){
  if (isLoading) return;
  setLoading(true);
  
  const { refreshGlobal=false } = opts;
  const s=$('#startDate').value, e=$('#endDate').value;
  const diag=($('#filterDiag').value||'').trim();
  const area=($('#filterArea').value||'').trim();
  const pageSize=Number($('#pageSize').value||100);
  updateStatus('Memuat senarai pesakit…', 50);

  try{
    // Force cache refresh if explicitly requested
    if (refreshSummary) {
      const cacheKey = `PATIENTS:${s}|${e}|${diag}|${area}|${CUR_PAGE}|${pageSize}`;
      // Note: We can't directly clear cache from frontend, but we can add a timestamp to force refresh
      await callAPI('clear_cache', { patterns: [`PATIENTS:${s}|${e}`] });
    }
    
    const res=await callAPI('patients',{ startISO:s, endISO:e, page:CUR_PAGE, pageSize, diagnosisCode:diag, areaQuery:area });
    LAST_PATIENT_ROWS = res.rows||[];
    renderPatients(LAST_PATIENT_ROWS);

    const total=res.total||0;
    const from=(total===0)?0:((CUR_PAGE-1)*pageSize+1);
    const to=Math.min(CUR_PAGE*pageSize,total);
    $('#pageInfo').textContent = `Jumlah: ${total.toLocaleString()} | Halaman ${CUR_PAGE} (${from}-${to})`;

    $('#legend1').textContent=fmtPeriod(s,e);
    $('#legend2').textContent=fmtPeriod(s,e);
    $('#legendPeriod').textContent=fmtPeriod(s,e);
    $('#legendCalc').textContent='';

    if (refreshSummary){
      const data = await loadSummary();
      CODE_NAME_MAP = {};
      if (data.rows && data.rows.length){
        data.rows.forEach(r=>{ const code=r[4], name=r[5]; if (code && name) CODE_NAME_MAP[code]=name; });
        $('#kpiLabeled').textContent=(data.labeled||0).toLocaleString();
        $('#kpiCats').textContent=new Set(data.rows.map(r=>r[4])).size||0;
        const top=data.rows.slice().sort((a,b)=>b[6]-a[6])[0];
        $('#kpiTop').textContent=top?top[5]:'-';
        const list = data.rows.map(r=>({ name:r[5], code:r[4], count:r[6], pct:r[7] })).sort((a,b)=>b.count-a.count);
        drawDonut(list); drawBar(list.slice(0,8)); renderQuickCats(list);
      }else{
        const local=buildLocalSummary(LAST_PATIENT_ROWS);
        $('#legendCalc').textContent='Local calc';
        $('#kpiLabeled').textContent=local.labeled.toLocaleString();
        $('#kpiCats').textContent=Object.keys(local.counts).length;
        $('#kpiTop').textContent=local.topName||'-';
        drawDonut(local.list); drawBar(local.list.slice(0,8)); renderQuickCats(local.list);
      }
    }

    const activeBtn = document.querySelector('.btn-range.active');
    const map={attn7:7,attn14:14,attn30:30,attn60:60,attn365:365};
    const days = map[activeBtn?.id || 'attn30'] || 30;
    await drawAttendance(days);

    if (refreshGlobal){ await Promise.all([loadTrends(), loadReactivation()]); }

    if ($('#autoVaxSwitch')?.checked) { scanVaccinations(LAST_PATIENT_ROWS,false); }

    const codeNow = ($('#filterDiag').value||'').trim().toUpperCase();
    $('#activeFilterMsg').textContent = `Penapis: ${codeNow? (CODE_NAME_MAP[codeNow]||codeNow) : 'Semua kategori'}`;

    updateStatus('Data dimuat', 100);
  }catch(err){
    console.error(err);
    updateStatus('Ralat memuat pesakit: '+err.message, 0);
    Toast.show('Ralat memuat pesakit: ' + err.message);
  } finally {
    setLoading(false);
  }
}

function renderPatients(rows){
  const tb=$('#tbl tbody'); tb.innerHTML='';
  if (!rows.length) { 
    tb.innerHTML = `<tr><td colspan="7" class="text-center py-4"><div class="data-empty"><i class="bi bi-search"></i><p>Tiada data ditemui untuk penapis yang dipilih</p></div></td></tr>`; 
    return; 
  }
  rows.forEach((r,i)=>{
    const phoneStr = String(r.phone||'');
    const wa=phoneStr?`https://wa.me/${phoneStr.replace(/\D/g,'')}`:'';
    const codes = String(r.diagnosisCodes||'').toUpperCase().split(/[,\s]+/).filter(Boolean);
    const chips = codes.length
      ? codes.map(c=>{ const tip = CODE_NAME_MAP[c] && CODE_NAME_MAP[c]!==c ? ` title="${c} • ${CODE_NAME_MAP[c]}"` : ` title="${c}"`; return `<span class="badge badge-code me-1"${tip}>${escapeHTML(c)}</span>`; }).join('')
      : '<span class="text-muted">-</span>';
    tb.insertAdjacentHTML('beforeend',`
      <tr>
        <td class="fw-semibold">${i+1 + (CUR_PAGE-1)*Number($('#pageSize').value||100)}</td>
        <td>${escapeHTML(r.name||'-')}</td>
        <td>${r.age||'-'}</td>
        <td>${chips}</td>
        <td>${r.visitDate||'-'}</td>
        <td>${escapeHTML(formatPhone(r.phone))||'-'}</td>
        <td>${wa?`<a class="btn btn-sm btn-success" target="_blank" rel="noopener" href="${wa}"><i class="bi bi-whatsapp"></i></a>`:'-'}</td>
      </tr>`);
  });
}

function formatPhone(phone){ if (!phone) return ''; const cleaned=String(phone).replace(/\D/g,''); if (cleaned.length===10) return cleaned.replace(/(\d{3})(\d{3})(\d{4})/,'$1-$2-$3'); if (cleaned.length===11) return cleaned.replace(/(\d{3})(\d{4})(\d{4})/,'$1-$2-$3'); return String(phone); }
function escapeHTML(s){ return String(s).replace(/[&<>\"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/************ AUTO-DAFTAR VAKSIN ************/
const VAX_PATTERNS = [
  { re:/\b(influenza|flu)\b/i, type:'Influenza', days:365 },
  { re:/\b(covid|covid[-\s]?19)\b/i, type:'Covid', days:365 },
  { re:/\b(tetanus)\b/i, type:'Tetanus', days:365 },
  { re:/\b(hpv)\b/i, type:'HPV', days:365 },
  { re:/\b(hep[\s-]?b|hepatitis\s*b)\b/i, type:'HepB', days:365 },
  { re:/\b(vaksin|vaccine|vacc)\b/i, type:'Vaksin', days:365 },
];
function detectVaxType(text){ if (!text) return null; for (const p of VAX_PATTERNS){ if (p.re.test(text)) return { type:p.type, days:p.days }; } return null; }
async function scanVaccinations(rows, manualTriggered){
  if (!rows || !rows.length) { $('#autoVaxMsg').textContent='Tiada data untuk imbas.'; return; }
  let attempts=0, success=0;
  for (const r of rows){
    const blob = [r.diagnosisCodes||'', r.diagnosisText||''].join(' ');
    const hit = detectVaxType(blob);
    if (!hit) continue;
    const name = String(r.name||'').trim();
    const phone= String(r.phone||'').trim();
    const last = String(r.visitDate||'').slice(0,10);
    if (!name || !phone || !last) continue;
    const key = `${phone}|${hit.type}|${last}`;
    if (AUTO_VAX_SESSION_KEYS.has(key)) continue; AUTO_VAX_SESSION_KEYS.add(key);
    attempts++;
    try{
      await callAPI('repeat_upsert',{ patient_name:name, phone:phone, last_service:last, type:hit.type, due_every_days:hit.days, note:'auto' });
      success++;
    }catch(e){ console.warn('auto vax upsert fail:', e.message); }
  }
  const msg = attempts ? `Auto-vaksin: ${success}/${attempts} didaftar.` : 'Auto-vaksin: Tiada kes vaksin dikesan.';
  $('#autoVaxMsg').textContent = msg;
  if (manualTriggered) Toast.show(msg);
}

/************ SYNC / PADAM / SUSUN ************/
async function startSync(){
  if (isSyncing) {
    Toast.show('Sync sedang berjalan. Sila tunggu.');
    return;
  }
  
  isSyncing = true;
  const s=$('#startDate').value, e=$('#endDate').value; const gran=pickGran();
  
  // Show sync status bar
  showSyncStatus('Memulakan sync data...');
  updateStatus('Memulakan sync…', 10);
  
  try{
    console.log('Starting sync with params:', { startISO: s, endISO: e, granularity: gran, dedup: true });
    
    const { job, synced, total } = await callAPI('sync_start',{ startISO:s, endISO:e, granularity:gran, dedup:true });
    
    console.log('Sync started:', { job, synced, total });
    
    // Show immediate feedback
    showSyncStatus(`Sync dimulakan: ${synced}/${total} rekod baharu`);
    updateStatus(`Sync dimulakan: ${synced}/${total} rekod baharu`, 30);
    
    await pollProgress(job);
    
    // Force refresh all data after sync
    CUR_PAGE=1; 
    await loadPatients(true, { refreshGlobal:true });
    
    // Show success message
    showSyncStatus(`Sync selesai: ${synced}/${total} rekod baharu`, false);
    Toast.show(`Sync selesai: ${synced}/${total} rekod baharu`);
  }catch(err){ 
    console.error('Sync error:', err);
    showSyncStatus(`Ralat sync: ${err.message}`, false);
    updateStatus('Ralat sync: '+err.message, 0); 
    Toast.show('Ralat sync: ' + err.message);
  } finally {
    isSyncing = false;
  }
}
async function pollProgress(job){
  return new Promise((resolve,reject)=>{
    const timer=setInterval(async ()=>{
      try{
        const p=await callAPI('sync_progress',{ job });
        let progress = 10;
        if (p.total && p.doneCount) progress = 10 + Math.floor((p.doneCount / p.total) * 80);
        updateStatus(`Menyelaraskan data… ${p.doneCount||0}/${p.total||0}`, progress);
        showSyncStatus(`Menyelaraskan data… ${p.doneCount||0}/${p.total||0}`);
        if (p.done){ 
          clearInterval(timer); 
          updateStatus('Sync selesai, memuat semula data...', 90);
          showSyncStatus('Sync selesai, memuat semula data...');
          setTimeout(resolve, 300); 
        }
      }catch(e){ 
        clearInterval(timer); 
        showSyncStatus(`Ralat sync: ${e.message}`, false);
        updateStatus('Ralat sync: ' + e.message, 0); 
        reject(e); 
      }
    }, 1500);
  });
}
async function deleteRange(){
  if (!confirm('Padam data dalam julat tarikh ini?')) return;
  const s=$('#startDate').value, e=$('#endDate').value, gran=pickGran();
  try{
    updateStatus('Memadam data…', 50);
    await callAPI('delete_range',{ start:s, end:e, granularity:gran });
    updateStatus('Data dipadam', 100);
    CUR_PAGE=1; await loadPatients(true, { refreshGlobal:true });
  }catch(err){ updateStatus('Padam gagal: ' + err.message, 0); }
}
async function sortRange(){
  const s=$('#startDate').value, e=$('#endDate').value, gran=pickGran();
  try{
    updateStatus('Menyusun data…', 50);
    await callAPI('sort_range',{ start:s, end:e, granularity:gran, by:'date', order:'asc' });
    updateStatus('Data disusun', 100);
    CUR_PAGE=1; await loadPatients(false);
  }catch(err){ updateStatus('Susun gagal: ' + err.message, 0); }
}
function updateStatus(message, progress){ 
  $('#statusLine').textContent = message; 
  $('#progressFill').style.width = `${progress}%`;
  if (progress === 100) {
    setTimeout(() => {
      $('#progressFill').style.width = '0%';
      $('#statusLine').textContent = 'Sedia';
    }, 2000);
  }
}

/************ PRICING ************/
async function loadPricing(){
  try{
    const r = await callAPI('pricing_get',{});
    const items = r.items || [];
    const ul = document.querySelector('#priceList'); if(!ul) return; ul.innerHTML='';
    if (!items.length){ ul.innerHTML = `<li class="list-group-item small text-muted">Tiada data harga.</li>`; return; }
    items.forEach(it=>{
      ul.insertAdjacentHTML('beforeend', `<li class="list-group-item d-flex justify-content-between align-items-center">
        <span><strong>${escapeHTML(it.code)}</strong> — ${escapeHTML(it.name||it.code)}</span>
        <span class="badge text-bg-primary">RM ${Number(it.price||0).toFixed(2)}</span>
      </li>`);
    });
  }catch(e){ console.warn('pricing_get:', e.message); }
}
async function savePrice(){
  const code = document.querySelector('#priceCode').value.trim().toUpperCase();
  const name = document.querySelector('#priceName').value.trim();
  const price= Number(document.querySelector('#priceValue').value||0);
  if (!code){ alert('Masukkan kod.'); return; }
  try{
    await callAPI('pricing_set',{ code, name, price });
    document.querySelector('#priceCode').value=''; document.querySelector('#priceName').value=''; document.querySelector('#priceValue').value='';
    await loadPricing();
  }catch(e){ alert('Gagal simpan harga: '+e.message); }
}

/************ REPEAT REGISTRY ************/
async function saveRepeat(){
  const payload = {
    patient_name: document.querySelector('#repName').value.trim(),
    phone: document.querySelector('#repPhone').value.trim(),
    last_service: document.querySelector('#repLast').value,
    type: document.querySelector('#repType').value.trim(),
    due_every_days: Number(document.querySelector('#repEvery').value||365),
    next_due_date: document.querySelector('#repNext').value,
    note: document.querySelector('#repNote').value.trim()
  };
  if (!payload.patient_name || !payload.phone || !payload.last_service){ alert('Nama, Telefon & Tarikh terakhir diperlukan.'); return; }
  try{
    await callAPI('repeat_upsert', payload);
    document.querySelector('#repName').value=''; document.querySelector('#repPhone').value=''; document.querySelector('#repLast').value=''; document.querySelector('#repType').value='';
    document.querySelector('#repEvery').value='365'; document.querySelector('#repNext').value=''; document.querySelector('#repNote').value='';
    await loadRepeatDue();
  }catch(e){ alert('Gagal simpan: '+e.message); }
}
async function loadRepeatDue(){
  const tb = document.querySelector('#tblRepDue tbody'); if(!tb) return; tb.innerHTML='';
  try{
    const r = await callAPI('repeat_due_list',{ daysAhead:14 });
    const rows = r.rows || [];
    if (!rows.length){ 
      tb.innerHTML = `<tr><td colspan="6" class="text-center py-4"><div class="data-empty"><i class="bi bi-calendar-check"></i><p>Tiada yang due 14 hari terdekat.</p></div></td></tr>`; 
      return; 
    }
    rows.forEach((x,i)=>{
      const wa=x.phone?`https://wa.me/${String(x.phone).replace(/\D/g,'')}`:'';
      const msg = encodeURIComponent(`Hai ${x.name}, temujanji ${x.type||'servis'} anda bakal due pada ${x.next_due_date}. Mahu tempah slot?`);
      tb.insertAdjacentHTML('beforeend',`
        <tr>
          <td>${i+1}</td><td>${escapeHTML(x.name||'-')}</td><td>${escapeHTML(x.phone||'-')}</td>
          <td>${escapeHTML(x.type||'-')}</td><td>${x.next_due_date}</td>
          <td>${wa?`<a class="btn btn-sm btn-success" target="_blank" rel="noopener" href="${wa}?text=${msg}"><i class="bi bi-whatsapp"></i></a>`:'-'}</td>
        </tr>`);
    });
  }catch(e){ tb.innerHTML = `<tr><td colspan="6" class="text-danger">Ralat: ${e.message}</td></tr>`; }
}

/************ CSV EXPORT ************/
function exportCSV(){
  const rows=[...document.querySelectorAll('#tbl tbody tr')].map(tr=>{
    const t=tr.querySelectorAll('td');
    return { name:t[1]?.textContent||'', age:t[2]?.textContent||'', codes:t[3]?.innerText||'', date:t[4]?.textContent||'', phone:t[5]?.textContent||'' };
  });
  if (!rows.length){ alert('Tiada data untuk dieksport'); return; }
  const header=['Nama','Umur','Kod Diagnosis','Tarikh','Telefon'];
  const csv=[header].concat(rows.map(r=>[r.name,r.age,r.codes,r.date,r.phone]))
    .map(a=>a.map(f=>`"${String(f).replace(/"/g,'""')}"`).join(',')).join('\n');
  const url=URL.createObjectURL(new Blob(["\uFEFF"+csv],{type:'text/csv;charset=utf-8;'}));
  const a=document.createElement('a'); a.href=url; a.download=`pesakit_${$('#startDate').value}_hingga_${$('#endDate').value}.csv`; a.click(); URL.revokeObjectURL(url);
}
</script>

<!-- Bootstrap JS (defer) -->
<script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
