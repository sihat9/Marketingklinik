<!DOCTYPE html>
<html lang="ms">
<head>
  <!-- Hardening: strict CSP to avoid data leakage; keep domains minimal -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'none'; script-src 'self' https://accounts.google.com https://accounts.gstatic.com https://cdn.jsdelivr.net; connect-src https://script.google.com https://script.googleusercontent.com; style-src 'self' https://cdn.jsdelivr.net; img-src 'self' data:; font-src 'self' https://cdn.jsdelivr.net; frame-src https://accounts.google.com; base-uri 'none'; form-action 'none'; frame-ancestors 'none';" />
  <meta name="referrer" content="no-referrer" />
  <meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=(), autoplay=(), fullscreen=()" />
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Clinic Marketing Dashboard</title>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    :root{ --bg:#0f172a; --card:#111827; --text:#e2e8f0; --muted:#9ca3af; --accent:#93c5fd; }
    body { background:var(--bg); color:var(--text); }
    .card { background:var(--card); border:1px solid rgba(255,255,255,.06); border-radius:16px; }
    a, a:hover { color: var(--accent); }
    .brand { font-weight:800; letter-spacing:.4px; }
    .muted { color: var(--muted); }
    .chip { padding:.35rem .65rem; border-radius:999px; background:rgba(255,255,255,.06); font-size:.85rem; }
    .hidden { display:none !important; }
  </style>
</head>
<body>
  <div class="container py-4">
    <!-- Header -->
    <div class="d-flex flex-wrap align-items-center justify-content-between mb-4">
      <div>
        <div class="brand h3 mb-0">Clinic Marketing Dashboard</div>
        <div class="muted">Pola penyakit & peratusan — tanpa PII</div>
      </div>
      <div class="d-flex gap-2 align-items-center">
        <span id="whoami" class="muted small"></span>
        <button class="btn btn-outline-light btn-sm hidden" id="btnSignOut"><i class="bi bi-box-arrow-right"></i> Sign out</button>
      </div>
    </div>

    <!-- Sign-in Gate -->
    <div id="signinCard" class="card p-4 text-center">
      <h4 class="mb-2">Akses Terhad</h4>
      <p class="muted">Sila log masuk dengan akaun Google staf klinik untuk melihat dashboard.</p>
      <div id="gsiBtn" class="d-inline-block"></div>
      <div id="signinMsg" class="small text-danger mt-3"></div>
      <div class="small muted mt-2">*Hanya email staf yang dibenarkan akan diterima.</div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="hidden">
      <div class="row g-3 mb-3">
        <div class="col-12 col-lg-4">
          <div class="card p-3 h-100">
            <h5 class="mb-3">Julat Tarikh</h5>
            <div class="row g-2">
              <div class="col-6">
                <label class="form-label">Mula</label>
                <input type="date" class="form-control" id="startDate" />
              </div>
              <div class="col-6">
                <label class="form-label">Tamat</label>
                <input type="date" class="form-control" id="endDate" />
              </div>
            </div>
            <div class="d-flex gap-2 mt-3">
              <button class="btn btn-success btn-sm" id="btnApplyRange"><i class="bi bi-clipboard2-data"></i> Kira & Kemas Kini</button>
              <button class="btn btn-outline-secondary btn-sm" id="btnExport"><i class="bi bi-download"></i> Export CSV</button>
            </div>
            <div class="mt-3 small muted" id="rangeInfo"></div>
          </div>
        </div>
        <div class="col-12 col-lg-8">
          <div class="card p-3 h-100">
            <h5 class="mb-3">Sorotan Bulan Ini</h5>
            <div class="row g-3">
              <div class="col-6 col-md-4"><div class="chip w-100 text-center" id="kpiLabeled">Labeled: -</div></div>
              <div class="col-6 col-md-4"><div class="chip w-100 text-center" id="kpiCategories">Kategori: -</div></div>
              <div class="col-12 col-md-4"><div class="chip w-100 text-center" id="kpiTop">Top: -</div></div>
            </div>
            <div class="mt-3 small muted">*"Labeled" = jumlah lawatan yang dipadankan ≥ 1 kategori.</div>
            <div class="d-flex gap-2 mt-3">
              <button class="btn btn-outline-light btn-sm" id="btnRefresh"><i class="bi bi-arrow-repeat"></i> Bulan Ini</button>
            </div>
          </div>
        </div>
      </div>

      <div class="row g-3 mb-3">
        <div class="col-12 col-xl-6">
          <div class="card p-3">
            <h5 class="mb-3">Peratus Mengikut Kategori (Donut)</h5>
            <canvas id="chartDonut" height="260"></canvas>
          </div>
        </div>
        <div class="col-12 col-xl-6">
          <div class="card p-3">
            <h5 class="mb-3">Top Kategori (Bar)</h5>
            <canvas id="chartBar" height="260"></canvas>
          </div>
        </div>
      </div>

      <div class="card p-3 mb-5">
        <h5 class="mb-3">Jadual Perincian</h5>
        <div class="table-responsive">
          <table class="table table-dark table-striped table-hover align-middle" id="tbl">
            <thead>
              <tr>
                <th>#</th>
                <th>Kategori</th>
                <th>Kod</th>
                <th>Kiraan</th>
                <th>Peratus</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <footer class="text-center muted small">© Klinik — Dashboard agregat. Tiada data PII dipaparkan.</footer>
    </div>
  </div>

<script>
  /*** KONFIG (ISI) ***/
  const CLIENT_ID = '366415747851-umhhc3r11chpg4stiqailac1rq7klrrp.apps.googleusercontent.com'; // <- Gantika
  const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbxkmVWcorPPwWmIXN-lFPJ8wucqyKgqwrfiD4ZBqRYl1gKOcRoM7oXNzSO_XPLYZ8CL/exec'; // <- Gantikan (akhir /exec)
  // Hint emel dimatikan untuk elak pendedahan di front-end public
  // const ALLOWED_EMAIL_HINT = '';
// opsyen: papar hint pada UI

  /*** STATE ***/
  let ID_TOKEN = null; // Google ID token (bukan disimpan tetap)
  let donutChart, barChart;

  /*** UI HELPERS ***/
  function show(el){ el.classList.remove('hidden'); }
  function hide(el){ el.classList.add('hidden'); }
  function $(sel){ return document.querySelector(sel); }

  /*** GOOGLE IDENTITY (SSO) ***/
  window.onload = () => {
    // Render Google Sign-In button
    if (!window.google || !google.accounts || !google.accounts.id) {
      $('#signinMsg').textContent = 'Ralat memuatkan Google SSO. Semak sambungan internet.';
      return;
    }
    google.accounts.id.initialize({
      client_id: CLIENT_ID,
      callback: onSignIn,
      auto_select: false,
      ux_mode: 'popup',
      context: 'signin'
    });
    google.accounts.id.renderButton(document.getElementById('gsiBtn'), { theme: 'outline', size: 'large', shape:'pill' });
    $('#btnSignOut').addEventListener('click', signOut);

    // Init date inputs to current month
    const d = new Date(); const s = new Date(d.getFullYear(), d.getMonth(), 1); const e = new Date(d.getFullYear(), d.getMonth()+1, 0);
    $('#startDate').value = s.toISOString().slice(0,10);
    $('#endDate').value = e.toISOString().slice(0,10);

    // Wire events
    $('#btnApplyRange').addEventListener('click', applyRange);
    $('#btnRefresh').addEventListener('click', refreshThisMonth);
    $('#btnExport').addEventListener('click', exportFromTable);
  };

  function onSignIn(resp){
    try {
      ID_TOKEN = resp.credential; // JWT
      $('#signinMsg').textContent = '';
      $('#whoami').textContent = 'Signed in';
      hide($('#signinCard'));
      show($('#dashboard'));
      refreshThisMonth();
      $('#btnSignOut').classList.remove('hidden');
    } catch(err){
      $('#signinMsg').textContent = 'Log masuk gagal. Cuba lagi.';
      console.error(err);
    }
  }
  function signOut(){ ID_TOKEN = null; location.reload(); }

  /*** BACKEND CALLER (CORS + POST JSON) ***/
  async function callAPI(action, payload){
    if (!ID_TOKEN) throw new Error('Belum log masuk');
    const res = await fetch(BACKEND_URL, {
      method: 'POST',
      mode: 'cors',
      credentials: 'omit',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ action, id_token: ID_TOKEN, payload })
    });
    if (!res.ok){
      const t = await res.text();
      throw new Error('API error: ' + t);
    }
    return res.json();
  }

  /*** DASHBOARD LOGIC ***/
  function setKPIs(summary){
    const totalLabeled = summary.labeled || 0;
    const cats = new Set((summary.rows||[]).map(r=>r[4])).size;
    const top = (summary.rows||[]).slice().sort((a,b)=>b[6]-a[6])[0];
    $('#kpiLabeled').textContent = 'Labeled: ' + totalLabeled;
    $('#kpiCategories').textContent = 'Kategori: ' + cats;
    $('#kpiTop').textContent = top ? ('Top: ' + top[5]) : 'Top: -';
  }
  function renderTable(list){
    const tbody = $('#tbl tbody'); tbody.innerHTML = '';
    list.forEach((d,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${i+1}</td><td>${d.name}</td><td>${d.code}</td><td>${d.count}</td><td>${d.pct}%</td>`;
      tbody.appendChild(tr);
    });
  }
  function toUIRows(rows){ return (rows||[]).map(r=>({ code:r[4], name:r[5], count:r[6], pct:r[7] })); }

  function drawDonut(list){
    const ctx = document.getElementById('chartDonut');
    const labels = list.map(d=>d.name), values = list.map(d=>d.pct);
    if (donutChart) donutChart.destroy();
    donutChart = new Chart(ctx, { type:'doughnut', data:{ labels, datasets:[{ data: values }] }, options:{ plugins:{ legend:{ labels:{ color:'#e2e8f0' } } }, cutout:'60%' } });
  }
  function drawBar(list){
    const ctx = document.getElementById('chartBar');
    const labels = list.map(d=>d.name), values = list.map(d=>d.count);
    if (barChart) barChart.destroy();
    barChart = new Chart(ctx, { type:'bar', data:{ labels, datasets:[{ data: values }] }, options:{ plugins:{ legend:{ display:false } }, scales:{ x:{ ticks:{ color:'#e2e8f0' } }, y:{ ticks:{ color:'#e2e8f0' } } } } });
  }

  async function refreshThisMonth(){
    const d = new Date();
    const y = d.getFullYear(); const m = d.getMonth()+1;
    $('#rangeInfo').textContent = 'Mengira bulan ini…';
    try{
      // compute & fetch in one call (backend returns summary)
      const res = await callAPI('compute_month', { year: y, month: m });
      setKPIs(res);
      const list = toUIRows(res.rows).sort((a,b)=>b.count-a.count);
      drawDonut(list);
      drawBar(list.slice(0,8));
      renderTable(list);
      $('#rangeInfo').textContent = `Julat: ${res.start} → ${res.end}`;
    } catch(err){ $('#rangeInfo').textContent = 'Ralat: ' + err.message; console.error(err); }
  }

  async function applyRange(){
    const s = $('#startDate').value, e = $('#endDate').value;
    if (!s || !e){ alert('Sila pilih tarikh mula & tamat.'); return; }
    $('#rangeInfo').textContent = 'Mengira julat tarikh…';
    try{
      const res = await callAPI('compute_range', { start: s, end: e });
      setKPIs(res);
      const list = toUIRows(res.rows).sort((a,b)=>b.count-a.count);
      drawDonut(list);
      drawBar(list.slice(0,8));
      renderTable(list);
      $('#rangeInfo').textContent = `Julat: ${res.start} → ${res.end}`;
    } catch(err){ $('#rangeInfo').textContent = 'Ralat: ' + err.message; console.error(err); }
  }

  function exportFromTable(){
    const rows = Array.from(document.querySelectorAll('#tbl tbody tr')).map(tr=>{
      const t = tr.querySelectorAll('td');
      return { name:t[1].textContent, code:t[2].textContent, count:+t[3].textContent, pct:parseFloat(t[4].textContent) };
    });
    const header = ['category','code','count','percentage'];
    const csv = [header].concat(rows.map(d=>[d.name,d.code,d.count,d.pct])).map(r=>r.join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='marketing_summary.csv'; a.click(); URL.revokeObjectURL(url);
  }
</script>
</body>
</html>
